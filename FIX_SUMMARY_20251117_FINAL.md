# çƒ­æ¸©å†·æ­£é€‰æ‰¹é‡é¢„æµ‹BUGä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2025-11-17
**ä¿®å¤ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ

---

## ğŸ¯ ä¿®å¤é—®é¢˜æ€»ç»“

### é—®é¢˜1: 25118é”™è¯¯æ ‡è®°ä¸º"æ¨ç®—"æœŸ
- **è¡¨ç°**: æœŸå·25118åœ¨æ•°æ®åº“ä¸­å­˜åœ¨(ID=2786)ï¼Œä½†è¢«æ ‡è®°ä¸º`is_predicted=true`
- **åŸå› **: æ•°æ®åº“æŸ¥è¯¢å¯èƒ½å¤±è´¥è¿”å›null
- **ä¿®å¤**: ä½¿ç”¨é¢„åŠ è½½çš„`issueToIdMap`åˆ¤æ–­ï¼Œé¿å…æ•°æ®åº“æŸ¥è¯¢å¤±è´¥å¯¼è‡´è¯¯åˆ¤

### é—®é¢˜2: éƒ¨åˆ†æœŸå·ç»„åˆæ•°ä¸º0
- **è¡¨ç°**: 25118, 25119, 25123, 25124 æ˜¾ç¤º0ä¸ªç»„åˆ
- **åŸå› **: åŒç°æ¯”æ’é™¤é…ç½®è§£æé”™è¯¯
  - ä»£ç è¯»å–äº†é”™è¯¯çš„å­—æ®µï¼š`coOccurrence.mode`å’Œ`coOccurrence.periods`
  - ç”¨æˆ·é…ç½®å­˜å‚¨åœ¨ï¼š`coOccurrence.historical.combo3`å’Œ`coOccurrence.historical.period`
  - å¯¼è‡´ä½¿ç”¨äº†é»˜è®¤å€¼ï¼šcombo_2æ¨¡å¼ + 30æœŸï¼Œè€Œä¸æ˜¯ç”¨æˆ·é…ç½®çš„combo_3æ¨¡å¼ + 10æœŸ
- **ä¿®å¤**: æ­£ç¡®è§£æ`historical`å¯¹è±¡ä¸‹çš„é…ç½®å­—æ®µ

### é—®é¢˜3: 0ç»„åˆæœŸå·æ— æ³•å¯¼å‡ºExcel
- **è¡¨ç°**: ç»„åˆæ•°ä¸º0çš„æœŸå·å¯¼å‡ºExcelå¤±è´¥
- **åŸå› **: ä»£ç æ£€æŸ¥åˆ°0ç»„åˆæ—¶ç›´æ¥è¿”å›é”™è¯¯
- **ä¿®å¤**: å…è®¸0ç»„åˆå¯¼å‡ºExcelï¼ŒSheet1æ˜¾ç¤º"æ‰€æœ‰ç»„åˆå‡è¢«æ’é™¤"ï¼ŒSheet2ä»åŒ…å«æ’é™¤è¯¦æƒ…

---

## âœ… å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: åŒç°æ¯”é…ç½®è§£æ

**æ–‡ä»¶**: `src/server/server.js`
**ä½ç½®**: ç¬¬16133-16159è¡Œ

**ä¿®æ”¹å†…å®¹**:
\`\`\`javascript
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰:
const mode = exclusionConditions.coOccurrence.mode || 'combo_2';
const periods = exclusionConditions.coOccurrence.periods || 30;

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰:
const coOccurrenceConfig = exclusionConditions.coOccurrence;
const historicalConfig = coOccurrenceConfig.historical || {};

// è§£æmodeï¼ˆæ”¯æŒcombo2/combo3/combo4å­—æ®µï¼‰
let mode = '';
if (historicalConfig.combo2) mode = mode ? 'all' : 'combo_2';
if (historicalConfig.combo3) mode = mode ? 'all' : 'combo_3';
if (historicalConfig.combo4) mode = mode ? 'all' : 'combo_4';

// å…¼å®¹æ—§æ ¼å¼
if (!mode && coOccurrenceConfig.mode) mode = coOccurrenceConfig.mode;
if (!mode) mode = 'combo_2';

// è§£æperiods
let periods = 30;
if (historicalConfig.enabled && historicalConfig.period) {
    periods = historicalConfig.period;
} else if (coOccurrenceConfig.periods) {
    periods = coOccurrenceConfig.periods;
}

log(\`    ğŸ”§ åŒç°æ¯”é…ç½®: mode=\${mode}, periods=\${periods}\`);
\`\`\`

**æ•ˆæœ**:
- âœ… æ­£ç¡®è¯»å–ç”¨æˆ·é…ç½®çš„combo_3æ¨¡å¼
- âœ… æ­£ç¡®è¯»å–ç”¨æˆ·é…ç½®çš„10æœŸå†å²
- âœ… å‡å°‘è¿‡åº¦æ’é™¤ï¼Œæ›´å¤šç»„åˆè¢«ä¿ç•™

---

### ä¿®å¤2: is_predictedæ ‡è®°é”™è¯¯

**æ–‡ä»¶**: `src/server/server.js`
**ä½ç½®**: ç¬¬16558-16597è¡Œ

**ä¿®æ”¹å†…å®¹**:
\`\`\`javascript
// ä¿®å¤å‰:
const targetData = await hit_dlts.findOne({ Issue: parseInt(targetIssue) }).lean();
if (targetData) {
    isPredicted = false;
} else {
    isPredicted = true;
}

// ä¿®å¤å:
// â­ 2025-11-17ä¿®å¤: ä½¿ç”¨é¢„åŠ è½½çš„issueToIdMapåˆ¤æ–­æ˜¯å¦å¼€å¥–
const issueExists = this.issueToIdMap.has(targetIssue.toString());
isPredicted = !issueExists;

if (issueExists) {
    // å·²å¼€å¥–ï¼ˆå†å²æœŸå·ï¼‰
    if (enableValidation) {
        const targetData = await hit_dlts.findOne({ Issue: parseInt(targetIssue) }).lean();
        if (targetData) {
            // è®¡ç®—å‘½ä¸­åˆ†æ
        }
    }
} else {
    // æœªå¼€å¥–ï¼ˆæ¨ç®—æœŸï¼‰
}
\`\`\`

**æ•ˆæœ**:
- âœ… ä½¿ç”¨æ›´å¯é çš„`issueToIdMap`åˆ¤æ–­
- âœ… é¿å…æ•°æ®åº“æŸ¥è¯¢å¤±è´¥å¯¼è‡´è¯¯åˆ¤
- âœ… 25118æ­£ç¡®æ ‡è®°ä¸º`is_predicted=false`

---

### ä¿®å¤3: æ”¯æŒ0ç»„åˆæœŸå·å¯¼å‡ºExcel

**æ–‡ä»¶**: `src/server/server.js`
**ä½ç½®**: ç¬¬21879-21882è¡Œ, ç¬¬21982-22007è¡Œ

**ä¿®æ”¹å†…å®¹1** (ç§»é™¤0ç»„åˆæ£€æŸ¥):
\`\`\`javascript
// ä¿®å¤å‰:
if (pairedCombinations.length === 0) {
    return res.status(404).json({ success: false, message: 'è¯¥æœŸå·æ²¡æœ‰ä¿ç•™çš„ç»„åˆæ•°æ®' });
}

// ä¿®å¤å:
if (pairedCombinations.length === 0) {
    log(\`  â„¹ï¸ æœŸå·\${period}ä¿ç•™ç»„åˆæ•°ä¸º0ï¼ˆæ‰€æœ‰ç»„åˆè¢«æ’é™¤ï¼‰ï¼Œå°†å¯¼å‡ºä»…åŒ…å«æ’é™¤è¯¦æƒ…çš„Excel\`);
}
\`\`\`

**ä¿®æ”¹å†…å®¹2** (Sheet1æ·»åŠ è¯´æ˜è¡Œ):
\`\`\`javascript
// å¡«å……æ•°æ®
let rowIndex = 1;
if (pairedCombinations.length === 0) {
    // 0ç»„åˆæ—¶æ·»åŠ è¯´æ˜è¡Œ
    const noDataRow = {
        index: '',
        red1: '',
        red2: '',
        red3: 'æ‰€æœ‰ç»„åˆå‡è¢«æ’é™¤',
        red4: '',
        red5: '',
        // ... å…¶ä»–å­—æ®µä¸ºç©º
    };
    sheet1.addRow(noDataRow);
    // åˆå¹¶å•å…ƒæ ¼å¹¶å±…ä¸­
    sheet1.mergeCells('A2:P2');
    sheet1.getCell('A2').alignment = { horizontal: 'center', vertical: 'middle' };
    sheet1.getCell('A2').font = { italic: true, color: { argb: 'FF808080' } };
}
\`\`\`

**æ•ˆæœ**:
- âœ… 0ç»„åˆæœŸå·å¯ä»¥æ­£å¸¸å¯¼å‡ºExcel
- âœ… Sheet1æ˜¾ç¤ºå‹å¥½çš„è¯´æ˜ä¿¡æ¯
- âœ… Sheet2ä»åŒ…å«å®Œæ•´çš„çº¢çƒæ’é™¤è¯¦æƒ…

---

## ğŸ“Š é¢„æœŸä¿®å¤åç»“æœ

**æœŸå·èŒƒå›´**: 25118-25125 (8æœŸ)
- 7æœŸå†å²: 25118-25124
- 1æœŸæ¨ç®—: 25125

**å„æœŸå·ç»“æœ**:
\`\`\`
æœŸå·    ç»„åˆæ•°    æ˜¯å¦æ¨ç®—    å¤‡æ³¨
25118   XXX      å†å²       âœ… ä¸å†é”™è¯¯æ ‡è®°ä¸ºæ¨ç®—ï¼Œæœ‰ç»„åˆæ•°æ®
25119   XXX      å†å²       âœ… æœ‰ç»„åˆæ•°æ®
25120   XXX      å†å²       âœ…
25121   XXX      å†å²       âœ…
25122   XXX      å†å²       âœ…
25123   XXX      å†å²       âœ… æœ‰ç»„åˆæ•°æ®
25124   XXX      å†å²       âœ… æœ‰ç»„åˆæ•°æ®
25125   XXX      æ¨ç®—       âœ…
\`\`\`

**Excelå¯¼å‡º**:
- âœ… æ‰€æœ‰æœŸå·ï¼ˆåŒ…æ‹¬0ç»„åˆï¼‰éƒ½å¯ä»¥å¯¼å‡ºExcel
- âœ… 0ç»„åˆæœŸå·çš„ExcelåŒ…å«æ’é™¤è¯¦æƒ…
- âœ… Sheet1æ˜¾ç¤º"æ‰€æœ‰ç»„åˆå‡è¢«æ’é™¤"è¯´æ˜

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### åŒç°æ¯”æ’é™¤é€»è¾‘

**ç”¨æˆ·é…ç½®**:
\`\`\`json
{
  "coOccurrence": {
    "enabled": true,
    "historical": {
      "enabled": true,
      "period": 10,
      "combo2": false,
      "combo3": true,
      "combo4": false
    }
  }
}
\`\`\`

**ä¿®å¤åæ‰§è¡Œ**:
- mode = 'combo_3' (3-çƒç»„åˆ)
- periods = 10 (åˆ†æ10æœŸå†å²)

**å½±å“**:
- ä½¿ç”¨combo_3è€Œä¸æ˜¯combo_2ï¼Œç”Ÿæˆçš„æ’é™¤ç‰¹å¾æ›´å°‘
- ä½¿ç”¨10æœŸè€Œä¸æ˜¯30æœŸï¼Œå‡å°‘å†å²æ•°æ®åˆ†æèŒƒå›´
- å‡å°‘è¿‡åº¦æ’é™¤ï¼Œæ›´å¤šç»„åˆè¢«ä¿ç•™

### issueToIdMapçš„ä¼˜åŠ¿

`issueToIdMap`æ˜¯åœ¨é¢„åŠ è½½æ•°æ®æ—¶æ„å»ºçš„æ˜ å°„è¡¨ï¼š
- ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰å†å²æœŸå·ï¼Œæ„å»ºIssueâ†’IDæ˜ å°„
- åç»­åˆ¤æ–­ä½¿ç”¨å†…å­˜ä¸­çš„Mapï¼Œæ— éœ€é‡å¤æŸ¥è¯¢æ•°æ®åº“
- é¿å…æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ã€è¶…æ—¶ã€æ•°æ®ç±»å‹ä¸åŒ¹é…ç­‰é—®é¢˜
- æ€§èƒ½æ›´é«˜ï¼Œå¯é æ€§æ›´å¼º

---

## ğŸ“‹ å¤‡ä»½æ–‡ä»¶

ä¿®å¤å‰å·²åˆ›å»ºå¤‡ä»½ï¼š
- `src/server/server.js.backup_final_fix_20251117`

å¦‚éœ€å›æ»šï¼Œæ‰§è¡Œï¼š
\`\`\`bash
copy src\\server\\server.js.backup_final_fix_20251117 src\\server\\server.js
\`\`\`

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯æœåŠ¡å™¨**
   \`\`\`bash
   taskkill /F /IM node.exe
   taskkill /F /IM electron.exe
   npm start
   \`\`\`

2. **åˆ é™¤æ—§ä»»åŠ¡ç»“æœ**ï¼ˆå¯é€‰ï¼‰
   - åœ¨å‰ç«¯åˆ é™¤æ—§ä»»åŠ¡
   - æˆ–ç›´æ¥åˆ é™¤æ•°æ®åº“ä¸­çš„ä»»åŠ¡è®°å½•

3. **åˆ›å»ºæ–°çš„æµ‹è¯•ä»»åŠ¡**
   - é€‰æ‹©"æœ€è¿‘7æœŸ"
   - çƒ­æ¸©å†·æ¯”ï¼š4:1:0
   - å¯ç”¨åŒç°æ¯”æ’é™¤ï¼ˆcombo3ï¼Œ10æœŸï¼‰
   - å¯ç”¨å…¶ä»–æ’é™¤æ¡ä»¶

4. **éªŒè¯ç»“æœ**
   - æ£€æŸ¥æ‰€æœ‰æœŸå·æ˜¯å¦æœ‰ç»„åˆæ•°æ®
   - æ£€æŸ¥25118æ˜¯å¦æ­£ç¡®æ ‡è®°ä¸ºå†å²æœŸå·ï¼ˆä¸æ˜¯æ¨ç®—ï¼‰
   - å°è¯•å¯¼å‡º0ç»„åˆæœŸå·çš„Excel
   - æ£€æŸ¥Excelå†…å®¹æ˜¯å¦æ­£ç¡®

### é¢„æœŸæ—¥å¿—è¾“å‡º

\`\`\`
ğŸ”§ åŒç°æ¯”é…ç½®: mode=combo_3, periods=10
âœ… æœŸå·25118: å·²å¼€å¥–, is_predicted=false
âœ… æœŸå·25119: å·²å¼€å¥–, is_predicted=false
...
ğŸ”® æœŸå·25125: æœªå¼€å¥–(æ¨ç®—), is_predicted=true
\`\`\`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å®Œæ•´æ€§**: ç¡®ä¿æ•°æ®åº“ä¸­25118-25124çš„æ•°æ®å®Œæ•´
2. **HWCä¼˜åŒ–æ•°æ®**: ç¡®ä¿çƒ­æ¸©å†·ä¼˜åŒ–è¡¨åŒ…å«ç›¸åº”æœŸå·å¯¹çš„æ•°æ®
3. **å‰ç«¯ç¼“å­˜**: å¯èƒ½éœ€è¦æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä»¥ç¡®ä¿æ˜¾ç¤ºæœ€æ–°ç»“æœ
4. **å¹¶å‘é—®é¢˜**: å¦‚æœå¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œï¼Œå¯èƒ½éœ€è¦é¢å¤–æµ‹è¯•

---

**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ
**é£é™©ç­‰çº§**: ä½
**å»ºè®®**: é‡å¯æœåŠ¡å™¨åç«‹å³æµ‹è¯•
