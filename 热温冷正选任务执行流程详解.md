# 热温冷正选批量预测任务 - 完整执行流程详解

## 一、配置结构确认

### 1.1 正选条件（positive_selection）
**位置**：Schema定义 1063-1079行

```javascript
positive_selection: {
    hwc_ratios: [...],          // ✅ 热温冷比（Step 1）
    zone_ratios: [...],         // ✅ 区间比（Step 2）
    sum_ranges: [...],          // ✅ 和值范围（Step 3）
    span_ranges: [...],         // ✅ 跨度范围（Step 4）
    odd_even_ratios: [...],     // ✅ 奇偶比（Step 5）⭐ 正选条件
    ac_values: [...],           // ✅ AC值（Step 6）⭐ 正选条件
    consecutive_settings: {...}, // 连号设置（正选中的特殊处理）
    special_numbers: {...}      // 特殊号码（边号、尾号）
}
```

### 1.2 排除条件（exclusion_conditions）
**位置**：Schema定义 1082-1184行

```javascript
exclusion_conditions: {
    sum: { historical: {...} },              // 历史和值排除
    span: { historical: {...} },             // 历史跨度排除
    hwc: { historical: {...} },              // 历史热温冷比排除
    zone: { historical: {...} },             // 历史区间比排除
    conflictPairs: {...},                    // ⚠️ 相克对排除（未实现）
    coOccurrence: {...},                     // ⚠️ 同现比排除（未实现）
    consecutiveGroups: { enabled, groups },  // ✅ 连号组数排除（已实现）
    maxConsecutiveLength: { enabled, lengths }  // ✅ 最长连号排除（已实现）
}
```

**关键发现**：
- ❌ **AC值** 和 **奇偶比** 不在 `exclusion_conditions` 中
- ✅ 它们在 `positive_selection` 中，作为**正选条件**使用

---

## 二、执行流程（代码20692-21260行）

### 阶段一：正选6步筛选（保留符合条件的组合）

```
输入：324,632个红球组合（C(35,5)）

┌────────────────────────────────────────────────────────────┐
│ Step 1: 热温冷比筛选（行20770-20787）                      │
│ - 从 HotWarmColdOptimized 表获取符合热温冷比的组合ID       │
│ - 例如：热温冷比 "4:1:0" → 30,000个组合ID                  │
│ - 结果：candidateIds Set（例如30,000个）                   │
│ - 保存：step1_count = 30,000                              │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 2: 区间比筛选（行20817-20838）                        │
│ - 查询DLTRedCombinations获取详细信息                       │
│ - 过滤：保留 zone_ratio 在正选列表中的组合                 │
│ - 例如：30,000 → 12,000个组合                             │
│ - 保存：step2_retained_count = 12,000                     │
│ - 记录排除：exclusionsToSave.push({                       │
│     step: 2,                                              │
│     condition: 'positive_step2_zone_ratio',               │
│     excludedIds: [18,000个被排除的ID]                     │
│   })                                                      │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 3: 和值范围筛选（行20840-20865）                      │
│ - 过滤：保留 sum_value 在正选范围内的组合                  │
│ - 例如：12,000 → 8,000个组合                              │
│ - 保存：step3_retained_count = 8,000                      │
│ - 记录排除：excludedIds（4,000个）                        │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 4: 跨度范围筛选（行20867-20890）                      │
│ - 过滤：保留 span_value 在正选范围内的组合                 │
│ - 例如：8,000 → 5,000个组合                               │
│ - 保存：step4_retained_count = 5,000                      │
│ - 记录排除：excludedIds（3,000个）                        │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 5: 奇偶比筛选（行20892-20914）⭐ 正选条件             │
│ - 过滤：保留 odd_even_ratio 在正选列表中的组合            │
│ - 例如：5,000 → 3,500个组合                               │
│ - 保存：step5_retained_count = 3,500                      │
│ - 记录排除：excludedIds（1,500个）                        │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 6: AC值筛选（行20918-20938）⭐ 正选条件               │
│ - 过滤：保留 ac_value 在正选列表中的组合                   │
│ - 例如：3,500 → 3,200个组合                               │
│ - 保存：step6_retained_count = 3,200                      │
│ - 记录排除：excludedIds（300个）                          │
└────────────────────────────────────────────────────────────┘
                          ↓
                 final_retained_count = 3,200
```

---

### 阶段二：排除条件筛选（排除不符合条件的组合）

```
输入：3,200个正选后的组合 ⭐ 你说的这个阶段

┌────────────────────────────────────────────────────────────┐
│ Step 7: 连号组数排除（行20952-20986）⭐ 已实现             │
│ - 条件：exclusion_conditions.consecutiveGroups            │
│ - 例如：排除 groups=[0,4]（无连号 和 4连号）              │
│ - 过滤：保留 consecutive_groups 不在排除列表中的组合       │
│ - 例如：3,200 → 3,000个组合                               │
│ - ❌ 问题：未记录 excludedIds（200个）                    │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 8: 最长连号长度排除（行20988-21022）⭐ 已实现         │
│ - 条件：exclusion_conditions.maxConsecutiveLength         │
│ - 例如：排除 lengths=[0,5]（无连号 和 5连号）             │
│ - 过滤：保留 max_consecutive_length 不在排除列表中的组合   │
│ - 例如：3,000 → 2,800个组合                               │
│ - ❌ 问题：未记录 excludedIds（200个）                    │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 9: 相克对排除（行20947-20950）⚠️ TODO                │
│ - 代码注释："TODO: 可以在这里添加更多排除逻辑"              │
│ - 状态：未实现                                            │
└────────────────────────────────────────────────────────────┘
                          ↓
┌────────────────────────────────────────────────────────────┐
│ Step 10: 同现比排除（行20947-20950）⚠️ TODO               │
│ - 代码注释："TODO: 如同出分析等"                           │
│ - 状态：未实现                                            │
└────────────────────────────────────────────────────────────┘
                          ↓
                 最终组合数：2,800个
```

---

### 阶段三：红蓝配对（行21026-21079）

```
输入：2,800个红球组合

┌────────────────────────────────────────────────────────────┐
│ 配对模式选择                                               │
│ - default: 2,800红 × 66蓝 (1:1循环) = 2,800个             │
│ - truly-unlimited: 2,800红 × 66蓝 (笛卡尔积) = 184,800个   │
└────────────────────────────────────────────────────────────┘
                          ↓
              pairedResults (例如184,800个)
```

---

### 阶段四：命中分析（如果已开奖）

```
输入：184,800个配对组合 + 开奖号码

┌────────────────────────────────────────────────────────────┐
│ 计算每个组合的红球命中、蓝球命中                            │
│ 判断中奖等级（一等奖~九等奖）                              │
│ 统计奖金                                                   │
└────────────────────────────────────────────────────────────┘
                          ↓
        hit_analysis: { prize_stats, total_prize }
```

---

## 三、数据保存位置

### 3.1 正选步骤排除详情（✅ 已保存）

**保存位置**：`DLTExclusionDetails` 表
**触发时机**：行21245-21261（异步后台保存）

```javascript
// Step 2-6 的排除详情
exclusionsToSave = [
    { step: 2, condition: 'positive_step2_zone_ratio', excludedIds: [...] },
    { step: 3, condition: 'positive_step3_sum_range', excludedIds: [...] },
    { step: 4, condition: 'positive_step4_span_range', excludedIds: [...] },
    { step: 5, condition: 'positive_step5_odd_even_ratio', excludedIds: [...] },
    { step: 6, condition: 'positive_step6_ac_value', excludedIds: [...] }
];

// 异步保存到数据库
Promise.all(exclusionsToSave.map(e => saveExclusionDetails(...)));
```

### 3.2 排除条件的排除详情（❌ 未保存）

**连号组数排除**（Step 7）：
- 代码位置：20952-20986行
- 问题：只记录了 `excludedCount`，未记录 `excludedIds`
- 导致：无法知道具体哪些组合被排除

**最长连号排除**（Step 8）：
- 代码位置：20988-21022行
- 问题：同上

---

## 四、关键确认点

### 4.1 ✅ AC值 和 奇偶比 = 正选条件（不是排除条件）

| 字段 | 所属位置 | 作用 | Step |
|------|---------|------|------|
| `odd_even_ratios` | `positive_selection` | 正选：保留符合的 | Step 5 |
| `ac_values` | `positive_selection` | 正选：保留符合的 | Step 6 |

### 4.2 ✅ 流程确认：先正选 → 再排除

```
324,632个全部红球组合
    ↓
【正选6步】Step 1-6: 热温冷比 → 区间比 → 和值 → 跨度 → 奇偶比 → AC值
    ↓
3,200个符合正选条件的组合 ← ⭐ 你说的这个阶段
    ↓
【排除条件】Step 7-8: 连号组数 → 最长连号 (→ 相克对 → 同现比，未实现)
    ↓
2,800个最终保留的组合
    ↓
【红蓝配对】default/truly-unlimited
    ↓
184,800个完整组合（5红+2蓝）
```

---

## 五、Sheet 2 数据源确认

### 5.1 已有数据（可直接使用）

| Step | 名称 | 条件类型 | 数据库记录 | 代码行 |
|------|------|---------|-----------|--------|
| 2 | 区间比筛选 | `positive_step2_zone_ratio` | ✅ 已保存 | 20817-20838 |
| 3 | 和值范围筛选 | `positive_step3_sum_range` | ✅ 已保存 | 20840-20865 |
| 4 | 跨度范围筛选 | `positive_step4_span_range` | ✅ 已保存 | 20867-20890 |
| 5 | 奇偶比筛选 | `positive_step5_odd_even_ratio` | ✅ 已保存 | 20892-20914 |
| 6 | AC值筛选 | `positive_step6_ac_value` | ✅ 已保存 | 20918-20938 |

### 5.2 缺失数据（需要补充）

| Step | 名称 | 条件类型 | 数据库记录 | 代码行 | 问题 |
|------|------|---------|-----------|--------|------|
| 7 | 连号组数排除 | `exclusion_consecutive_groups` | ❌ 未保存 | 20952-20986 | 只记录count，未记录IDs |
| 8 | 最长连号排除 | `exclusion_max_consecutive_length` | ❌ 未保存 | 20988-21022 | 只记录count，未记录IDs |
| 9 | 相克对排除 | - | ❌ 未实现 | 20947-20950 | TODO状态 |
| 10 | 同现比排除 | - | ❌ 未实现 | 20947-20950 | TODO状态 |

---

## 六、验证脚本（MongoDB）

```javascript
// 1. 查看正选步骤的排除详情（应该有数据）
db.hit_dlt_exclusiondetails.find({
    task_id: "hwc-pos-20250111-001",
    period: "25121",
    step: { $in: [2, 3, 4, 5, 6] }
}).count();

// 2. 查看排除条件的排除详情（当前无数据）
db.hit_dlt_exclusiondetails.find({
    task_id: "hwc-pos-20250111-001",
    period: "25121",
    step: { $in: [7, 8] }
}).count();

// 3. 查看结果统计
db.hit_dlt_hwcpositivepredictiontaskresults.findOne({
    task_id: "hwc-pos-20250111-001",
    period: 25121
}, {
    positive_selection_details: 1,
    exclusion_summary: 1
});
```

---

**生成时间**：2025-01-11
**代码版本**：src/server/server.js (基于最新代码分析)
