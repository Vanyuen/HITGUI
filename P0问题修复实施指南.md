# P0é—®é¢˜ä¿®å¤å®æ–½æŒ‡å—

**é—®é¢˜æ ¹æºå·²ç¡®è®¤**: Schemaå­—æ®µå®šä¹‰ä¸å®é™…ä¿å­˜é€»è¾‘ä¸åŒ¹é…

---

## ğŸ”´ é—®é¢˜æ€»ç»“

### å·²ç¡®è®¤çš„Schemaå®šä¹‰ (src/server/server.js:1037-1215)

**ä»»åŠ¡è¡¨Schema**:
```javascript
const hwcPositivePredictionTaskSchema = new mongoose.Schema({
    task_id: { type: String, required: true, unique: true },
    task_name: { type: String, required: true },

    // æœŸå·èŒƒå›´ (å®é™…å®šä¹‰)
    period_range: {
        type: { type: String, required: true, enum: ['all', 'recent', 'custom'] },
        start: { type: String },      // âš ï¸ è¿™åº”è¯¥å¯¹åº” base_issue
        end: { type: String },        // âš ï¸ è¿™åº”è¯¥å¯¹åº” target_issue
        total: { type: Number, required: true }
    },

    // ... å…¶ä»–å­—æ®µ
});
```

### é—®é¢˜

æ ¹æ®è¯Šæ–­ç»“æœï¼Œæ•°æ®åº“ä¸­ï¼š
- `base_issue`: **undefined**
- `target_issue`: **undefined**
- `period_range.start`: **æœªæ£€æŸ¥** (å¾ˆå¯èƒ½ä¹Ÿæ˜¯undefined)
- `period_range.end`: **æœªæ£€æŸ¥** (å¾ˆå¯èƒ½ä¹Ÿæ˜¯undefined)

**ç»“è®º**:
1. Schemaä½¿ç”¨ `period_range.start/end`ï¼Œä½†æ•°æ®ä¿å­˜æ—¶å¯èƒ½ä½¿ç”¨äº† `base_issue/target_issue`
2. æˆ–è€…ä¿å­˜æ—¶å­—æ®µåå®Œå…¨ä¸åŒ¹é…

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: ç¡®è®¤æ•°æ®ä¿å­˜ä½ç½®

éœ€è¦æŸ¥æ‰¾ä»»åŠ¡åˆ›å»ºçš„ä»£ç ï¼Œçœ‹å®é™…ä¿å­˜æ—¶ä½¿ç”¨çš„å­—æ®µåï¼š

```bash
# æŸ¥æ‰¾ä»»åŠ¡åˆ›å»ºAPI
grep -n "api/dlt/hwc-positive" src/server/server.js

# æŸ¥æ‰¾HwcPositivePredictionTask.create
grep -n "HwcPositivePredictionTask.create\|new HwcPositivePredictionTask" src/server/server.js
```

### æ­¥éª¤2: ä¿®å¤æ–¹æ¡ˆA - ç»Ÿä¸€ä½¿ç”¨ period_range

**æ¨èæ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨Schemaå®šä¹‰çš„ `period_range` ç»“æ„

**éœ€è¦ä¿®æ”¹çš„ä½ç½®**:
1. **ä»»åŠ¡åˆ›å»ºAPI** (çº¦è¡Œ5000-5500)
   ```javascript
   // ä¿®æ”¹å‰ (å¯èƒ½çš„é”™è¯¯å†™æ³•)
   const task = new HwcPositivePredictionTask({
       task_id: taskId,
       task_name: req.body.task_name,
       base_issue: req.body.base_issue,     // âŒ é”™è¯¯
       target_issue: req.body.target_issue   // âŒ é”™è¯¯
   });

   // ä¿®æ”¹å (æ­£ç¡®å†™æ³•)
   const task = new HwcPositivePredictionTask({
       task_id: taskId,
       task_name: req.body.task_name,
       period_range: {
           type: 'custom',
           start: req.body.base_issue,       // âœ… æ­£ç¡®
           end: req.body.target_issue,       // âœ… æ­£ç¡®
           total: calculatedTotal
       }
   });
   ```

2. **ä»»åŠ¡æŸ¥è¯¢/å±•ç¤ºé€»è¾‘** (å‰ç«¯dlt-module.js)
   ```javascript
   // ä¿®æ”¹å‰
   åŸºå‡†æœŸå·: ${task.base_issue}
   ç›®æ ‡æœŸå·: ${task.target_issue}

   // ä¿®æ”¹å
   åŸºå‡†æœŸå·: ${task.period_range?.start || 'æœªè®¾ç½®'}
   ç›®æ ‡æœŸå·: ${task.period_range?.end || 'æœªè®¾ç½®'}
   ```

### æ­¥éª¤3: ä¿®å¤æ–¹æ¡ˆB - æ·»åŠ å­—æ®µåˆ«å

**å¤‡é€‰æ–¹æ¡ˆ**: åœ¨Schemaä¸­æ·»åŠ è™šæ‹Ÿå­—æ®µ

```javascript
// åœ¨hwcPositivePredictionTaskSchemaåæ·»åŠ 
hwcPositivePredictionTaskSchema.virtual('base_issue').get(function() {
    return this.period_range?.start;
});

hwcPositivePredictionTaskSchema.virtual('target_issue').get(function() {
    return this.period_range?.end;
});

// ç¡®ä¿è™šæ‹Ÿå­—æ®µè¢«åºåˆ—åŒ–
hwcPositivePredictionTaskSchema.set('toJSON', { virtuals: true });
hwcPositivePredictionTaskSchema.set('toObject', { virtuals: true });
```

---

## ğŸ” ä¿®å¤ç»“æœè¡¨å­—æ®µ

### æ­¥éª¤4: æŸ¥æ‰¾ç»“æœä¿å­˜é€»è¾‘

```bash
# æŸ¥æ‰¾ç»“æœä¿å­˜ä½ç½®
grep -n "HwcPositivePredictionTaskResult.create\|new HwcPositivePredictionTaskResult" src/server/server.js
```

### æ­¥éª¤5: ç¡®ä¿ä¿å­˜å®Œæ•´å­—æ®µ

**ç»“æœSchemaå®šä¹‰** (src/server/server.js:1218-1317):
```javascript
const hwcPositivePredictionTaskResultSchema = new mongoose.Schema({
    result_id: { type: String, required: true, unique: true },
    task_id: { type: String, required: true },
    period: { type: Number, required: true },

    // å·²æœ‰ä½†å¯èƒ½æœªä½¿ç”¨çš„å­—æ®µ
    red_combinations: [Number],
    blue_combinations: [Number],

    // ... å…¶ä»–å­—æ®µ
});
```

**éœ€è¦åœ¨ç»“æœä¿å­˜æ—¶æ·»åŠ **:
```javascript
const result = new HwcPositivePredictionTaskResult({
    result_id: generateResultId(),
    task_id: taskId,
    period: targetIssue,

    // âš¡ å¿…é¡»æ·»åŠ 
    red_balls: redBallsArray.join(','),        // ä¾‹å¦‚: "2,3,8,13,21"
    blue_balls: blueBallsArray.join(','),      // ä¾‹å¦‚: "7,12"

    // âš¡ å¦‚æœè¿™äº›å­—æ®µä¸åœ¨Schemaä¸­ï¼Œéœ€è¦å…ˆæ·»åŠ åˆ°Schema
    // åœ¨hwcPositivePredictionTaskResultSchemaä¸­æ·»åŠ :
    // red_balls: { type: String },
    // blue_balls: { type: String },
    // hit_count: { type: Number, default: 0 },
    // hit_issues: { type: mongoose.Schema.Types.Mixed },
    // prize_level: { type: String },
    // prize_amount: { type: Number }
});
```

---

## ğŸ“ ä¿®å¤é…å¯¹æ¨¡å¼å­—æ®µ

### æ­¥éª¤6: æŸ¥æ‰¾pairing_modeå®šä¹‰

Schemaä¸­å¯èƒ½æ²¡æœ‰å®šä¹‰ `pairing_mode` å­—æ®µï¼Œéœ€è¦æ·»åŠ ï¼š

```javascript
// åœ¨hwcPositivePredictionTaskSchemaä¸­æ·»åŠ  (çº¦è¡Œ1070)
pairing_mode: {
    type: String,
    required: true,
    enum: ['default', 'unlimited', 'truly-unlimited'],
    default: 'default'
},
```

---

## âœ… å¿«é€ŸéªŒè¯è„šæœ¬

ä¿®å¤åè¿è¡Œä»¥ä¸‹è„šæœ¬éªŒè¯ï¼š

```javascript
// test-field-fix.js
const { MongoClient } = require('mongodb');

async function test() {
  const client = new MongoClient('mongodb://127.0.0.1:27017');
  await client.connect();
  const db = client.db('lottery');

  // åˆ›å»ºæµ‹è¯•ä»»åŠ¡ (é€šè¿‡API)
  console.log('åˆ›å»ºæµ‹è¯•ä»»åŠ¡...');
  const response = await fetch('http://localhost:3003/api/dlt/hwc-positive-task/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      task_name: 'å­—æ®µä¿®å¤æµ‹è¯•',
      base_issue: '25123',
      target_issue: '25124',
      pairing_mode: 'default',
      exclusion_conditions: {}
    })
  });

  const result = await response.json();
  console.log('ä»»åŠ¡åˆ›å»ºç»“æœ:', result);

  // æŸ¥è¯¢ä»»åŠ¡å¹¶æ£€æŸ¥å­—æ®µ
  const taskColl = db.collection('hit_dlt_hwcpositivepredictiontasks');
  const task = await taskColl.findOne({ task_name: 'å­—æ®µä¿®å¤æµ‹è¯•' });

  console.log('\nå­—æ®µæ£€æŸ¥:');
  console.log('period_range.start:', task?.period_range?.start);
  console.log('period_range.end:', task?.period_range?.end);
  console.log('pairing_mode:', task?.pairing_mode);

  const allOk =
    task?.period_range?.start === '25123' &&
    task?.period_range?.end === '25124' &&
    task?.pairing_mode === 'default';

  console.log('\nä¿®å¤çŠ¶æ€:', allOk ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥');

  await client.close();
}

test().catch(console.error);
```

---

## ğŸ¯ ä¿®å¤æ–‡ä»¶æ¸…å•

### å¿…é¡»ä¿®æ”¹çš„æ–‡ä»¶

1. **`src/server/server.js`**
   - Schemaå®šä¹‰ (è¡Œ1037-1215)
   - ä»»åŠ¡åˆ›å»ºAPI (æœç´¢ `api/dlt/hwc-positive`)
   - ç»“æœä¿å­˜é€»è¾‘ (æœç´¢ `HwcPositivePredictionTaskResult.create`)

2. **`src/renderer/dlt-module.js`**
   - ä»»åŠ¡å±•ç¤ºé€»è¾‘
   - ä¿®æ”¹æ‰€æœ‰å¼•ç”¨ `task.base_issue` ä¸º `task.period_range?.start`
   - ä¿®æ”¹æ‰€æœ‰å¼•ç”¨ `task.target_issue` ä¸º `task.period_range?.end`

### å»ºè®®ä¿®æ”¹é¡ºåº

1. å…ˆä¿®å¤ä»»åŠ¡åˆ›å»ºé€»è¾‘ (ç¡®ä¿period_rangeæ­£ç¡®ä¿å­˜)
2. å†ä¿®å¤å‰ç«¯å±•ç¤º (ç¡®ä¿period_rangeæ­£ç¡®è¯»å–)
3. æ·»åŠ pairing_modeå­—æ®µåˆ°Schema
4. æ·»åŠ çƒå·å’Œå‘½ä¸­ç»Ÿè®¡å­—æ®µåˆ°ç»“æœSchema
5. ä¿®å¤ç»“æœä¿å­˜é€»è¾‘
6. éªŒè¯æ‰€æœ‰ä¿®å¤

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ä¸è¦åˆ é™¤ç°æœ‰æ•°æ®**: ä¿®å¤åç°æœ‰çš„é”™è¯¯æ•°æ®å¯èƒ½éœ€è¦è¿ç§»
2. **APIå…¼å®¹æ€§**: å‰ç«¯å¯èƒ½ä»ä½¿ç”¨ `base_issue/target_issue` å‚æ•°å
3. **å¤‡ä»½**: ä¿®æ”¹å‰å¤‡ä»½ `src/server/server.js`
4. **æµ‹è¯•**: æ¯æ¬¡ä¿®æ”¹åéƒ½è¦æµ‹è¯•
5. **åˆ†æ­¥è¿›è¡Œ**: ä¸è¦ä¸€æ¬¡æ”¹å¤ªå¤šï¼Œé€æ­¥éªŒè¯

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. ä¿®æ”¹çš„å…·ä½“ä»£ç ä½ç½®å’Œå†…å®¹
2. é”™è¯¯æ—¥å¿—
3. è¯Šæ–­è„šæœ¬çš„è¾“å‡º

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§æ­¥éª¤1-6é€æ­¥ä¿®å¤ï¼Œæ¯æ­¥éƒ½è¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤æ•ˆæœã€‚

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-11-04
**é¢„è®¡ä¿®å¤æ—¶é—´**: 2-4å°æ—¶
**å»ºè®®**: åˆ†æ­¥éª¤è¿›è¡Œï¼Œæ¯æ­¥éƒ½éªŒè¯åå†è¿›è¡Œä¸‹ä¸€æ­¥
