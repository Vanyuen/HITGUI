# HITå¤§ä¹é€çƒ­æ¸©å†·ä¼˜åŒ–è¡¨å¢é‡æ›´æ–°æ–¹æ¡ˆ - æœ€ç»ˆç‰ˆ

## ç‰ˆæœ¬ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆæœ€ç»ˆä¿®è®¢ç‰ˆï¼‰
- **åˆ›å»ºæ—¥æœŸ**: 2025-11-20
- **ä¿®è®¢å†…å®¹**: åŸºäºç”¨æˆ·åé¦ˆä¿®æ­£æ•°æ®æ¨¡å‹å’Œç”Ÿæˆæµç¨‹

---

## ä¸€ã€æ ¸å¿ƒè®¾è®¡ä¿®æ­£

### 1.1 æ•°æ®æ¨¡å‹ä¿®æ­£ï¼ˆå…³é”®å˜æ›´ï¼‰

#### âŒ æ—§è®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰
```javascript
{
  base_issue: "25124",
  target_issue: "25125",
  base_id: 2791,
  target_id: 0,              // âŒ ä¸å†ä½¿ç”¨ 0 è¡¨ç¤ºæ¨ç®—æœŸ
  is_predicted: true,
  // ...
}
```

#### âœ… æ–°è®¾è®¡ï¼ˆæœ€ç»ˆç‰ˆï¼‰
```javascript
{
  _id: ObjectId,
  base_issue: "25124",       // åŸºå‡†æœŸå·
  target_issue: "25125",     // ç›®æ ‡æœŸå·
  base_id: 2791,             // åŸºå‡†æœŸIDï¼ˆå¯¹åº” hit_dlts.IDï¼‰
  target_id: 2792,           // âœ… ç›®æ ‡æœŸIDï¼ˆæ¨ç®—æœŸä½¿ç”¨ latest_target_id + 1ï¼‰
  is_predicted: true,        // âœ… æ¨ç®—æœŸæ ‡è¯†ï¼ˆä¸»è¦åˆ¤æ–­ä¾æ®ï¼‰
  hot_warm_cold_data: Map,   // çƒ­æ¸©å†·åˆ†ç»„æ•°æ®
  hit_analysis: {},          // å‘½ä¸­åˆ†æï¼ˆä»…å·²å¼€å¥–æœŸæœ‰æ•°æ®ï¼‰
  statistics: {},            // ç»Ÿè®¡ä¿¡æ¯
  version: 2,                // æ•°æ®ç‰ˆæœ¬å·
  last_updated: Date,        // æœ€åæ›´æ–°æ—¶é—´
  created_at: Date           // åˆ›å»ºæ—¶é—´
}
```

**è®¾è®¡ç†å¿µ**ï¼š
1. **`is_predicted` å­—æ®µ**ï¼šä½œä¸ºæ¨ç®—æœŸçš„ä¸»è¦æ ‡è¯†ç¬¦
2. **`target_id` å­—æ®µ**ï¼šä¿æŒè¿ç»­æ€§ï¼Œæ¨ç®—æœŸä½¿ç”¨ `latest_target_id + 1`
3. **æ— ç‰¹æ®Šå€¼**ï¼šé¿å…ä½¿ç”¨ 0 ç­‰ç‰¹æ®Šå€¼ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§

### 1.2 æ¨ç®—æœŸ ID åˆ†é…é€»è¾‘

```javascript
/**
 * è·å–ç›®æ ‡æœŸçš„ ID
 * @param {string} targetIssue - ç›®æ ‡æœŸå·
 * @returns {number} ç›®æ ‡æœŸID
 */
async function getTargetId(targetIssue) {
  // 1. æŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å­˜åœ¨è¯¥æœŸå·
  const existingRecord = await hit_dlts.findOne({ Issue: targetIssue });

  if (existingRecord) {
    // å·²å¼€å¥–æœŸï¼šç›´æ¥è¿”å›æ•°æ®åº“ä¸­çš„ ID
    return existingRecord.ID;
  } else {
    // æ¨ç®—æœŸï¼šè¿”å›æœ€æ–°è®°å½•ID + 1
    const latestRecord = await hit_dlts.findOne({})
      .sort({ ID: -1 })
      .lean();

    return latestRecord.ID + 1;
  }
}
```

**ç¤ºä¾‹**ï¼š
```javascript
// å‡è®¾æ•°æ®åº“æœ€æ–°è®°å½•ï¼š
// { ID: 2791, Issue: 25124 }

// å·²å¼€å¥–æœŸ
getTargetId("25124") â†’ 2791  // ç›´æ¥ä»æ•°æ®åº“è·å–

// æ¨ç®—æœŸï¼ˆä¸‹ä¸€æœŸï¼‰
getTargetId("25125") â†’ 2792  // latest_ID + 1 = 2791 + 1 = 2792

// æ¨ç®—æœŸï¼ˆå†ä¸‹ä¸€æœŸï¼Œç†è®ºä¸Šä¸ä¼šç”¨åˆ°ï¼‰
getTargetId("25126") â†’ 2792  // ä»ç„¶æ˜¯ latest_ID + 1ï¼ˆå› ä¸º25125å°šæœªå¼€å¥–ï¼‰
```

---

## äºŒã€çƒ­æ¸©å†·ä¼˜åŒ–è¡¨ç”Ÿæˆæµç¨‹

### 2.1 ç”Ÿæˆé€”å¾„ï¼ˆå¤šé€”å¾„è®¾è®¡ï¼‰

#### é€”å¾„1ï¼šå¤§ä¹é€æ•°æ®ç®¡ç†åå° - ä¸€é”®æ›´æ–°å…¨éƒ¨æ•°æ®è¡¨
**ä½ç½®**: å‰ç«¯ UI æŒ‰é’® â†’ API `/api/dlt/admin/update-all-tables`

**è§¦å‘åœºæ™¯**ï¼š
- é¦–æ¬¡éƒ¨ç½²ç³»ç»Ÿ
- å¤§è§„æ¨¡æ•°æ®ä¿®å¤
- æ‰‹åŠ¨å…¨é‡é‡å»º

**æ‰§è¡Œæµç¨‹**ï¼š
```javascript
async function updateAllDLTTables() {
  try {
    // 1. æ›´æ–°åŸºç¡€æ•°æ®è¡¨ï¼ˆçº¢çƒç»„åˆã€è“çƒç»„åˆç­‰ï¼‰
    await updateRedCombinations();
    await updateBlueCombinations();

    // 2. æ›´æ–°é—æ¼å€¼è¡¨
    await updateMissingValues();

    // 3. å…¨é‡é‡å»ºçƒ­æ¸©å†·ä¼˜åŒ–è¡¨
    await rebuildHwcOptimizedTable();  // ğŸ‘ˆ å…³é”®æ­¥éª¤

    // 4. æ›´æ–°å…¶ä»–ç»Ÿè®¡è¡¨
    await updateStatisticsTables();

    return { success: true, message: 'æ‰€æœ‰è¡¨æ›´æ–°å®Œæˆ' };
  } catch (error) {
    console.error('æ›´æ–°å¤±è´¥:', error);
    return { success: false, message: error.message };
  }
}
```

#### é€”å¾„2ï¼šæ–°å¼€å¥–æ•°æ®å¯¼å…¥æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
**ä½ç½®**: API `/api/dlt/import-new-issue`

**è§¦å‘åœºæ™¯**ï¼š
- æ¯æœŸå¼€å¥–åå¯¼å…¥æ–°æ•°æ®
- æ‰¹é‡å¯¼å…¥å†å²æ•°æ®

**æ‰§è¡Œæµç¨‹**ï¼ˆå¢å¼ºç‰ˆï¼‰ï¼š
```javascript
async function importNewIssue(issueData) {
  try {
    // 1. æ’å…¥æ–°å¼€å¥–è®°å½•åˆ° hit_dlts
    const newRecord = await hit_dlts.create({
      Issue: issueData.Issue,
      ID: await getNextID(),
      RedBalls: issueData.RedBalls,
      BlueBalls: issueData.BlueBalls,
      // ... å…¶ä»–å­—æ®µ
    });

    // 2. æ›´æ–°é—æ¼å€¼è¡¨
    await updateMissingValuesForNewIssue(newRecord.Issue);

    // 3. ğŸ”‘ å¢é‡æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨ï¼ˆæ–°å¢æ­¥éª¤ï¼‰
    await incrementalUpdateHwcOptimized(newRecord);

    return { success: true, newRecord };
  } catch (error) {
    console.error('å¯¼å…¥å¤±è´¥:', error);
    throw error;
  }
}
```

#### é€”å¾„3ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
**ä½ç½®**: åå°å®šæ—¶ä»»åŠ¡ï¼ˆcron jobï¼‰

**è§¦å‘åœºæ™¯**ï¼š
- æ¯å¤©å‡Œæ™¨è‡ªåŠ¨æ£€æµ‹
- æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡

```javascript
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ£€æµ‹æ˜¯å¦æœ‰æ–°å¼€å¥–
cron.schedule('0 * * * *', async () => {
  const hasNewIssue = await checkForNewIssue();
  if (hasNewIssue) {
    await incrementalUpdateHwcOptimized();
  }
});
```

### 2.2 å¢é‡æ›´æ–°æµç¨‹ï¼ˆæ ¸å¿ƒå®ç°ï¼‰

#### å®Œæ•´æµç¨‹å›¾
```
æ–°å¼€å¥–æ•°æ®å¯¼å…¥
    â†“
æ£€æµ‹æœ€æ–°æœŸå·
    â†“
æ­¥éª¤1: åˆ é™¤æ—§æ¨ç®—æœŸæ•°æ®ï¼ˆis_predicted=trueï¼‰
    â†“
æ­¥éª¤2: ç”Ÿæˆæ–°å¼€å¥–æœŸçš„æœŸå·å¯¹æ•°æ®
    â”œâ”€ ç”Ÿæˆ: (æœ€æ–°æœŸ-1) â†’ (æœ€æ–°æœŸ)
    â””â”€ æ ‡è®°: is_predicted=false
    â†“
æ­¥éª¤3: ç”Ÿæˆæ–°æ¨ç®—æœŸçš„æœŸå·å¯¹æ•°æ®
    â”œâ”€ ç”Ÿæˆ: (æœ€æ–°æœŸ) â†’ (æœ€æ–°æœŸ+1)
    â””â”€ æ ‡è®°: is_predicted=true
    â†“
æ­¥éª¤4: æ›´æ–°ç¼“å­˜
    â†“
å®Œæˆ
```

#### è¯¦ç»†å®ç°ä»£ç 

```javascript
/**
 * å¢é‡æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨
 * @param {Object} newRecord - æ–°å¼€å¥–è®°å½•
 */
async function incrementalUpdateHwcOptimized(newRecord) {
  const session = await mongoose.startSession();
  session.startTransaction();

  try {
    console.log(`ğŸ”„ å¼€å§‹å¢é‡æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨ï¼Œæ–°æœŸå·: ${newRecord.Issue}`);

    // ========================================
    // æ­¥éª¤1: åˆ é™¤æ—§æ¨ç®—æœŸæ•°æ®
    // ========================================
    const deleteResult = await DLTRedCombinationsHotWarmColdOptimized.deleteMany(
      { is_predicted: true },
      { session }
    );
    console.log(`âœ… æ­¥éª¤1å®Œæˆ: åˆ é™¤ ${deleteResult.deletedCount} æ¡æ—§æ¨ç®—æœŸæ•°æ®`);

    // ========================================
    // æ­¥éª¤2: ç”Ÿæˆæ–°å¼€å¥–æœŸçš„æœŸå·å¯¹æ•°æ®
    // ========================================
    const prevRecord = await hit_dlts.findOne({ ID: newRecord.ID - 1 }).lean();

    if (prevRecord) {
      const newDrawnPairData = await generateHwcDataForPair({
        base_issue: prevRecord.Issue.toString(),
        target_issue: newRecord.Issue.toString(),
        base_id: prevRecord.ID,
        target_id: newRecord.ID,
        is_predicted: false  // âœ… å·²å¼€å¥–æœŸ
      });

      await DLTRedCombinationsHotWarmColdOptimized.create(
        [newDrawnPairData],
        { session }
      );
      console.log(`âœ… æ­¥éª¤2å®Œæˆ: ç”Ÿæˆæ–°å¼€å¥–æœŸå·å¯¹ ${prevRecord.Issue} â†’ ${newRecord.Issue}`);
    }

    // ========================================
    // æ­¥éª¤3: ç”Ÿæˆæ–°æ¨ç®—æœŸçš„æœŸå·å¯¹æ•°æ®
    // ========================================
    const predictedIssue = (parseInt(newRecord.Issue) + 1).toString();
    const predictedId = newRecord.ID + 1;  // âœ… ä½¿ç”¨ latest_ID + 1

    const newPredictedPairData = await generateHwcDataForPair({
      base_issue: newRecord.Issue.toString(),
      target_issue: predictedIssue,
      base_id: newRecord.ID,
      target_id: predictedId,           // âœ… ä¸ä½¿ç”¨ 0ï¼Œä½¿ç”¨è¿ç»­ID
      is_predicted: true                // âœ… æ¨ç®—æœŸæ ‡è¯†
    });

    await DLTRedCombinationsHotWarmColdOptimized.create(
      [newPredictedPairData],
      { session }
    );
    console.log(`âœ… æ­¥éª¤3å®Œæˆ: ç”Ÿæˆæ–°æ¨ç®—æœŸå·å¯¹ ${newRecord.Issue} â†’ ${predictedIssue}`);

    // ========================================
    // æ­¥éª¤4: æ›´æ–°ç¼“å­˜
    // ========================================
    await globalCacheManager.clearTaskSpecificCache();
    await globalCacheManager.preloadHwcOptimizedData();
    console.log(`âœ… æ­¥éª¤4å®Œæˆ: ç¼“å­˜å·²æ›´æ–°`);

    // æäº¤äº‹åŠ¡
    await session.commitTransaction();
    console.log(`ğŸ‰ å¢é‡æ›´æ–°å®Œæˆï¼`);

    return {
      success: true,
      deletedCount: deleteResult.deletedCount,
      newDrawnPair: prevRecord ? `${prevRecord.Issue}â†’${newRecord.Issue}` : null,
      newPredictedPair: `${newRecord.Issue}â†’${predictedIssue}`
    };

  } catch (error) {
    // å›æ»šäº‹åŠ¡
    await session.abortTransaction();
    console.error('âŒ å¢é‡æ›´æ–°å¤±è´¥ï¼Œäº‹åŠ¡å·²å›æ»š:', error);
    throw error;
  } finally {
    session.endSession();
  }
}
```

### 2.3 ç”ŸæˆæœŸå·å¯¹æ•°æ®çš„æ ¸å¿ƒå‡½æ•°

```javascript
/**
 * ä¸ºæœŸå·å¯¹ç”Ÿæˆçƒ­æ¸©å†·æ•°æ®
 * @param {Object} pairConfig - æœŸå·å¯¹é…ç½®
 * @returns {Object} çƒ­æ¸©å†·ä¼˜åŒ–æ•°æ®
 */
async function generateHwcDataForPair(pairConfig) {
  const {
    base_issue,
    target_issue,
    base_id,
    target_id,
    is_predicted
  } = pairConfig;

  // 1. è·å–åŸºå‡†æœŸçš„é—æ¼å€¼æ•°æ®
  const baseMissingData = await DLTRedMissing.findOne({
    Issue: base_issue
  }).lean();

  if (!baseMissingData) {
    throw new Error(`æ‰¾ä¸åˆ°æœŸå· ${base_issue} çš„é—æ¼å€¼æ•°æ®`);
  }

  // 2. åˆå§‹åŒ–çƒ­æ¸©å†·åˆ†ç»„ Map
  const hwcGroupMap = new Map();

  // 3. éå†æ‰€æœ‰çº¢çƒç»„åˆï¼ˆ324,632ä¸ªï¼‰
  const redCombinations = await hit_dlt_redcombinations.find({}).lean();

  for (const combo of redCombinations) {
    const balls = combo.balls; // [1, 2, 3, 4, 5]

    // è®¡ç®—è¯¥ç»„åˆçš„çƒ­æ¸©å†·æ¯”
    const hwcRatio = calculateHwcRatio(balls, baseMissingData);
    const ratioKey = `${hwcRatio.hot}:${hwcRatio.warm}:${hwcRatio.cold}`;

    // åˆ†ç»„å­˜å‚¨
    if (!hwcGroupMap.has(ratioKey)) {
      hwcGroupMap.set(ratioKey, []);
    }
    hwcGroupMap.get(ratioKey).push(combo.combination_id);
  }

  // 4. è®¡ç®—å‘½ä¸­åˆ†æï¼ˆä»…å·²å¼€å¥–æœŸï¼‰
  let hitAnalysis = null;
  if (!is_predicted) {
    const targetRecord = await hit_dlts.findOne({
      Issue: target_issue
    }).lean();

    if (targetRecord) {
      hitAnalysis = await calculateHitAnalysis(
        hwcGroupMap,
        targetRecord.RedBalls
      );
    }
  }

  // 5. è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
  const statistics = {
    ratio_counts: Object.fromEntries(
      Array.from(hwcGroupMap.entries()).map(([ratio, ids]) => [ratio, ids.length])
    ),
    total_combinations: redCombinations.length
  };

  // 6. æ„å»ºæœ€ç»ˆæ•°æ®å¯¹è±¡
  return {
    base_issue,
    target_issue,
    base_id,
    target_id,
    is_predicted,
    hot_warm_cold_data: Object.fromEntries(hwcGroupMap),
    hit_analysis: hitAnalysis,
    statistics,
    version: 2,
    last_updated: new Date(),
    created_at: new Date()
  };
}
```

### 2.4 çƒ­æ¸©å†·æ¯”è®¡ç®—å‡½æ•°

```javascript
/**
 * è®¡ç®—ç»„åˆçš„çƒ­æ¸©å†·æ¯”
 * @param {Array} balls - çº¢çƒæ•°ç»„ [1, 2, 3, 4, 5]
 * @param {Object} missingData - é—æ¼å€¼æ•°æ®
 * @returns {Object} {hot, warm, cold}
 */
function calculateHwcRatio(balls, missingData) {
  let hot = 0;
  let warm = 0;
  let cold = 0;

  for (const ball of balls) {
    const missingKey = `ball_${String(ball).padStart(2, '0')}`;
    const missingValue = missingData[missingKey] || 0;

    if (missingValue <= 4) {
      hot++;
    } else if (missingValue >= 5 && missingValue <= 9) {
      warm++;
    } else {
      cold++;
    }
  }

  return { hot, warm, cold };
}
```

---

## ä¸‰ã€æŸ¥è¯¢ä¼˜åŒ–

### 3.1 ä½¿ç”¨ `is_predicted` å­—æ®µæŸ¥è¯¢

#### æŸ¥è¯¢å·²å¼€å¥–æœŸæ•°æ®
```javascript
async function getDrawnPeriodData(baseIssue, targetIssue) {
  return await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: baseIssue,
    target_issue: targetIssue,
    is_predicted: false  // âœ… æ˜ç¡®æŸ¥è¯¢å·²å¼€å¥–æœŸ
  }).lean();
}
```

#### æŸ¥è¯¢æ¨ç®—æœŸæ•°æ®
```javascript
async function getPredictedPeriodData() {
  return await DLTRedCombinationsHotWarmColdOptimized.findOne({
    is_predicted: true  // âœ… æ˜ç¡®æŸ¥è¯¢æ¨ç®—æœŸ
  }).lean();
}
```

#### ç»Ÿä¸€æŸ¥è¯¢æ¥å£
```javascript
async function getHwcData(baseIssue, targetIssue) {
  // 1. å…ˆæŸ¥è¯¢å·²å¼€å¥–æœŸæ•°æ®
  let data = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: baseIssue,
    target_issue: targetIssue,
    is_predicted: false
  }).lean();

  // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼ŒæŸ¥è¯¢æ¨ç®—æœŸæ•°æ®
  if (!data) {
    data = await DLTRedCombinationsHotWarmColdOptimized.findOne({
      base_issue: baseIssue,
      target_issue: targetIssue,
      is_predicted: true
    }).lean();
  }

  // 3. å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼ŒåŠ¨æ€ç”Ÿæˆ
  if (!data) {
    data = await generateHwcDataForPair({
      base_issue: baseIssue,
      target_issue: targetIssue,
      base_id: await getBaseId(baseIssue),
      target_id: await getTargetId(targetIssue),
      is_predicted: await isPredictedIssue(targetIssue)
    });
  }

  return data;
}
```

### 3.2 ä¼˜åŒ–ç´¢å¼•ç­–ç•¥

```javascript
// åˆ›å»ºç´¢å¼•
DLTRedCombinationsHotWarmColdOptimizedSchema.index({
  base_issue: 1,
  target_issue: 1,
  is_predicted: 1
}, {
  name: 'idx_period_pair_predicted'
});

DLTRedCombinationsHotWarmColdOptimizedSchema.index({
  base_id: 1,
  target_id: 1
}, {
  name: 'idx_id_pair'
});

DLTRedCombinationsHotWarmColdOptimizedSchema.index({
  is_predicted: 1,
  created_at: -1
}, {
  name: 'idx_predicted_time'
});
```

---

## å››ã€æ•°æ®åº“è¿ç§»è„šæœ¬

### 4.1 è¿ç§»ç°æœ‰æ•°æ®

```javascript
/**
 * è¿ç§»è„šæœ¬ï¼šä¿®æ­£ç°æœ‰æ•°æ®çš„ target_id
 */
async function migrateExistingHwcData() {
  console.log('å¼€å§‹è¿ç§»çƒ­æ¸©å†·ä¼˜åŒ–è¡¨æ•°æ®...');

  // 1. æ„å»º Issue â†’ ID æ˜ å°„
  const issueToIdMap = new Map();
  const dltRecords = await hit_dlts.find({}).lean();
  dltRecords.forEach(record => {
    issueToIdMap.set(record.Issue.toString(), record.ID);
  });

  const latestId = Math.max(...issueToIdMap.values());
  console.log(`æœ€æ–°æœŸå·ID: ${latestId}`);

  // 2. æ›´æ–°æ‰€æœ‰è®°å½•
  const hwcRecords = await DLTRedCombinationsHotWarmColdOptimized.find({}).lean();
  let updatedCount = 0;

  for (const record of hwcRecords) {
    const baseId = issueToIdMap.get(record.base_issue) || 0;
    let targetId;
    let isPredicted;

    // åˆ¤æ–­æ˜¯å¦ä¸ºæ¨ç®—æœŸ
    if (issueToIdMap.has(record.target_issue)) {
      // å·²å¼€å¥–æœŸ
      targetId = issueToIdMap.get(record.target_issue);
      isPredicted = false;
    } else {
      // æ¨ç®—æœŸï¼šä½¿ç”¨ latestId + 1
      targetId = latestId + 1;
      isPredicted = true;
    }

    await DLTRedCombinationsHotWarmColdOptimized.updateOne(
      { _id: record._id },
      {
        $set: {
          base_id: baseId,
          target_id: targetId,      // âœ… æ¨ç®—æœŸä½¿ç”¨ latestId + 1
          is_predicted: isPredicted,
          version: 2,
          last_updated: new Date()
        }
      }
    );

    updatedCount++;
    if (updatedCount % 100 === 0) {
      console.log(`å·²æ›´æ–° ${updatedCount}/${hwcRecords.length} æ¡è®°å½•`);
    }
  }

  console.log(`âœ… è¿ç§»å®Œæˆï¼Œå…±æ›´æ–° ${updatedCount} æ¡è®°å½•`);
}
```

### 4.2 éªŒè¯è¿ç§»ç»“æœ

```javascript
/**
 * éªŒè¯è„šæœ¬ï¼šæ£€æŸ¥è¿ç§»åçš„æ•°æ®æ­£ç¡®æ€§
 */
async function verifyMigration() {
  console.log('å¼€å§‹éªŒè¯è¿ç§»ç»“æœ...');

  // 1. æ£€æŸ¥æ˜¯å¦æœ‰ target_id = 0 çš„è®°å½•ï¼ˆåº”è¯¥æ²¡æœ‰ï¼‰
  const zeroIdCount = await DLTRedCombinationsHotWarmColdOptimized.countDocuments({
    target_id: 0
  });
  console.log(`target_id=0 çš„è®°å½•æ•°: ${zeroIdCount} (åº”ä¸º0)`);

  // 2. æ£€æŸ¥æ¨ç®—æœŸè®°å½•
  const predictedRecords = await DLTRedCombinationsHotWarmColdOptimized.find({
    is_predicted: true
  }).lean();
  console.log(`æ¨ç®—æœŸè®°å½•æ•°: ${predictedRecords.length}`);

  for (const record of predictedRecords) {
    console.log(`  - ${record.base_issue} â†’ ${record.target_issue}, target_id=${record.target_id}`);
  }

  // 3. æ£€æŸ¥å·²å¼€å¥–æœŸè®°å½•
  const drawnRecords = await DLTRedCombinationsHotWarmColdOptimized.find({
    is_predicted: false
  }).limit(5).lean();
  console.log(`å·²å¼€å¥–æœŸè®°å½•ç¤ºä¾‹:`);

  for (const record of drawnRecords) {
    const targetExists = await hit_dlts.findOne({ Issue: record.target_issue });
    console.log(`  - ${record.base_issue} â†’ ${record.target_issue}, target_id=${record.target_id}, æœŸå·å­˜åœ¨: ${!!targetExists}`);
  }

  // 4. æ£€æŸ¥ ID è¿ç»­æ€§
  const latestDbId = await hit_dlts.findOne({}).sort({ ID: -1 }).lean();
  const predictedTargetId = predictedRecords[0]?.target_id;
  const expectedId = latestDbId.ID + 1;

  console.log(`æœ€æ–°æ•°æ®åº“ID: ${latestDbId.ID}`);
  console.log(`æ¨ç®—æœŸ target_id: ${predictedTargetId}`);
  console.log(`é¢„æœŸå€¼: ${expectedId}`);
  console.log(`ä¸€è‡´æ€§æ£€æŸ¥: ${predictedTargetId === expectedId ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);

  console.log('éªŒè¯å®Œæˆï¼');
}
```

---

## äº”ã€API æ¥å£è®¾è®¡

### 5.1 å¢é‡æ›´æ–°æ¥å£

```javascript
/**
 * POST /api/dlt/hwc-optimized/incremental-update
 * æ‰‹åŠ¨è§¦å‘å¢é‡æ›´æ–°
 */
router.post('/hwc-optimized/incremental-update', async (req, res) => {
  try {
    // è·å–æœ€æ–°å¼€å¥–è®°å½•
    const latestRecord = await hit_dlts.findOne({})
      .sort({ ID: -1 })
      .lean();

    if (!latestRecord) {
      return res.status(400).json({
        success: false,
        message: 'æ•°æ®åº“ä¸­æ²¡æœ‰å¼€å¥–è®°å½•'
      });
    }

    // æ‰§è¡Œå¢é‡æ›´æ–°
    const result = await incrementalUpdateHwcOptimized(latestRecord);

    res.json({
      success: true,
      message: 'å¢é‡æ›´æ–°å®Œæˆ',
      data: result
    });
  } catch (error) {
    console.error('å¢é‡æ›´æ–°å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

### 5.2 æŸ¥è¯¢æ¥å£

```javascript
/**
 * GET /api/dlt/hwc-optimized/query
 * æŸ¥è¯¢çƒ­æ¸©å†·æ•°æ®
 */
router.get('/hwc-optimized/query', async (req, res) => {
  try {
    const { base_issue, target_issue } = req.query;

    const data = await getHwcData(base_issue, target_issue);

    res.json({
      success: true,
      data: {
        base_issue: data.base_issue,
        target_issue: data.target_issue,
        base_id: data.base_id,
        target_id: data.target_id,
        is_predicted: data.is_predicted,
        hot_warm_cold_data: data.hot_warm_cold_data,
        statistics: data.statistics
      }
    });
  } catch (error) {
    console.error('æŸ¥è¯¢å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

### 5.3 çŠ¶æ€æŸ¥è¯¢æ¥å£

```javascript
/**
 * GET /api/dlt/hwc-optimized/status
 * æŸ¥è¯¢çƒ­æ¸©å†·ä¼˜åŒ–è¡¨çŠ¶æ€
 */
router.get('/hwc-optimized/status', async (req, res) => {
  try {
    const totalCount = await DLTRedCombinationsHotWarmColdOptimized.countDocuments({});
    const drawnCount = await DLTRedCombinationsHotWarmColdOptimized.countDocuments({
      is_predicted: false
    });
    const predictedCount = await DLTRedCombinationsHotWarmColdOptimized.countDocuments({
      is_predicted: true
    });

    const latestDrawn = await DLTRedCombinationsHotWarmColdOptimized.findOne({
      is_predicted: false
    }).sort({ target_id: -1 }).lean();

    const latestPredicted = await DLTRedCombinationsHotWarmColdOptimized.findOne({
      is_predicted: true
    }).lean();

    res.json({
      success: true,
      data: {
        total_count: totalCount,
        drawn_count: drawnCount,
        predicted_count: predictedCount,
        latest_drawn_pair: latestDrawn ? `${latestDrawn.base_issue}â†’${latestDrawn.target_issue}` : null,
        latest_predicted_pair: latestPredicted ? `${latestPredicted.base_issue}â†’${latestPredicted.target_issue}` : null,
        latest_drawn_target_id: latestDrawn?.target_id,
        latest_predicted_target_id: latestPredicted?.target_id
      }
    });
  } catch (error) {
    console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
});
```

---

## å…­ã€å‰ç«¯é›†æˆ

### 6.1 æ•°æ®å¯¼å…¥æ—¶è‡ªåŠ¨è§¦å‘

```javascript
// src/renderer/dlt-module.js

async function importNewIssueData(issueData) {
  try {
    // 1. å¯¼å…¥æ–°å¼€å¥–æ•°æ®
    const importResult = await fetch(`${API_BASE_URL}/api/dlt/import-new-issue`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(issueData)
    }).then(res => res.json());

    if (!importResult.success) {
      throw new Error(importResult.message);
    }

    // 2. è‡ªåŠ¨è§¦å‘å¢é‡æ›´æ–°ï¼ˆåœ¨åç«¯å·²é›†æˆï¼‰
    // å‰ç«¯æ— éœ€é¢å¤–æ“ä½œï¼Œåç«¯ importNewIssue å·²åŒ…å« incrementalUpdateHwcOptimized

    // 3. æç¤ºç”¨æˆ·
    showNotification('å¯¼å…¥æˆåŠŸ', `æœŸå· ${issueData.Issue} å·²å¯¼å…¥ï¼Œçƒ­æ¸©å†·æ•°æ®å·²è‡ªåŠ¨æ›´æ–°`);

  } catch (error) {
    console.error('å¯¼å…¥å¤±è´¥:', error);
    showNotification('å¯¼å…¥å¤±è´¥', error.message, 'error');
  }
}
```

### 6.2 æ‰‹åŠ¨è§¦å‘æ›´æ–°æŒ‰é’®

```html
<!-- åœ¨å¤§ä¹é€æ•°æ®ç®¡ç†é¡µé¢æ·»åŠ æŒ‰é’® -->
<div class="admin-controls">
  <button id="btnUpdateHwcOptimized" class="btn btn-primary">
    ğŸ”„ æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨
  </button>
  <button id="btnViewHwcStatus" class="btn btn-info">
    ğŸ“Š æŸ¥çœ‹çƒ­æ¸©å†·è¡¨çŠ¶æ€
  </button>
</div>
```

```javascript
// ç»‘å®šæŒ‰é’®äº‹ä»¶
document.getElementById('btnUpdateHwcOptimized').addEventListener('click', async () => {
  if (!confirm('ç¡®å®šè¦æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨å—ï¼Ÿ')) return;

  try {
    const result = await fetch(`${API_BASE_URL}/api/dlt/hwc-optimized/incremental-update`, {
      method: 'POST'
    }).then(res => res.json());

    if (result.success) {
      alert(`æ›´æ–°æˆåŠŸï¼\nåˆ é™¤æ—§æ¨ç®—æœŸ: ${result.data.deletedCount} æ¡\næ–°å¼€å¥–æœŸå·å¯¹: ${result.data.newDrawnPair}\næ–°æ¨ç®—æœŸå·å¯¹: ${result.data.newPredictedPair}`);
    } else {
      alert('æ›´æ–°å¤±è´¥: ' + result.message);
    }
  } catch (error) {
    alert('æ›´æ–°å¤±è´¥: ' + error.message);
  }
});

document.getElementById('btnViewHwcStatus').addEventListener('click', async () => {
  try {
    const result = await fetch(`${API_BASE_URL}/api/dlt/hwc-optimized/status`)
      .then(res => res.json());

    if (result.success) {
      const status = result.data;
      alert(`çƒ­æ¸©å†·ä¼˜åŒ–è¡¨çŠ¶æ€ï¼š\n` +
            `æ€»è®°å½•æ•°: ${status.total_count}\n` +
            `å·²å¼€å¥–æœŸ: ${status.drawn_count}\n` +
            `æ¨ç®—æœŸ: ${status.predicted_count}\n` +
            `æœ€æ–°å·²å¼€å¥–æœŸå·å¯¹: ${status.latest_drawn_pair}\n` +
            `æœ€æ–°æ¨ç®—æœŸå·å¯¹: ${status.latest_predicted_pair}\n` +
            `æœ€æ–°å·²å¼€å¥– target_id: ${status.latest_drawn_target_id}\n` +
            `æœ€æ–°æ¨ç®— target_id: ${status.latest_predicted_target_id}`);
    }
  } catch (error) {
    alert('æŸ¥è¯¢å¤±è´¥: ' + error.message);
  }
});
```

---

## ä¸ƒã€æµ‹è¯•éªŒè¯

### 7.1 å•å…ƒæµ‹è¯•

```javascript
// test-hwc-incremental-update.js

const mongoose = require('mongoose');
const { incrementalUpdateHwcOptimized } = require('./src/server/server.js');

async function runTests() {
  await mongoose.connect('mongodb://127.0.0.1:27017/lottery');

  console.log('========================================');
  console.log('æµ‹è¯•1: å¢é‡æ›´æ–°æµç¨‹');
  console.log('========================================');

  // æ¨¡æ‹Ÿæ–°å¼€å¥–è®°å½•
  const mockNewRecord = {
    ID: 2792,
    Issue: '25125',
    RedBalls: [1, 5, 12, 23, 35],
    BlueBalls: [3, 7]
  };

  const result = await incrementalUpdateHwcOptimized(mockNewRecord);
  console.log('ç»“æœ:', result);

  console.log('\n========================================');
  console.log('æµ‹è¯•2: éªŒè¯æ¨ç®—æœŸ target_id');
  console.log('========================================');

  const predictedRecord = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    is_predicted: true
  });

  console.log('æ¨ç®—æœŸè®°å½•:', {
    base_issue: predictedRecord.base_issue,
    target_issue: predictedRecord.target_issue,
    base_id: predictedRecord.base_id,
    target_id: predictedRecord.target_id,  // åº”è¯¥æ˜¯ 2793 (2792 + 1)
    is_predicted: predictedRecord.is_predicted
  });

  const expectedTargetId = mockNewRecord.ID + 1;
  const testPassed = predictedRecord.target_id === expectedTargetId;

  console.log(`\né¢„æœŸ target_id: ${expectedTargetId}`);
  console.log(`å®é™… target_id: ${predictedRecord.target_id}`);
  console.log(`æµ‹è¯•ç»“æœ: ${testPassed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);

  await mongoose.disconnect();
}

runTests().catch(console.error);
```

### 7.2 é›†æˆæµ‹è¯•

```javascript
// test-hwc-integration.js

async function testIntegration() {
  console.log('========================================');
  console.log('é›†æˆæµ‹è¯•: å®Œæ•´å¯¼å…¥æµç¨‹');
  console.log('========================================');

  // 1. å¯¼å…¥æ–°å¼€å¥–æ•°æ®
  const newIssueData = {
    Issue: '25126',
    RedBalls: [2, 8, 15, 28, 33],
    BlueBalls: [5, 9],
    // ... å…¶ä»–å­—æ®µ
  };

  console.log('æ­¥éª¤1: å¯¼å…¥æ–°å¼€å¥–æ•°æ®');
  const importResult = await importNewIssue(newIssueData);
  console.log('å¯¼å…¥ç»“æœ:', importResult);

  // 2. éªŒè¯çƒ­æ¸©å†·æ•°æ®
  console.log('\næ­¥éª¤2: éªŒè¯çƒ­æ¸©å†·æ•°æ®');

  const drawnPair = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    target_issue: '25126',
    is_predicted: false
  });
  console.log('å·²å¼€å¥–æœŸå·å¯¹:', drawnPair ? `${drawnPair.base_issue}â†’${drawnPair.target_issue}` : 'æœªæ‰¾åˆ°');

  const predictedPair = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: '25126',
    is_predicted: true
  });
  console.log('æ¨ç®—æœŸå·å¯¹:', predictedPair ? `${predictedPair.base_issue}â†’${predictedPair.target_issue}` : 'æœªæ‰¾åˆ°');

  // 3. éªŒè¯ ID æ­£ç¡®æ€§
  console.log('\næ­¥éª¤3: éªŒè¯ ID æ­£ç¡®æ€§');
  const latestDbRecord = await hit_dlts.findOne({ Issue: '25126' });
  const expectedPredictedId = latestDbRecord.ID + 1;

  console.log(`æœ€æ–°æ•°æ®åº“è®°å½• ID: ${latestDbRecord.ID}`);
  console.log(`æ¨ç®—æœŸ target_id: ${predictedPair.target_id}`);
  console.log(`é¢„æœŸå€¼: ${expectedPredictedId}`);
  console.log(`IDä¸€è‡´æ€§: ${predictedPair.target_id === expectedPredictedId ? 'âœ…' : 'âŒ'}`);

  // 4. éªŒè¯æ—§æ¨ç®—æœŸå·²åˆ é™¤
  console.log('\næ­¥éª¤4: éªŒè¯æ—§æ¨ç®—æœŸå·²åˆ é™¤');
  const oldPredictedCount = await DLTRedCombinationsHotWarmColdOptimized.countDocuments({
    target_issue: '25126',  // æ—§æ¨ç®—æœŸï¼ˆç°åœ¨å·²æ˜¯å¼€å¥–æœŸï¼‰
    is_predicted: true
  });
  console.log(`æ—§æ¨ç®—æœŸè®°å½•æ•°: ${oldPredictedCount} (åº”ä¸º0)`);

  console.log('\n========================================');
  console.log('é›†æˆæµ‹è¯•å®Œæˆ');
  console.log('========================================');
}

testIntegration().catch(console.error);
```

---

## å…«ã€æ€§èƒ½è¯„ä¼°

### 8.1 å¢é‡æ›´æ–°æ€§èƒ½

| æ“ä½œ | é¢„æœŸè€—æ—¶ | è¯´æ˜ |
|------|---------|------|
| åˆ é™¤æ—§æ¨ç®—æœŸ | < 50ms | é€šå¸¸åªæœ‰1-2æ¡è®°å½• |
| ç”Ÿæˆæ–°å¼€å¥–æœŸæ•°æ® | 1-2ç§’ | éœ€è¦è®¡ç®—324,632ä¸ªç»„åˆ |
| ç”Ÿæˆæ–°æ¨ç®—æœŸæ•°æ® | 1-2ç§’ | éœ€è¦è®¡ç®—324,632ä¸ªç»„åˆ |
| æ›´æ–°ç¼“å­˜ | < 100ms | æ¸…é™¤å¹¶é‡æ–°åŠ è½½ |
| **æ€»è€—æ—¶** | **2-5ç§’** | å¯æ¥å—çš„æ€§èƒ½ |

### 8.2 æ‰¹é‡é¢„æµ‹æ€§èƒ½å¯¹æ¯”

#### ä¼˜åŒ–å‰ï¼ˆæ— é¢„ç”Ÿæˆï¼‰
```
100æœŸæ‰¹é‡é¢„æµ‹:
- æ¯æœŸåŠ¨æ€ç”Ÿæˆçƒ­æ¸©å†·æ•°æ®: 100æœŸ Ã— 2ç§’ = 200ç§’
- ç­›é€‰å¤„ç†: 50ç§’
- æ€»è€—æ—¶: 250ç§’
```

#### ä¼˜åŒ–åï¼ˆé¢„ç”Ÿæˆ+å¢é‡æ›´æ–°ï¼‰
```
100æœŸæ‰¹é‡é¢„æµ‹:
- é¢„åŠ è½½çƒ­æ¸©å†·æ•°æ®: 1æ¬¡æŸ¥è¯¢ = 2ç§’
- ç­›é€‰å¤„ç†: 50ç§’
- æ€»è€—æ—¶: 52ç§’
- æ€§èƒ½æå‡: 250ç§’ â†’ 52ç§’ (æå‡ 79.2%)
```

---

## ä¹ã€å®æ–½è®¡åˆ’

### 9.1 å®æ–½æ­¥éª¤

#### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹ä¿®æ­£ï¼ˆ2å¤©ï¼‰
- [ ] ä¿®æ”¹ Mongoose Schema æ·»åŠ æ–°å­—æ®µ
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬
- [ ] æ‰§è¡Œè¿ç§»å¹¶éªŒè¯æ•°æ®æ­£ç¡®æ€§
- [ ] åˆ›å»ºä¼˜åŒ–ç´¢å¼•

#### ç¬¬äºŒé˜¶æ®µï¼šå¢é‡æ›´æ–°å®ç°ï¼ˆ3å¤©ï¼‰
- [ ] å®ç° `incrementalUpdateHwcOptimized` å‡½æ•°
- [ ] å®ç° `generateHwcDataForPair` å‡½æ•°
- [ ] é›†æˆåˆ° `importNewIssue` API
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

#### ç¬¬ä¸‰é˜¶æ®µï¼šAPI å’Œå‰ç«¯é›†æˆï¼ˆ2å¤©ï¼‰
- [ ] å®ç°å¢é‡æ›´æ–° API æ¥å£
- [ ] å®ç°çŠ¶æ€æŸ¥è¯¢ API æ¥å£
- [ ] å‰ç«¯æ·»åŠ æ‰‹åŠ¨æ›´æ–°æŒ‰é’®
- [ ] å‰ç«¯æ·»åŠ çŠ¶æ€æŸ¥çœ‹åŠŸèƒ½

#### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¸Šçº¿ï¼ˆ3å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] æ–‡æ¡£æ•´ç†

### 9.2 éªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½éªŒæ”¶
- âœ… æ–°å¼€å¥–æ•°æ®å¯¼å…¥åï¼Œè‡ªåŠ¨åˆ é™¤æ—§æ¨ç®—æœŸæ•°æ®
- âœ… è‡ªåŠ¨ç”Ÿæˆæ–°å¼€å¥–æœŸçš„æœŸå·å¯¹æ•°æ®
- âœ… è‡ªåŠ¨ç”Ÿæˆæ–°æ¨ç®—æœŸçš„æœŸå·å¯¹æ•°æ®
- âœ… æ¨ç®—æœŸ `target_id` ä½¿ç”¨ `latest_ID + 1`ï¼ˆä¸ä½¿ç”¨ 0ï¼‰
- âœ… `is_predicted` å­—æ®µæ­£ç¡®æ ‡è¯†æ¨ç®—æœŸ

#### æ€§èƒ½éªŒæ”¶
- âœ… å¢é‡æ›´æ–°æ€»è€—æ—¶ < 5ç§’
- âœ… 100æœŸæ‰¹é‡é¢„æµ‹è€—æ—¶ < 60ç§’
- âœ… å†…å­˜å ç”¨ < 500MB

#### æ•°æ®ä¸€è‡´æ€§éªŒæ”¶
- âœ… è¿ç§»åæ—  `target_id = 0` çš„è®°å½•
- âœ… æ¨ç®—æœŸåªæœ‰1æ¡è®°å½•
- âœ… å·²å¼€å¥–æœŸ `target_id` ä¸æ•°æ®åº“ ID ä¸€è‡´
- âœ… æ¨ç®—æœŸ `target_id` = æœ€æ–°æ•°æ®åº“ ID + 1

---

## åã€å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ `target_id = 0` è¡¨ç¤ºæ¨ç®—æœŸï¼Ÿ
**A**: ä½¿ç”¨ 0 ä½œä¸ºç‰¹æ®Šå€¼ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š
1. æ•°æ®ä¸ä¸€è‡´ï¼šID åº”è¯¥ä¿æŒè¿ç»­æ€§
2. æŸ¥è¯¢å¤æ‚ï¼šéœ€è¦é¢å¤–åˆ¤æ–­ 0 çš„ç‰¹æ®Šå«ä¹‰
3. ç»´æŠ¤å›°éš¾ï¼šå®¹æ˜“äº§ç”Ÿé€»è¾‘ bug

ä½¿ç”¨ `is_predicted` å­—æ®µ + è¿ç»­ ID çš„è®¾è®¡æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ã€‚

### Q2: æ¨ç®—æœŸæ•°æ®ä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ é™¤ï¼Ÿ
**A**: ä»…åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹åˆ é™¤ï¼š
1. æ–°å¼€å¥–æ•°æ®å¯¼å…¥æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ—§æ¨ç®—æœŸï¼ˆ`incrementalUpdateHwcOptimized`ï¼‰
2. æ‰‹åŠ¨è§¦å‘å…¨é‡é‡å»ºæ—¶ï¼ˆ`rebuildHwcOptimizedTable`ï¼‰

### Q3: å¦‚æœè¿ç»­å¯¼å…¥å¤šæœŸæ•°æ®ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
**A**: æ¯æ¬¡å¯¼å…¥éƒ½ä¼šè§¦å‘å¢é‡æ›´æ–°ï¼š
```
å¯¼å…¥æœŸå· 25125:
  - åˆ é™¤æ—§æ¨ç®—æœŸï¼ˆ25124â†’25125ï¼‰
  - ç”Ÿæˆæ–°å¼€å¥–æœŸï¼ˆ25124â†’25125ï¼‰
  - ç”Ÿæˆæ–°æ¨ç®—æœŸï¼ˆ25125â†’25126ï¼‰

å¯¼å…¥æœŸå· 25126:
  - åˆ é™¤æ—§æ¨ç®—æœŸï¼ˆ25125â†’25126ï¼‰
  - ç”Ÿæˆæ–°å¼€å¥–æœŸï¼ˆ25125â†’25126ï¼‰
  - ç”Ÿæˆæ–°æ¨ç®—æœŸï¼ˆ25126â†’25127ï¼‰
```

### Q4: å¦‚ä½•æ‰‹åŠ¨è§¦å‘å¢é‡æ›´æ–°ï¼Ÿ
**A**: ä¸‰ç§æ–¹å¼ï¼š
1. å‰ç«¯ç‚¹å‡»"æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨"æŒ‰é’®
2. è°ƒç”¨ API: `POST /api/dlt/hwc-optimized/incremental-update`
3. è¿è¡Œè„šæœ¬: `node update-hwc-optimized.js`

### Q5: å¢é‡æ›´æ–°å¤±è´¥å¦‚ä½•å›æ»šï¼Ÿ
**A**: å¢é‡æ›´æ–°ä½¿ç”¨ MongoDB äº‹åŠ¡ï¼Œå¤±è´¥ä¼šè‡ªåŠ¨å›æ»šï¼š
```javascript
try {
  await session.startTransaction();
  // ... æ‰§è¡Œæ›´æ–°
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();  // è‡ªåŠ¨å›æ»š
  throw error;
}
```

---

## åä¸€ã€æ€»ç»“

### 11.1 æ ¸å¿ƒè®¾è®¡è¦ç‚¹

1. **`is_predicted` å­—æ®µ**ï¼šä½œä¸ºæ¨ç®—æœŸçš„ä¸»è¦æ ‡è¯†ç¬¦
2. **è¿ç»­ ID è®¾è®¡**ï¼šæ¨ç®—æœŸä½¿ç”¨ `latest_ID + 1`ï¼Œé¿å…ç‰¹æ®Šå€¼ 0
3. **ä¸‰æ­¥æ›´æ–°æµç¨‹**ï¼šåˆ é™¤æ—§æ¨ç®—æœŸ â†’ ç”Ÿæˆæ–°å¼€å¥–æœŸ â†’ ç”Ÿæˆæ–°æ¨ç®—æœŸ
4. **å¤šé€”å¾„ç”Ÿæˆ**ï¼šæ”¯æŒä¸€é”®æ›´æ–°ã€è‡ªåŠ¨å¯¼å…¥ã€å®šæ—¶ä»»åŠ¡
5. **äº‹åŠ¡ä¿æŠ¤**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œæ”¯æŒè‡ªåŠ¨å›æ»š

### 11.2 ä¸åŸæ–¹æ¡ˆçš„å·®å¼‚

| é¡¹ç›® | åŸæ–¹æ¡ˆ | æœ€ç»ˆç‰ˆæ–¹æ¡ˆ |
|------|--------|-----------|
| æ¨ç®—æœŸæ ‡è¯† | `target_id = 0` | `is_predicted = true` |
| æ¨ç®—æœŸ ID | 0 | `latest_ID + 1` |
| ç”Ÿæˆæµç¨‹ | ä»…ç”Ÿæˆæ–°æ•°æ® | åˆ é™¤æ—§æ¨ç®—æœŸ + ç”Ÿæˆæ–°æ•°æ® |
| æ•°æ®ä¸€è‡´æ€§ | å¯èƒ½å­˜åœ¨å¤šæ¡æ¨ç®—æœŸ | å§‹ç»ˆåªæœ‰1æ¡æ¨ç®—æœŸ |

### 11.3 ä¼˜åŠ¿æ€»ç»“

âœ… **é€»è¾‘æ¸…æ™°**ï¼š`is_predicted` å­—æ®µæ˜ç¡®æ ‡è¯†æ¨ç®—æœŸ
âœ… **æ•°æ®ä¸€è‡´**ï¼šID ä¿æŒè¿ç»­ï¼Œæ— ç‰¹æ®Šå€¼
âœ… **è‡ªåŠ¨åŒ–**ï¼šæ–°æ•°æ®å¯¼å…¥æ—¶è‡ªåŠ¨æ›´æ–°
âœ… **å¯é æ€§**ï¼šäº‹åŠ¡ä¿æŠ¤ï¼Œæ”¯æŒå›æ»š
âœ… **æ˜“ç»´æŠ¤**ï¼šä»£ç é€»è¾‘ç®€æ´ï¼Œæ˜“äºç†è§£

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…ç”¨æˆ·ç¡®è®¤
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·ç¡®è®¤åå¼€å§‹å®æ–½
**é¢„è®¡å·¥æœŸ**: 10ä¸ªå·¥ä½œæ—¥
