# 组合特征表与statistics字段详细说明

## 一、组合特征表 (hit_dlt_combofeatures / DLTComboFeatures)

### 1.1 数据结构

```javascript
{
    ID: Number,           // 对应hit_dlts的ID
    Issue: String,        // 期号
    combo_2: [String],    // 2码组合 C(5,2)=10个，如 ["01-05", "01-12", ...]
    combo_3: [String],    // 3码组合 C(5,3)=10个，如 ["01-05-12", ...]
    combo_4: [String],    // 4码组合 C(5,4)=5个，如 ["01-05-12-18", ...]
}
```

### 1.2 数据示例

以期号25137开奖号码 [7,8,9,11,22] 为例：
```
combo_2: ["07-08", "07-09", "07-11", "07-22", "08-09", "08-11", "08-22", "09-11", "09-22", "11-22"]
combo_3: ["07-08-09", "07-08-11", "07-08-22", "07-09-11", "07-09-22", "07-11-22", "08-09-11", "08-09-22", "08-11-22", "09-11-22"]
combo_4: ["07-08-09-11", "07-08-09-22", "07-08-11-22", "07-09-11-22", "08-09-11-22"]
```

### 1.3 主要用途：同出排除功能 (coOccurrencePerBall)

**功能说明**：
排除在历史开奖中与某号码"同期出现"过的组合。

**使用场景**：
假设用户设置"排除每个红球最近5次出现时的同出组合"：
1. 系统查找红球07最近5次出现的期号
2. 获取这5期的开奖号码组合特征
3. 如果待预测组合包含这些同出特征，则排除

**代码位置**：
- 加载缓存：`src/server/server.js:11710-11715`
- 同出排除过滤：`src/server/server.js:13252-13300`

**配置项**：
```javascript
exclude_conditions.coOccurrencePerBall = {
    enabled: true,
    periods: 5,        // 分析每个红球最近N次出现
    combo2: true,      // 排除2码同出
    combo3: false,     // 排除3码同出
    combo4: false      // 排除4码同出
}
```

### 1.4 是否需要增量更新？

| 考虑因素 | 分析 |
|---------|------|
| 数据变化频率 | 每期新增1条记录 |
| 依赖关系 | 只依赖hit_dlts |
| 计算复杂度 | 低（纯组合计算，无历史依赖） |
| 使用频率 | 仅在启用同出排除时使用 |

**结论**：
- ✅ **可以增量更新**
- ⚠️ **优先级低**：只有启用同出排除功能时才需要
- 即使缺失新期号数据，也只影响同出排除的准确性，不影响核心预测功能

---

## 二、statistics字段 (hit_dlts.statistics)

### 2.1 数据结构

存储在hit_dlts主表的每条记录中：
```javascript
{
    statistics: {
        frontSum: Number,           // 前区和值 (35-165)
        frontSpan: Number,          // 前区跨度 (4-34)
        frontHotWarmColdRatio: String, // 热温冷比 "3:1:1"
        frontZoneRatio: String,     // 区间比 "2:2:1" (1-12,13-24,25-35)
        frontOddEvenRatio: String,  // 奇偶比 "3:2"
        frontAcValue: Number,       // AC值 (0-6)
        backSum: Number,            // 后区和值 (3-23)
        backOddEvenRatio: String,   // 后区奇偶比 "1:1"
        consecutiveCount: Number,   // 连号组数 (0-4)
        repeatCount: Number         // 重号数（与上一期相同的号码数）
    }
}
```

### 2.2 数据示例

期号25137 [7,8,9,11,22] + [5,11]：
```javascript
{
    frontSum: 57,              // 7+8+9+11+22=57
    frontSpan: 15,             // 22-7=15
    frontHotWarmColdRatio: "2:2:1",  // 基于上一期遗漏值计算
    frontZoneRatio: "4:0:1",   // 4个在1-12区,0个在13-24区,1个在25-35区
    frontOddEvenRatio: "3:2",  // 3奇2偶
    frontAcValue: 5,           // AC值
    backSum: 16,               // 5+11=16
    backOddEvenRatio: "1:1",   // 1奇1偶
    consecutiveCount: 2,       // 2组连号(7-8-9, 其他无)
    repeatCount: 1             // 与上一期相比的重号数
}
```

### 2.3 主要用途

#### 用途1：历史走势图查询接口
**代码位置**：`src/server/server.js:3339-3370`

前端查询历史数据时，直接读取预计算的statistics，避免实时计算：
```javascript
// 优先使用预处理的statistics字段
if (mainRecord && mainRecord.statistics && mainRecord.statistics.frontSum) {
    statistics = {
        frontSum: mainRecord.statistics.frontSum,
        frontSpan: mainRecord.statistics.frontSpan,
        frontHotWarmColdRatio: mainRecord.statistics.frontHotWarmColdRatio,
        // ...
    };
}
```

#### 用途2：提升查询性能
无需每次请求都实时计算和值、跨度、奇偶比等，直接从数据库读取。

### 2.4 是否需要增量更新？

| 考虑因素 | 分析 |
|---------|------|
| 数据变化频率 | 每期新增1条记录 |
| 依赖关系 | 依赖hit_dlts + 遗漏值表（热温冷比计算） |
| 计算复杂度 | 中等（需要上一期遗漏值） |
| 使用频率 | 每次查询历史走势图时使用 |

**结论**：
- ✅ **可以增量更新**
- ⚠️ **依赖遗漏值表**：frontHotWarmColdRatio 需要基于上一期遗漏值计算
- ⚠️ **repeatCount 依赖上一期数据**

---

## 三、更新顺序依赖分析

```
hit_dlts (开奖数据) ──────────────────────────────────────┐
    │                                                     │
    ▼                                                     │
遗漏值表 ─────────────────────────────────────────┐       │
    │                                             │       │
    ▼                                             ▼       ▼
热温冷优化表 ◄────────────────────────────── statistics字段
    │
    └──────────────────────────────────────────► 组合特征表 (无依赖)
```

### 更新顺序

| 顺序 | 数据表 | 依赖 |
|------|--------|------|
| 1 | hit_dlts | 无（数据源） |
| 2 | 遗漏值表 | hit_dlts |
| 3 | statistics字段 | hit_dlts + 遗漏值表 |
| 4 | 热温冷优化表 | 遗漏值表 |
| 5 | 组合特征表 | hit_dlts（无历史依赖，可并行） |

---

## 四、建议方案

### 方案A：最小增量更新（推荐）

只更新**核心链路**：
```
遗漏值表 → 热温冷优化表
```

**优点**：
- 速度最快
- 覆盖最常用的预测功能

**缺点**：
- statistics字段和组合特征表不会更新
- 历史走势图查询新期号时可能需要实时计算

### 方案B：完整增量更新

更新**所有衍生表**：
```
遗漏值表 → statistics字段 → 热温冷优化表 → 组合特征表
```

**优点**：
- 数据完整一致
- 所有功能都能正常使用

**缺点**：
- 耗时稍长

### 方案C：智能增量更新（最优）

```
步骤1: 增量更新遗漏值表 ───────────────────┐
                                          │
步骤2: 并行执行 ──┬─ 增量更新statistics字段 │
                 │                        │
                 └─ 增量更新组合特征表     │
                                          ▼
步骤3: 增量更新热温冷优化表（等待步骤1完成）
```

**优点**：
- 数据完整
- 并行执行提高效率

---

## 五、结论

请确认您希望采用哪个方案：

| 方案 | 更新内容 | 预计耗时 | 数据完整性 |
|------|----------|----------|-----------|
| A | 遗漏值 + 热温冷 | ~30秒 | 核心功能完整 |
| B | 全部4个表（串行） | ~60秒 | 完整 |
| C | 全部4个表（并行优化） | ~40秒 | 完整 |

**个人建议**：采用**方案C（智能增量更新）**，兼顾完整性和效率。
