# å¤§ä¹é€çƒ­æ¸©å†·æ­£é€‰æ‰¹é‡é¢„æµ‹ - ç³»ç»Ÿé—®é¢˜è¯Šæ–­å’Œä¿®å¤å»ºè®®

**æµ‹è¯•æ—¥æœŸ**: 2025-11-04
**çŠ¶æ€**: ğŸ”´ å‘ç°ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤
**ä¸¥é‡ç¨‹åº¦**: P0 (é˜»å¡æ€§é—®é¢˜)

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜1: æ•°æ®æ¨¡å‹å­—æ®µå‘½åä¸¥é‡ä¸ä¸€è‡´ âš ï¸ **P0**

**ç°è±¡**:
- ä»»åŠ¡è¡¨ (`hit_dlt_hwcpositivepredictiontasks`) çš„ `base_issue` å’Œ `target_issue` å­—æ®µä¸º **undefined**
- ç»“æœè¡¨ (`hit_dlt_hwcpositivepredictiontaskresults`) ç¼ºå¤± `red_balls` å’Œ `blue_balls` å­—æ®µ
- æ‰€æœ‰å‘½ä¸­ç»Ÿè®¡å­—æ®µ (`hit_count`, `hit_issues`, `prize_level`, `prize_amount`) æœªè¢«ä¿å­˜

**æ ¹æœ¬åŸå› **:
- Mongoose Schema å­—æ®µåä¸å®é™…ä¿å­˜çš„å­—æ®µåä¸åŒ¹é…
- ä»»åŠ¡åˆ›å»ºæ—¶ä½¿ç”¨çš„å­—æ®µåä¸Schemaå®šä¹‰ä¸ä¸€è‡´
- ç»“æœä¿å­˜é€»è¾‘ä¸­æœªåŒ…å«çƒå·å’Œå‘½ä¸­ç»Ÿè®¡å­—æ®µ

**å½±å“**:
- âŒ æ— æ³•è¿›è¡Œå‘½ä¸­åˆ†æï¼ˆå› ä¸ºç›®æ ‡æœŸå·æœªçŸ¥ï¼‰
- âŒ æ— æ³•æŸ¥çœ‹ä¿ç•™çš„ç»„åˆçƒå·
- âŒ æ— æ³•å±•ç¤ºä¸­å¥–ç»Ÿè®¡
- âŒ åŠŸèƒ½åŸºæœ¬ä¸å¯ç”¨

---

### é—®é¢˜2: çƒ­æ¸©å†·ä¼˜åŒ–è¡¨å·²æ›´æ–° âœ…

**éªŒè¯ç»“æœ**:
- âœ… å·²è¦†ç›–åˆ°æœ€æ–°æœŸå· (25123 â†’ 25124)
- âœ… æœ€è¿‘10æœŸçš„ä¼˜åŒ–æ•°æ®å®Œæ•´
- âœ… æ•°æ®ç»“æ„æ­£ç¡® (æŒ‰æ¯”ä¾‹åˆ†ç»„çš„å¯¹è±¡ç»“æ„)

**ç»“è®º**: ä¼˜åŒ–è¡¨åŠŸèƒ½æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤ã€‚

---

### é—®é¢˜3: é…å¯¹æ¨¡å¼å­—æ®µæœªè®°å½• âš ï¸ **P0**

**ç°è±¡**:
- æ‰€æœ‰ä»»åŠ¡çš„ `pairing_mode` å­—æ®µä¸º **undefined**
- æ— æ³•åŒºåˆ† default/unlimited/truly-unlimited æ¨¡å¼

**æ ¹æœ¬åŸå› **:
- ä»»åŠ¡åˆ›å»ºAPIæœªæ­£ç¡®æ¥æ”¶æˆ–ä¿å­˜ `pairing_mode` å‚æ•°
- Mongoose Schema å¯èƒ½å­—æ®µåä¸åŒ¹é…

---

## ğŸ“‹ è¯¦ç»†è¯Šæ–­æŠ¥å‘Š

### 1. ä»»åŠ¡è¡¨å­—æ®µæ£€æŸ¥

```javascript
// å®é™…æ•°æ®æ ·æœ¬
{
  "_id": "690abb16e111d9404b660a83",
  "task_name": "çƒ­æ¸©å†·æ­£é€‰_2025-11-05",
  "base_issue": undefined,        // âŒ ç¼ºå¤±
  "target_issue": undefined,      // âŒ ç¼ºå¤±
  "pairing_mode": undefined,      // âŒ ç¼ºå¤±
  "status": "completed",
  "retained_count": 0,
  "created_at": "..."
}
```

**é—®é¢˜**: ä¸‰ä¸ªå…³é”®å­—æ®µå…¨éƒ¨ä¸º undefinedï¼Œè¯´æ˜ä¿å­˜æ—¶å­—æ®µåå®Œå…¨ä¸åŒ¹é…ã€‚

---

### 2. ç»“æœè¡¨å­—æ®µæ£€æŸ¥

```javascript
// å®é™…æ•°æ®æ ·æœ¬
{
  "_id": "...",
  "task_id": "hwc-pos-20251102-2jh",
  "red_balls": undefined,         // âŒ ç¼ºå¤±
  "blue_balls": undefined,        // âŒ ç¼ºå¤±
  "hit_count": 0,                // âš ï¸  é»˜è®¤å€¼
  "hit_issues": {},              // âš ï¸  ç©ºå¯¹è±¡
  "prize_level": undefined,       // âŒ ç¼ºå¤±
  "prize_amount": undefined       // âŒ ç¼ºå¤±
}
```

**é—®é¢˜**: çƒå·å­—æ®µå’Œå®Œæ•´çš„å‘½ä¸­ç»Ÿè®¡å­—æ®µå…¨éƒ¨ç¼ºå¤±ã€‚

---

### 3. çƒ­æ¸©å†·ä¼˜åŒ–è¡¨çŠ¶æ€ âœ…

```javascript
{
  "base_issue": "25123",
  "target_issue": "25124",
  "hot_warm_cold_data": {
    "3:1:1": [53856ä¸ªç»„åˆID],
    "2:1:2": [50490ä¸ªç»„åˆID],
    // ... 21ç§çƒ­æ¸©å†·æ¯”ä¾‹
  },
  "total_combinations": 324632
}
```

**ç»“è®º**: ç»“æ„æ­£ç¡®ï¼Œæ•°æ®å®Œæ•´ï¼ŒåŠŸèƒ½æ­£å¸¸ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¼˜å…ˆçº§ P0 - ç«‹å³ä¿®å¤ (é˜»å¡æ€§é—®é¢˜)

#### ä¿®å¤1: ç»Ÿä¸€ä»»åŠ¡è¡¨å­—æ®µå‘½å

**ä½ç½®**: `src/server/server.js` (Mongoose Schemaå®šä¹‰)

**éœ€è¦æ£€æŸ¥çš„Schema**:
```javascript
// æŸ¥æ‰¾ HwcPositivePredictionTask Schema
// ç¡®è®¤å­—æ®µåæ˜¯å¦ä¸º:
{
  baseIssue vs base_issue,
  targetIssue vs target_issue,
  pairingMode vs pairing_mode
}
```

**ä¿®å¤æ–¹æ³•**:
1. æŸ¥æ‰¾Schemaå®šä¹‰ä¸­çš„å­—æ®µåï¼ˆå¯èƒ½æ˜¯é©¼å³°å‘½åï¼‰
2. ç»Ÿä¸€ä¸ºä¸‹åˆ’çº¿å‘½åï¼ˆsnake_caseï¼‰
3. æˆ–ä¿®æ”¹ä¿å­˜é€»è¾‘ä½¿ç”¨é©¼å³°å‘½åï¼ˆcamelCaseï¼‰

**éªŒè¯**:
```bash
# åˆ›å»ºæµ‹è¯•ä»»åŠ¡
curl -X POST http://localhost:3003/api/dlt/hwc-positive-task/create \
  -H "Content-Type: application/json" \
  -d '{
    "task_name": "æµ‹è¯•ä»»åŠ¡",
    "base_issue": "25123",
    "target_issue": "25124",
    "pairing_mode": "default",
    "exclusion_conditions": {}
  }'

# æŸ¥è¯¢ä»»åŠ¡å¹¶æ£€æŸ¥å­—æ®µæ˜¯å¦æ­£ç¡®ä¿å­˜
```

---

#### ä¿®å¤2: ç¡®ä¿ç»“æœè¡¨ä¿å­˜å®Œæ•´å­—æ®µ

**ä½ç½®**: `src/server/server.js` (ç»“æœä¿å­˜é€»è¾‘)

**éœ€è¦ä¿®æ”¹**:
1. **ä¿å­˜çƒå·**: åœ¨ç»“æœä¿å­˜æ—¶åŒ…å« `red_balls` å’Œ `blue_balls`
2. **æ‰§è¡Œå‘½ä¸­åˆ†æ**: è°ƒç”¨å‘½ä¸­è®¡ç®—å‡½æ•°
3. **ä¿å­˜å‘½ä¸­ç»Ÿè®¡**: åŒ…å« `hit_count`, `hit_issues`, `prize_level`, `prize_amount`

**ä¼ªä»£ç **:
```javascript
// ç»“æœä¿å­˜é€»è¾‘ï¼ˆStreamBatchPredictoræˆ–processHwcPositiveTaskä¸­ï¼‰
const result = {
  task_id: taskId,
  red_balls: redBallsArray.join(','),       // æ·»åŠ 
  blue_balls: blueBallsArray.join(','),     // æ·»åŠ 
  combination_id: comboId,
  // ... å…¶ä»–ç‰¹å¾å­—æ®µ
};

// æ‰§è¡Œå‘½ä¸­åˆ†æï¼ˆå¦‚æœç›®æ ‡æœŸå·å·²å¼€å¥–ï¼‰
const hitAnalysis = await calculateHitAnalysis(
  redBallsArray,
  blueBallsArray,
  targetIssues  // ç›®æ ‡æœŸå·èŒƒå›´
);

result.hit_count = hitAnalysis.hit_count;
result.hit_issues = hitAnalysis.hit_issues;
result.prize_level = hitAnalysis.prize_level;
result.prize_amount = hitAnalysis.prize_amount;

await resultModel.create(result);
```

---

#### ä¿®å¤3: ç¡®ä¿ pairing_mode æ­£ç¡®ä¿å­˜

**ä½ç½®**: `src/server/server.js` (ä»»åŠ¡åˆ›å»ºAPI)

**æ£€æŸ¥ç‚¹**:
1. APIæ¥æ”¶çš„å‚æ•°å
2. Schemaå­—æ®µå
3. ä¿å­˜é€»è¾‘ä¸­çš„å­—æ®µæ˜ å°„

**å¯èƒ½çš„é—®é¢˜**:
```javascript
// é”™è¯¯ç¤ºä¾‹
const task = {
  taskName: req.body.task_name,    // âŒ å­—æ®µåä¸åŒ¹é…
  pairingMode: req.body.mode       // âŒ å‚æ•°åä¸åŒ¹é…
};

// æ­£ç¡®ç¤ºä¾‹
const task = {
  task_name: req.body.task_name,   // âœ… ä¸€è‡´
  pairing_mode: req.body.pairing_mode  // âœ… ä¸€è‡´
};
```

---

### ä¼˜å…ˆçº§ P1 - æœ¬å‘¨å®Œæˆ (åŠŸèƒ½å®Œå–„)

#### ä¿®å¤4: ç»Ÿä¸€å­—æ®µå‘½åè§„èŒƒ

**å…¨å±€è§„èŒƒ**:
- æ•°æ®åº“å­—æ®µï¼šä¸€å¾‹ä½¿ç”¨ **snake_case** (ä¸‹åˆ’çº¿)
- JavaScriptå˜é‡ï¼šä¸€å¾‹ä½¿ç”¨ **camelCase** (é©¼å³°)
- Mongoose Schema: ä½¿ç”¨ snake_case ä½†éœ€æ˜ç¡®é…ç½®

**éœ€è¦ç»Ÿä¸€çš„å­—æ®µ**:
| åŠŸèƒ½ | å½“å‰æ··ä¹± | ç»Ÿä¸€ä¸º |
|------|---------|--------|
| æœŸå·å­—æ®µ | `Issue` vs `issue` | `Issue` (å¤§å†™ï¼Œå› ä¸ºæ•°æ®åº“å·²ç”¨) |
| ä»»åŠ¡å­—æ®µ | `base_issue` vs `baseIssue` | `base_issue` |
| ç»“æœå­—æ®µ | `red_balls` vs `redBalls` | `red_balls` |

---

#### ä¿®å¤5: æ·»åŠ æ•°æ®éªŒè¯

**ä½ç½®**: APIå…¥å£

**éªŒè¯å†…å®¹**:
1. æœŸå·æ ¼å¼éªŒè¯ (5ä½æ•°å­—)
2. é…å¯¹æ¨¡å¼æšä¸¾éªŒè¯ (default/unlimited/truly-unlimited)
3. æœŸå·èŒƒå›´éªŒè¯ (åŸºå‡†æœŸå· < ç›®æ ‡æœŸå·)
4. å†å²æ•°æ®å¯ç”¨æ€§éªŒè¯

**ç¤ºä¾‹**:
```javascript
// APIå…¥å£éªŒè¯
const validateTaskParams = (params) => {
  if (!params.base_issue || !params.target_issue) {
    throw new Error('ç¼ºå°‘å¿…éœ€çš„æœŸå·å‚æ•°');
  }

  if (!/^\d{5}$/.test(params.base_issue)) {
    throw new Error('åŸºå‡†æœŸå·æ ¼å¼é”™è¯¯');
  }

  const validModes = ['default', 'unlimited', 'truly-unlimited'];
  if (!validModes.includes(params.pairing_mode)) {
    throw new Error('æ— æ•ˆçš„é…å¯¹æ¨¡å¼');
  }

  return true;
};
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### é˜¶æ®µ1: å­—æ®µä¿®å¤éªŒè¯ (P0)

1. **ä¿®å¤ä»»åŠ¡å­—æ®µåæµ‹è¯•**:
   ```bash
   # åˆ›å»ºä»»åŠ¡
   node test-task-creation.js
   # æ£€æŸ¥å­—æ®µæ˜¯å¦æ­£ç¡®ä¿å­˜
   node diagnose-hit-statistics-issue.js
   ```

2. **ä¿®å¤ç»“æœå­—æ®µåæµ‹è¯•**:
   ```bash
   # è¿è¡Œä¸€ä¸ªå®Œæ•´ä»»åŠ¡
   # æ£€æŸ¥ç»“æœæ˜¯å¦åŒ…å«çƒå·å’Œå‘½ä¸­ç»Ÿè®¡
   ```

3. **ä¿®å¤é…å¯¹æ¨¡å¼åæµ‹è¯•**:
   ```bash
   # åˆ†åˆ«åˆ›å»ºä¸‰ç§æ¨¡å¼çš„ä»»åŠ¡
   # éªŒè¯ pairing_mode å­—æ®µæ­£ç¡®ä¿å­˜
   ```

### é˜¶æ®µ2: åŠŸèƒ½é›†æˆæµ‹è¯• (P1)

4. **ç«¯åˆ°ç«¯æµ‹è¯•**:
   - åˆ›å»ºä»»åŠ¡ â†’ å¤„ç† â†’ æŸ¥çœ‹ç»“æœ â†’ å¯¼å‡ºExcel
   - éªŒè¯å…¨æµç¨‹æ•°æ®å®Œæ•´æ€§

5. **ä¸‰ç§é…å¯¹æ¨¡å¼æµ‹è¯•**:
   - default: å›ºå®šé…å¯¹
   - unlimited: è‡ªå®šä¹‰é…å¯¹
   - truly-unlimited: å®Œå…¨ç¬›å¡å°”ç§¯

6. **å‘½ä¸­ç»Ÿè®¡æµ‹è¯•**:
   - ä½¿ç”¨å·²å¼€å¥–æœŸå·åˆ›å»ºä»»åŠ¡
   - éªŒè¯å‘½ä¸­è®¡ç®—å‡†ç¡®æ€§
   - éªŒè¯å¥–çº§åˆ¤æ–­æ­£ç¡®æ€§

---

## ğŸ“Š é¢„æœŸä¿®å¤åçš„æ•ˆæœ

### ä»»åŠ¡è¡¨ (ä¿®å¤å)

```javascript
{
  "_id": "...",
  "task_name": "çƒ­æ¸©å†·æ­£é€‰_2025-11-05",
  "base_issue": "25123",         // âœ… æ­£ç¡®
  "target_issue": "25124",       // âœ… æ­£ç¡®
  "pairing_mode": "default",     // âœ… æ­£ç¡®
  "status": "completed",
  "retained_count": 117,
  "created_at": "..."
}
```

### ç»“æœè¡¨ (ä¿®å¤å)

```javascript
{
  "_id": "...",
  "task_id": "...",
  "red_balls": "2,3,8,13,21",    // âœ… æ­£ç¡®
  "blue_balls": "7,12",          // âœ… æ­£ç¡®
  "hit_count": 5,                // âœ… æœ‰å‘½ä¸­
  "hit_issues": {
    "25124": {
      "red_hit": 5,
      "blue_hit": 0,
      "prize": "ä¸‰ç­‰å¥–"
    }
  },
  "prize_level": "ä¸‰ç­‰å¥–",        // âœ… æ­£ç¡®
  "prize_amount": 10000          // âœ… æ­£ç¡®
}
```

---

## ğŸ¯ å®æ–½æ­¥éª¤

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)

1. âœ… ã€å·²å®Œæˆã€‘è¯Šæ–­é—®é¢˜æ ¹æœ¬åŸå› 
2. â³ ã€å¾…æ‰§è¡Œã€‘æŸ¥æ‰¾å¹¶ä¿®å¤ä»»åŠ¡è¡¨Schemaå­—æ®µå‘½å
3. â³ ã€å¾…æ‰§è¡Œã€‘æŸ¥æ‰¾å¹¶ä¿®å¤ç»“æœä¿å­˜é€»è¾‘
4. â³ ã€å¾…æ‰§è¡Œã€‘æ·»åŠ å­—æ®µéªŒè¯æµ‹è¯•è„šæœ¬

### æœ¬å‘¨æ‰§è¡Œ

5. â³ ç»Ÿä¸€æ‰€æœ‰å­—æ®µå‘½åè§„èŒƒ
6. â³ æ·»åŠ APIå‚æ•°éªŒè¯
7. â³ è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
8. â³ æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Š

---

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### è¯Šæ–­è„šæœ¬ (å·²ç”Ÿæˆ)
- `diagnose-hit-statistics-issue.js` - å‘½ä¸­ç»Ÿè®¡è¯Šæ–­
- `analyze-hwc-optimized-structure.js` - ä¼˜åŒ–è¡¨ç»“æ„åˆ†æ
- `complete-system-test.js` - ç»¼åˆç³»ç»Ÿæµ‹è¯•
- `check-real-database.js` - æ•°æ®åº“çŠ¶æ€æ£€æŸ¥

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
- `src/server/server.js` - ä¸»è¦ä¿®å¤ä½ç½®
  - Mongoose Schemaå®šä¹‰ (çº¦è¡Œ 200-500)
  - ä»»åŠ¡åˆ›å»ºAPI (çº¦è¡Œ 5000-5500)
  - ç»“æœä¿å­˜é€»è¾‘ (çº¦è¡Œ 6000-8000)
  - å‘½ä¸­åˆ†æå‡½æ•° (çº¦è¡Œ 12000-12300)

### æ–‡æ¡£
- `çƒ­æ¸©å†·æ­£é€‰æ‰¹é‡é¢„æµ‹-å®Œæ•´æµ‹è¯•æŠ¥å‘Š.md` - å®Œæ•´æµ‹è¯•æŠ¥å‘Š
- `CLAUDE.md` - é¡¹ç›®æ–‡æ¡£ (éœ€è¦æ›´æ–°å­—æ®µå‘½åè§„èŒƒ)

---

## âš¡ å¿«é€Ÿä¿®å¤æŒ‡å—

### å¦‚ä½•å¿«é€Ÿå®šä½é—®é¢˜

1. **æŸ¥æ‰¾Schemaå®šä¹‰**:
   ```bash
   grep -n "HwcPositivePredictionTask" src/server/server.js
   grep -n "HwcPositivePredictionTaskResult" src/server/server.js
   ```

2. **æŸ¥æ‰¾ä»»åŠ¡åˆ›å»ºAPI**:
   ```bash
   grep -n "api/dlt/hwc-positive-task/create" src/server/server.js
   ```

3. **æŸ¥æ‰¾ç»“æœä¿å­˜é€»è¾‘**:
   ```bash
   grep -n "HwcPositivePredictionTaskResult.create" src/server/server.js
   ```

### å¦‚ä½•éªŒè¯ä¿®å¤

```bash
# 1. é‡å¯åº”ç”¨
npm start

# 2. åˆ›å»ºæµ‹è¯•ä»»åŠ¡ (é€šè¿‡UIæˆ–API)

# 3. è¿è¡Œè¯Šæ–­è„šæœ¬
node diagnose-hit-statistics-issue.js

# 4. æ£€æŸ¥è¾“å‡ºæ˜¯å¦æ˜¾ç¤ºå­—æ®µæ­£ç¡®
```

---

## ğŸ†˜ å¦‚æœéœ€è¦å¸®åŠ©

**é—®é¢˜æ¸…å•**:
1. Schemaå­—æ®µåä¸å®é™…ä¿å­˜å­—æ®µåä¸åŒ¹é…
2. ç»“æœä¿å­˜æ—¶æœªåŒ…å«çƒå·å’Œå‘½ä¸­ç»Ÿè®¡å­—æ®µ
3. é…å¯¹æ¨¡å¼å­—æ®µæœªä¿å­˜

**å»ºè®®çš„ä¿®å¤é¡ºåº**:
1. å…ˆä¿®å¤ä»»åŠ¡è¡¨å­—æ®µï¼ˆbase_issue, target_issueï¼‰
2. å†ä¿®å¤ç»“æœè¡¨å­—æ®µï¼ˆred_balls, blue_ballsï¼‰
3. æœ€åç¡®ä¿å‘½ä¸­åˆ†æåŠŸèƒ½æ‰§è¡Œ

**é¢„è®¡ä¿®å¤æ—¶é—´**:
- P0é—®é¢˜: 2-4å°æ—¶
- P1é—®é¢˜: 1-2å¤©
- å…¨é¢æµ‹è¯•: 1å¤©

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-04
**åº”ç”¨çŠ¶æ€**: ğŸŸ¢ è¿è¡Œä¸­ (ç«¯å£3003)
**æ•°æ®åº“çŠ¶æ€**: ğŸŸ¢ è¿æ¥æ­£å¸¸
**ä¸‹ä¸€æ­¥**: ä¿®å¤P0å­—æ®µå‘½åé—®é¢˜
