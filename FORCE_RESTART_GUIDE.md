# 🚨 应用强制重启指南

## ⚠️ 问题确认

修复的代码已经在文件中（verified），但应用仍在使用旧代码（缓存），导致：
- ✅ 代码文件：包含修复（await Promise.all）
- ❌ 运行中的应用：仍使用旧代码
- ❌ 结果：任务完成但没有保存排除详情

---

## ✅ 完全重启步骤

### 📝 步骤1：关闭应用窗口

**手动操作**：
1. 点击应用窗口的 ❌ 关闭按钮
2. 确保所有应用窗口都关闭

### 📝 步骤2：强制终止所有进程

在命令行运行：
```bash
taskkill /F /IM electron.exe /T
taskkill /F /IM node.exe /T
```

### 📝 步骤3：确认进程已终止

运行：
```bash
tasklist | findstr /i "electron node"
```

**预期结果**：应该没有任何输出（进程都已终止）

### 📝 步骤4：等待3秒

```bash
timeout /t 3
```

### 📝 步骤5：重新启动应用

```bash
npm start
```

### 📝 步骤6：验证应用启动成功

观察控制台输出，应该看到：
```
✅ 已连接到本地MongoDB数据库
🧪 开始测试奖项计算逻辑...
✅ 测试完成: 通过16个, 失败0个
🚀 Express服务器运行在: http://localhost:3003
```

---

## 📝 步骤7：创建新测试任务

**重要**：
1. 删除所有旧任务（hwc-pos-20251111-gqb, hwc-pos-20251111-ciw, hwc-pos-20251111-aaz）
2. 创建一个新的小规模测试任务：
   - **期号范围**：最近10期（不要选全部历史！）
   - **正选条件**：简单设置几个条件
   - **排除条件**：启用部分排除

### 📝 步骤8：观察任务执行日志

**关键检查点** - 在控制台应该看到：

```
处理期号对 25114->25115...
  Step 1 - 热温冷比筛选: ...
  Step 2 - 区间比筛选: ...
  ...
  ✅ 结果已保存: XXX 条配对记录
  💾 正在保存排除详情 (9个步骤)...      ← 关键！必须看到这条
  ✅ 排除详情保存完成（共 9 个步骤）     ← 关键！必须看到这条
```

**如果看到这两条日志，说明修复已生效！**

### 📝 步骤9：运行监控脚本

任务执行时，打开新的命令行窗口，运行：

```bash
node watch-current-task.js
```

脚本会显示任务进度，并在完成后检查排除详情。

### 📝 步骤10：验证修复成功

任务完成后，监控脚本应该显示：

```
🎉🎉🎉 修复已生效！找到排除详情记录！

📊 按Step分组统计:
所有Step 2-10都有 ✅ detailsMap

💡 下一步：导出Excel文件，检查Sheet2是否有数据
```

---

## ❓ 如果仍然没有数据

### 可能原因1：Node.js缓存模块

Node.js可能缓存了旧的server.js模块。解决方案：

```bash
# 删除node_modules/.cache（如果存在）
rmdir /s /q node_modules\.cache

# 重启应用
npm start
```

### 可能原因2：使用了开发工具的硬刷新

确保在Electron应用中按 `Ctrl + Shift + R` 硬刷新。

### 可能原因3：多个应用实例在运行

```bash
# 查看所有node进程
tasklist | findstr node

# 查看端口占用
netstat -ano | findstr :3003

# 如果有多个进程，全部终止
taskkill /F /PID <进程ID>
```

---

## 🎯 最终验证清单

- [ ] 所有旧进程已终止
- [ ] 应用已重新启动
- [ ] 控制台显示正常启动日志
- [ ] 删除了所有旧任务
- [ ] 创建了新的小规模测试任务（最近10期）
- [ ] 任务执行日志显示"💾 正在保存排除详情"
- [ ] 任务执行日志显示"✅ 排除详情保存完成"
- [ ] 监控脚本确认有排除详情记录
- [ ] Excel的Sheet2有数据

---

## 📞 需要帮助？

如果按照上述步骤操作后仍然没有数据，请提供：
1. 应用控制台的完整启动日志
2. 任务执行时的完整日志（包括"排除详情保存"部分）
3. 运行 `node monitor-latest-task.js` 的输出

---

**重要提示**：每次修改代码后，必须完全重启应用才能使修改生效！
