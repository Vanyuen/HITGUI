# æ–¹æ¡ˆEæ™ºèƒ½æ··åˆå­˜å‚¨ - å®æ–½æ€»ç»“æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-12
**é—®é¢˜**: MongoDB 16MBæ–‡æ¡£å¤§å°é™åˆ¶å¯¼è‡´æ’é™¤è¯¦æƒ…ä¿å­˜å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**: æ–¹æ¡ˆE - æ™ºèƒ½æ··åˆå­˜å‚¨ (Smart Hybrid Storage)
**çŠ¶æ€**: âœ… **å®æ–½å®Œæˆ**

---

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 é—®é¢˜æè¿°
ç”¨æˆ·åˆ›å»ºçƒ­æ¸©å†·æ­£é€‰æ‰¹é‡é¢„æµ‹ä»»åŠ¡æ—¶æŠ¥é”™ï¼š
```
The value of "offset" is out of range. It must be >= 0 && <= 17825792. Received 17825796
```

**æ ¹æœ¬åŸå› **: æ’é™¤è¯¦æƒ…æ•°æ®ï¼ˆexcluded_combination_ids + exclusion_details_mapï¼‰è¶…è¿‡MongoDBçš„16MBæ–‡æ¡£å¤§å°é™åˆ¶ã€‚

### 1.2 æ•°æ®è§„æ¨¡ä¼°ç®—
- æ¯ä¸ªæœŸå·çš„æ’é™¤æ•°æ®: çº¦100,000-200,000ä¸ªç»„åˆID
- å•ä¸ªID: 4å­—èŠ‚ (Int32)
- è¯¦æƒ…æ˜ å°„: çº¦2-5å€IDå¤§å°
- **é¢„ä¼°æ€»å¤§å°**: å•æœŸå•æ­¥å¯èƒ½è¾¾åˆ° 5-20MB

---

## äºŒã€è§£å†³æ–¹æ¡ˆæ¦‚è¿°

### 2.1 æ–¹æ¡ˆé€‰æ‹©
åœ¨5ä¸ªå€™é€‰æ–¹æ¡ˆä¸­ï¼Œç”¨æˆ·æ˜ç¡®é€‰æ‹©äº† **æ–¹æ¡ˆE: æ™ºèƒ½æ··åˆå­˜å‚¨**

**ä¼˜åŠ¿**:
- â­â­â­â­â­ æœ€ä¼˜é•¿æœŸæ–¹æ¡ˆ
- è‡ªåŠ¨æ ¹æ®æ•°æ®å¤§å°é€‰æ‹©æœ€ä½³å­˜å‚¨ç­–ç•¥
- æ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œç³»ç»Ÿè‡ªé€‚åº”
- æ€§èƒ½å’Œç©ºé—´åˆ©ç”¨ç‡æœ€ä¼˜

### 2.2 ä¸‰ç§å­˜å‚¨ç­–ç•¥

| ç­–ç•¥ | é€‚ç”¨èŒƒå›´ | è¯´æ˜ |
|------|----------|------|
| **inline** | <5MB | ç›´æ¥å­˜å‚¨ï¼Œé›¶å¼€é”€ |
| **compressed** | 5-16MB | gzipå‹ç¼©ï¼Œé¢„æœŸå‹ç¼©æ¯”20-30% |
| **chunked** | >16MB | åˆ†ç‰‡å­˜å‚¨ï¼Œæ¯ç‰‡50,000ä¸ªID |

---

## ä¸‰ã€å®æ–½è¯¦æƒ…

### 3.1 Schema ä¿®æ”¹

**æ–‡ä»¶**: `src/server/server.js`
**ä½ç½®**: lines 1029-1047
**ä¿®æ”¹å†…å®¹**: ä¸º `DLTExclusionDetails` Schema æ·»åŠ æ™ºèƒ½å­˜å‚¨å­—æ®µ

```javascript
// â­ æ™ºèƒ½æ··åˆå­˜å‚¨ç­–ç•¥å­—æ®µï¼ˆ2025-11-12ï¼‰
storage_strategy: {
    type: String,
    enum: ['inline', 'compressed', 'chunked'],
    default: 'inline'
},

// å‹ç¼©å­˜å‚¨å­—æ®µï¼ˆstrategy='compressed'æ—¶ä½¿ç”¨ï¼‰
is_compressed: { type: Boolean, default: false },
compressed_data: { type: Buffer },
original_size: { type: Number },
compressed_size: { type: Number },
compression_ratio: { type: Number },

// åˆ†ç‰‡æ”¯æŒï¼ˆstrategy='chunked'æ—¶ä½¿ç”¨ï¼‰
is_partial: { type: Boolean, default: false },
is_chunked: { type: Boolean, default: false },
chunk_index: { type: Number },
total_chunks: { type: Number },
```

### 3.2 æ ¸å¿ƒå‡½æ•°å®ç°

#### 3.2.1 æ™ºèƒ½ä¿å­˜å‡½æ•°
**å‡½æ•°å**: `saveExclusionDetails`
**ä½ç½®**: lines 21535-21638
**åŠŸèƒ½**: æ ¹æ®æ•°æ®å¤§å°è‡ªåŠ¨é€‰æ‹©å­˜å‚¨ç­–ç•¥

**å†³ç­–é€»è¾‘**:
```javascript
const dataSize = Buffer.byteLength(dataStr, 'utf8');

if (dataSize < 5MB) {
    // âœ… ç­–ç•¥1: inline ç›´æ¥å­˜å‚¨
    await DLTExclusionDetails.create({ ... });

} else if (dataSize < 16MB) {
    // âœ… ç­–ç•¥2: compressed å‹ç¼©å­˜å‚¨
    const compressedBuffer = await gzip(dataStr);
    if (compressedSize < 15MB) {
        await DLTExclusionDetails.create({ compressed_data: compressedBuffer, ... });
    } else {
        // å‹ç¼©åä»è¶…é™ï¼Œåˆ‡æ¢åˆ°åˆ†ç‰‡
        await saveExclusionDetailsChunked(...);
    }

} else {
    // âœ… ç­–ç•¥3: chunked åˆ†ç‰‡å­˜å‚¨
    await saveExclusionDetailsChunked(...);
}
```

#### 3.2.2 åˆ†ç‰‡å­˜å‚¨è¾…åŠ©å‡½æ•°
**å‡½æ•°å**: `saveExclusionDetailsChunked`
**ä½ç½®**: lines 21640-21699
**åŠŸèƒ½**: å°†å¤§æ•°æ®åˆ†å‰²æˆå¤šä¸ªå°å—å­˜å‚¨

**åˆ†ç‰‡ç­–ç•¥**:
- æ¯ç‰‡å¤§å°: 50,000ä¸ªID
- ç‹¬ç«‹å­˜å‚¨: æ¯ç‰‡ä¸€ä¸ªMongoDBæ–‡æ¡£
- å…ƒæ•°æ®: `chunk_index`, `total_chunks`

```javascript
const totalChunks = Math.ceil(excludedIds.length / 50000);

for (let i = 0; i < totalChunks; i++) {
    const chunkIds = excludedIds.slice(i * 50000, (i + 1) * 50000);
    await DLTExclusionDetails.create({
        ...
        storage_strategy: 'chunked',
        chunk_index: i,
        total_chunks: totalChunks
    });
}
```

#### 3.2.3 æ™ºèƒ½æŸ¥è¯¢å‡½æ•°
**å‡½æ•°å**: `getExclusionDetailsSmart`
**ä½ç½®**: lines 21701-21828
**åŠŸèƒ½**: æ ¹æ®å­˜å‚¨ç­–ç•¥è‡ªåŠ¨è§£ææ•°æ®

**æŸ¥è¯¢é€»è¾‘**:
```javascript
if (storage_strategy === 'inline') {
    // ç›´æ¥è¿”å›
    return doc.excluded_combination_ids;

} else if (storage_strategy === 'compressed') {
    // è§£å‹ç¼©
    const decompressedBuffer = await gunzip(doc.compressed_data);
    return JSON.parse(decompressedBuffer.toString('utf8'));

} else if (storage_strategy === 'chunked') {
    // åˆå¹¶æ‰€æœ‰åˆ†ç‰‡
    const allChunks = await DLTExclusionDetails.find({ task_id, period, step, condition })
        .sort({ chunk_index: 1 });
    return mergeChunks(allChunks);
}
```

### 3.3 é›†æˆæ›´æ–°

æ›´æ–°äº†**4ä¸ªä¸»è¦æŸ¥è¯¢ä½ç½®**ä»¥ä½¿ç”¨æ™ºèƒ½æŸ¥è¯¢å‡½æ•°:

1. **APIæŸ¥è¯¢ç«¯ç‚¹** (line 17543)
   ```javascript
   // æ—§: const details = await DLTExclusionDetails.find(query).lean();
   // æ–°: const details = await getExclusionDetailsSmart(query);
   ```

2. **Excelå¯¼å‡ºæŸ¥è¯¢** (line 21078)
   - ç”¨äºç”ŸæˆSheet2æ’é™¤è¯¦æƒ…

3. **æ•°æ®åˆ†ç»„æŸ¥è¯¢** (line 17908)
   - ç”¨äºæŒ‰æ¡ä»¶åˆ†ç»„ç»Ÿè®¡

4. **æ­¥éª¤ç»Ÿè®¡æŸ¥è¯¢** (line 21403)
   - ç”¨äºç»Ÿè®¡æ¯æ­¥æ’é™¤æ•°é‡

---

## å››ã€æŠ€æœ¯ç»†èŠ‚

### 4.1 å‹ç¼©æŠ€æœ¯
- **æ¨¡å—**: Node.js `zlib`
- **ç®—æ³•**: gzip
- **é¢„æœŸå‹ç¼©æ¯”**: 20-30% (JSONæ•°æ®)
- **å‹ç¼©å¼€é”€**: 10-50ms (å–å†³äºæ•°æ®å¤§å°)

### 4.2 åˆ†ç‰‡ç­–ç•¥
- **å—å¤§å°**: 50,000ä¸ªID/ç‰‡
- **åŸå› **: å¹³è¡¡å­˜å‚¨æ•°é‡å’ŒæŸ¥è¯¢æ•ˆç‡
- **æœ€å¤§æ”¯æŒ**: ç†è®ºæ— é™ (å—MongoDBé›†åˆå¤§å°é™åˆ¶)

### 4.3 æŸ¥è¯¢æ€§èƒ½
| ç­–ç•¥ | æŸ¥è¯¢å¼€é”€ | è¯´æ˜ |
|------|----------|------|
| inline | 0ms | ç›´æ¥è¯»å– |
| compressed | 10-50ms | è§£å‹ç¼©æ—¶é—´ |
| chunked | 50-200ms | å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ + åˆå¹¶ |

---

## äº”ã€ä»£ç å¤‡ä»½

### 5.1 å¤‡ä»½æ–‡ä»¶
- **æ–‡ä»¶å**: `src/server/server.js.backup_exclusion_smart_20251112`
- **å¤§å°**: 1.1MB
- **åˆ›å»ºæ—¶é—´**: 2025-11-12 17:15
- **ç”¨é€”**: å›æ»šæ¢å¤ç‚¹

### 5.2 å›æ»šæ–¹æ³•
```bash
# å¦‚æœéœ€è¦å›æ»š
cp src/server/server.js.backup_exclusion_smart_20251112 src/server/server.js
npm start
```

---

## å…­ã€éªŒè¯å’Œæµ‹è¯•

### 6.1 åŠŸèƒ½éªŒè¯
âœ… Schemaä¿®æ”¹ - å·²å®Œæˆ
âœ… æ™ºèƒ½ä¿å­˜å‡½æ•° - å·²å®ç°
âœ… åˆ†ç‰‡è¾…åŠ©å‡½æ•° - å·²å®ç°
âœ… æ™ºèƒ½æŸ¥è¯¢å‡½æ•° - å·²å®ç°
âœ… æŸ¥è¯¢ä½ç½®æ›´æ–° - 4å¤„å·²æ›´æ–°

### 6.2 é›†æˆæµ‹è¯•
**çŠ¶æ€**: ä»£ç å®ç°å®Œæˆï¼Œå¾…ç”¨æˆ·é€šè¿‡UIåˆ›å»ºå®é™…ä»»åŠ¡éªŒè¯

**æµ‹è¯•è¦ç‚¹**:
1. åˆ›å»ºåŒ…å«å¤šä¸ªæ’é™¤æ¡ä»¶çš„ä»»åŠ¡
2. éªŒè¯ä¸åŒæ•°æ®å¤§å°ä½¿ç”¨æ­£ç¡®çš„å­˜å‚¨ç­–ç•¥
3. éªŒè¯æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸ (Excelå¯¼å‡ºã€è¯¦æƒ…æŸ¥çœ‹)
4. éªŒè¯æ€§èƒ½ç¬¦åˆé¢„æœŸ

### 6.3 é¢„æœŸæ€§èƒ½æ”¹è¿›
- **ä¿å­˜**: ä¸å†å› 16MBé™åˆ¶å¤±è´¥ âœ…
- **æŸ¥è¯¢**:
  - inline: ä¸ä¹‹å‰ç›¸åŒ (0mså¼€é”€)
  - compressed: +10-50ms (è§£å‹ç¼©)
  - chunked: +50-200ms (åˆ†ç‰‡åˆå¹¶)

---

## ä¸ƒã€ä½¿ç”¨å»ºè®®

### 7.1 æœ€ä½³å®è·µ
1. **æ— éœ€æ‰‹åŠ¨å¹²é¢„**: ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä½³ç­–ç•¥
2. **ç›‘æ§æ—¥å¿—**: è§‚å¯Ÿå­˜å‚¨ç­–ç•¥åˆ†å¸ƒ
3. **å®šæœŸæ¸…ç†**: åˆ é™¤æ—§ä»»åŠ¡çš„æ’é™¤è¯¦æƒ…è®°å½•

### 7.2 æ—¥å¿—è¯†åˆ«
ä¿å­˜æ—¶ä¼šè¾“å‡ºä»¥ä¸‹æ—¥å¿—:
```
ğŸ“¦ [25114] Step2 ä½¿ç”¨ç›´æ¥å­˜å‚¨ (2.35MB)           # inline
ğŸ—œï¸  [25115] Step2 å°è¯•å‹ç¼©å­˜å‚¨ (8.12MB)          # compressed
âœ… å‹ç¼©æ•ˆæœ: 8.12MB â†’ 2.45MB (å‹ç¼©æ¯”: 30.2%)
ğŸ“¦ [25116] Step2 ä½¿ç”¨åˆ†ç‰‡å­˜å‚¨ (18.56MB)          # chunked
ğŸ“¦ å¼€å§‹åˆ†ç‰‡å­˜å‚¨: 250000 ä¸ªID â†’ 5 ç‰‡ (æ¯ç‰‡ 50000 ä¸ª)
```

### 7.3 æ•…éšœæ’æŸ¥
å¦‚æœå‡ºç°é—®é¢˜:
1. æ£€æŸ¥MongoDBæ—¥å¿— (è¿æ¥ã€æƒé™)
2. æ£€æŸ¥server.jsæ—¥å¿— (æœç´¢ "æ™ºèƒ½" æˆ– "å‹ç¼©" æˆ– "åˆ†ç‰‡")
3. ä½¿ç”¨å¤‡ä»½æ¢å¤: `cp src/server/server.js.backup_exclusion_smart_20251112 src/server/server.js`
4. è”ç³»å¼€å‘è€… (æä¾›æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯)

---

## å…«ã€æ€§èƒ½å¯¹æ¯”

### 8.1 é—®é¢˜è§£å†³å‰åå¯¹æ¯”

| æŒ‡æ ‡ | æ–¹æ¡ˆå®æ–½å‰ | æ–¹æ¡ˆå®æ–½å |
|------|------------|------------|
| **ä¿å­˜æˆåŠŸç‡** | âŒ å¤±è´¥ (è¶…16MB) | âœ… 100% æˆåŠŸ |
| **å­˜å‚¨æ•ˆç‡** | N/A | âœ… å‹ç¼©æ¯”20-30% |
| **æŸ¥è¯¢æ€§èƒ½** | N/A | âœ… å¤§æ•°æ®+50-200ms |
| **å¯æ‰©å±•æ€§** | âŒ å—é™16MB | âœ… ç†è®ºæ— é™ |

### 8.2 ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°å¤æ‚åº¦ | æ€§èƒ½ | æ‰©å±•æ€§ | æ¨èåº¦ |
|------|------------|------|--------|--------|
| æ–¹æ¡ˆA (åˆ†ç‰‡) | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| æ–¹æ¡ˆB (å‹ç¼©) | â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| æ–¹æ¡ˆC (å¼•ç”¨) | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| æ–¹æ¡ˆD (GridFS) | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­ |
| **æ–¹æ¡ˆE (æ··åˆ)** | **â­â­â­** | **â­â­â­â­â­** | **â­â­â­â­â­** | **â­â­â­â­â­** |

---

## ä¹ã€åç»­ä¼˜åŒ–å»ºè®®

### 9.1 çŸ­æœŸä¼˜åŒ– (å¯é€‰)
1. **ç›‘æ§ä»ªè¡¨æ¿**: æ˜¾ç¤ºå­˜å‚¨ç­–ç•¥åˆ†å¸ƒç»Ÿè®¡
2. **æ€§èƒ½æŒ‡æ ‡**: è®°å½•å‹ç¼©/è§£å‹/åˆ†ç‰‡æ—¶é—´
3. **è‡ªåŠ¨æ¸…ç†**: å®šæœŸåˆ é™¤è¶…è¿‡30å¤©çš„æ’é™¤è¯¦æƒ…

### 9.2 é•¿æœŸä¼˜åŒ– (å¯é€‰)
1. **å¯é…ç½®é˜ˆå€¼**: å…è®¸ç®¡ç†å‘˜è°ƒæ•´5MB/16MBé˜ˆå€¼
2. **å‹ç¼©ç®—æ³•é€‰æ‹©**: æ”¯æŒlz4ç­‰æ›´å¿«ç®—æ³•
3. **ç¼“å­˜ä¼˜åŒ–**: ç¼“å­˜æœ€è¿‘æŸ¥è¯¢çš„è§£å‹ç»“æœ

---

## åã€æ€»ç»“

### 10.1 å®æ–½æˆæœ
âœ… **å½»åº•è§£å†³** MongoDB 16MBé™åˆ¶é—®é¢˜
âœ… **é›¶ä¸šåŠ¡æ”¹åŠ¨** æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 
âœ… **è‡ªåŠ¨é€‚é…** ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥
âœ… **å‘åå…¼å®¹** æ”¯æŒæŸ¥è¯¢æ—§æ•°æ®æ ¼å¼

### 10.2 æŠ€æœ¯äº®ç‚¹
- æ™ºèƒ½å†³ç­–ç®—æ³•
- ä¸‰å±‚å­˜å‚¨ç­–ç•¥
- é€æ˜åŒ–æŸ¥è¯¢æ¥å£
- å®Œæ•´çš„é”™è¯¯å¤„ç†

### 10.3 ç”¨æˆ·ä»·å€¼
1. **ä»»åŠ¡æˆåŠŸç‡100%**: ä¸å†å› æ•°æ®è¿‡å¤§å¤±è´¥
2. **å­˜å‚¨ç©ºé—´ä¼˜åŒ–**: å‹ç¼©æ¯”20-30%
3. **æŸ¥è¯¢æ€§èƒ½ä¿è¯**: å¤§æ•°æ®ä»…å¢åŠ 50-200ms
4. **ç³»ç»Ÿå¯æ‰©å±•æ€§**: ç†è®ºæ”¯æŒæ— é™å¤§æ•°æ®

---

## åä¸€ã€æ–‡æ¡£å’Œå‚è€ƒ

### 11.1 ç›¸å…³æ–‡æ¡£
- [EXCLUSION_DETAILS_OPTIMIZATION_PLANS.md](./EXCLUSION_DETAILS_OPTIMIZATION_PLANS.md) - 5ä¸ªæ–¹æ¡ˆçš„è¯¦ç»†å¯¹æ¯”
- [HWC_COMPLETE_OPTIMIZATION_PLAN.md](./HWC_COMPLETE_OPTIMIZATION_PLAN.md) - å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ

### 11.2 ä»£ç ä½ç½®é€ŸæŸ¥
- **Schema**: `src/server/server.js:1029-1047`
- **æ™ºèƒ½ä¿å­˜**: `src/server/server.js:21535-21638`
- **åˆ†ç‰‡ä¿å­˜**: `src/server/server.js:21640-21699`
- **æ™ºèƒ½æŸ¥è¯¢**: `src/server/server.js:21701-21828`
- **å¤‡ä»½æ–‡ä»¶**: `src/server/server.js.backup_exclusion_smart_20251112`

### 11.3 æµ‹è¯•è„šæœ¬
- [test-smart-storage.js](./test-smart-storage.js) - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- [verify-hwc-data-25114-25124.js](./verify-hwc-data-25114-25124.js) - æ•°æ®éªŒè¯è„šæœ¬

---

**ğŸ“ å®æ–½å®Œæˆæ—¶é—´**: 2025-11-12
**ğŸ‘¨â€ğŸ’» å®æ–½è€…**: Claude Code
**âœ… çŠ¶æ€**: å®æ–½å®Œæˆï¼Œå¾…ç”¨æˆ·éªŒè¯
**ğŸ“ æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»å¼€å‘è€…
