# 热温冷正选批量预测任务性能衰减问题分析报告

## 问题现象

连续创建多个热温冷正选批量预测任务后，后面的任务执行速度越来越慢。

## 根本原因分析

### 1. **主要问题：任务完成后未清理缓存**

**位置**: `src/server/server.js:17484-17760` (processHwcPositiveTask函数)

**问题描述**:
- 任务完成后直接标记为`completed`，没有调用缓存清理函数
- GlobalCacheManager中的任务特定缓存（hwcOptimizedCache、historicalIssuesCache）持续累积
- 每个任务处理101期，每期都会缓存热温冷优化数据和历史开奖数据

**代码证据**:
```javascript
// 任务完成时（第22927行）
log(`✅ 热温冷正选批量预测任务完成: ${task_id}`);
// ❌ 缺少: globalCacheManager.clearTaskSpecificCache()
```

### 2. **次要问题：热温冷优化表缓存持续增长**

**位置**: `src/server/server.js:11454-12195` (GlobalCacheManager类)

**问题描述**:
- `hwcOptimizedCache` (Map结构) 按期号对缓存数据
- 每个任务处理101期，生成101个期号对的缓存
- 缓存键格式: `base_issue-target_issue` (例如: `25023-25024`)
- 多任务累积后，Map可能包含数千个条目

**缓存大小估算**:
- 单个期号对缓存: ~10-50KB (取决于组合数)
- 101期任务: 101个期号对 × 50KB = ~5MB
- 10个连续任务: 10 × 5MB = **~50MB** (且仍在内存中)

### 3. **次要问题：历史开奖数据缓存未清理**

**位置**: `src/server/server.js:11996-12030`

**问题描述**:
- `historicalIssuesCache` (Map结构) 缓存历史开奖数据
- 每个任务都会预加载最多103期历史数据
- 缓存键格式: 期号Issue
- 多任务可能重复加载，但缓存不会自动清理

### 4. **全局缓存生命周期管理不足**

**现有机制**:
```javascript
// 缓存有效期: 30分钟 (第11467行)
this.maxCacheAge = 30 * 60 * 1000;
```

**问题**:
- 基础缓存(红球/蓝球组合)复用是正确的，不应清理
- 但任务特定缓存(HWC/历史)应该在任务完成后立即清理
- 目前只有`clearTaskSpecificCache()`方法存在，但**从未被调用**

## 性能影响

### 第1个任务:
- 内存占用: ~100MB (基础缓存) + ~5MB (任务缓存) = **105MB**
- 缓存命中率: 0% (首次构建)
- 处理速度: 正常

### 第5个任务:
- 内存占用: ~100MB (基础缓存) + ~25MB (累积任务缓存) = **125MB**
- Map查询开销: 增加 (505个条目)
- 处理速度: 轻微下降

### 第10个任务:
- 内存占用: ~100MB (基础缓存) + ~50MB (累积任务缓存) = **150MB**
- Map查询开销: 显著增加 (1010个条目)
- 垃圾回收压力: 增大
- 处理速度: **明显下降**

## 解决方案

### ✅ 方案1: 在任务完成时清理缓存 (推荐)

**优点**:
- 简单直接，立即见效
- 不影响基础缓存复用
- 只清理任务特定数据

**实施步骤**:
1. 在`processHwcPositiveTask()`函数末尾（成功完成后）添加清理调用
2. 在`processHwcPositiveTask()`函数catch块（失败后）也添加清理调用

**代码位置**: `src/server/server.js:22927` 和 `src/server/server.js:22940`

### ✅ 方案2: 优化缓存键格式 (可选增强)

**当前**: `25023-25024` (字符串)
**优化**: 限制缓存数量，使用LRU策略

**优点**:
- 防止无限增长
- 保留最近使用的热数据

### ✅ 方案3: 添加内存监控和自动清理 (长期优化)

**实施**:
- 定期检查内存使用率
- 超过阈值时主动清理
- 记录清理日志供分析

## 验证方法

### 修复前测试:
```bash
# 连续创建5个任务，观察每个任务的耗时
node test-multiple-hwc-tasks.js
```

### 修复后测试:
```bash
# 相同测试，对比耗时变化
node test-multiple-hwc-tasks.js
```

### 预期结果:
- 第1个任务: ~15-20分钟
- 第5个任务: ~15-20分钟 (修复前可能30-40分钟)
- 内存稳定: ~100-110MB (修复前可能150MB+)

## 代码修改摘要

### 需要修改的文件:
- `src/server/server.js`

### 修改点:
1. **第22927行后**: 添加成功完成后的缓存清理
2. **第22940行后**: 添加失败后的缓存清理

### 预计影响:
- **风险**: 低 (只是添加清理调用，不改变核心逻辑)
- **测试**: 需要验证连续任务性能
- **兼容性**: 无影响 (向下兼容)

## 时间线

1. **立即**: 实施方案1 (添加缓存清理)
2. **本周内**: 测试验证多任务场景
3. **下周**: 如需要，实施方案2和3

## 附录：相关代码位置

- GlobalCacheManager类: 行11454-12195
- clearTaskSpecificCache()方法: 行12159-12169
- processHwcPositiveTask()函数: 行17484-22942
- 任务完成标记: 行22913-22927
- 任务失败处理: 行22929-22941
