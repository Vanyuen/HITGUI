# çƒ­æ¸©å†·æ­£é€‰ä»»åŠ¡ - Sheet 2 çº¢çƒæ’é™¤è¯¦æƒ…è¡¨ å®Œæ•´å®æ–½æ–¹æ¡ˆ

## ä¸€ã€åŠŸèƒ½å®šä½æ˜ç¡®

### 1.1 Sheet 2 çš„å®šä½
**åç§°**ï¼šçº¢çƒæ’é™¤è¯¦æƒ…è¡¨
**æ•°æ®æ¥æº**ï¼š**æ’é™¤æ¡ä»¶é˜¶æ®µ**ï¼ˆStep 7-10ï¼‰è¢«æ’é™¤çš„çº¢çƒç»„åˆ
**æ•°æ®èµ·ç‚¹**ï¼šæ­£é€‰6æ­¥åçš„3,200ä¸ªç»„åˆ
**æ•°æ®ç»ˆç‚¹**ï¼šæœ€ç»ˆä¿ç•™çš„2,800ä¸ªç»„åˆ

### 1.2 ä¸åŒ…å«çš„å†…å®¹
âŒ **æ­£é€‰æ¡ä»¶**ï¼ˆStep 1-6ï¼‰ï¼šçƒ­æ¸©å†·æ¯”ã€åŒºé—´æ¯”ã€å’Œå€¼ã€è·¨åº¦ã€**å¥‡å¶æ¯”**ã€**ACå€¼**
- ç†ç”±ï¼šè¿™äº›æ˜¯**æ­£é€‰è¿‡ç¨‹**ï¼Œä»324,632ä¸ªç­›é€‰åˆ°3,200ä¸ªï¼Œæ•°æ®é‡å¤ªå¤§
- æ­£é€‰é˜¶æ®µçš„æ’é™¤è¯¦æƒ…å·²ä¿å­˜åœ¨ `DLTExclusionDetails`ï¼ˆstep 2-6ï¼‰ï¼Œä½†ä¸åœ¨Sheet 2å±•ç¤º

### 1.3 åŒ…å«çš„å†…å®¹
âœ… **æ’é™¤æ¡ä»¶**ï¼ˆStep 7-10ï¼‰ï¼šåœ¨3,200ä¸ªæ­£é€‰ç»“æœåŸºç¡€ä¸Šçš„æ’é™¤

| Step | æ’é™¤æ¡ä»¶ | å½“å‰çŠ¶æ€ | éœ€è¦çš„å·¥ä½œ |
|------|---------|---------|-----------|
| 7 | è¿å·ç»„æ•°æ’é™¤ | âœ… é€»è¾‘å·²å®ç°ï¼ŒâŒ æœªè®°å½•è¯¦æƒ… | è¡¥å……è®°å½•è¢«æ’é™¤çš„ç»„åˆID |
| 8 | æœ€é•¿è¿å·é•¿åº¦æ’é™¤ | âœ… é€»è¾‘å·²å®ç°ï¼ŒâŒ æœªè®°å½•è¯¦æƒ… | è¡¥å……è®°å½•è¢«æ’é™¤çš„ç»„åˆID |
| 9 | ç›¸å…‹å¯¹æ’é™¤ | âŒ æœªå®ç° | å®ç°æ’é™¤é€»è¾‘ + è®°å½•è¯¦æƒ… |
| 10 | åŒç°æ¯”æ’é™¤ | âŒ æœªå®ç° | å®ç°æ’é™¤é€»è¾‘ + è®°å½•è¯¦æƒ… |

**æ•°æ®é‡ä¼°ç®—**ï¼š
- è¾“å…¥ï¼š3,200ä¸ªç»„åˆï¼ˆæ­£é€‰åï¼‰
- Step 7æ’é™¤ï¼šçº¦100-200ä¸ªï¼ˆè¿å·ç»„æ•°ï¼‰
- Step 8æ’é™¤ï¼šçº¦50-150ä¸ªï¼ˆæœ€é•¿è¿å·ï¼‰
- Step 9æ’é™¤ï¼šçº¦50-100ä¸ªï¼ˆç›¸å…‹å¯¹ï¼‰
- Step 10æ’é™¤ï¼šçº¦20-50ä¸ªï¼ˆåŒç°æ¯”ï¼‰
- **æ€»è®¡**ï¼šçº¦220-500ä¸ªè¢«æ’é™¤çš„ç»„åˆ âœ… æ•°æ®é‡å®Œå…¨å¯æ§

---

## äºŒã€Sheet 2 è¡¨ç»“æ„è®¾è®¡

### 2.1 åˆ—å®šä¹‰

| åˆ—åºå· | åˆ—å | Key | å®½åº¦ | è¯´æ˜ |
|--------|------|-----|------|------|
| 1 | çº¢çƒ1 | red1 | 8 | |
| 2 | çº¢çƒ2 | red2 | 8 | |
| 3 | çº¢çƒ3 | red3 | 8 | |
| 4 | çº¢çƒ4 | red4 | 8 | |
| 5 | çº¢çƒ5 | red5 | 8 | |
| 6 | å’Œå€¼ | sum | 8 | |
| 7 | è·¨åº¦ | span | 8 | |
| 8 | åŒºé—´æ¯” | zone_ratio | 10 | |
| 9 | å¥‡å¶æ¯” | odd_even | 10 | |
| 10 | çƒ­æ¸©å†·æ¯” | hwc_ratio | 10 | |
| 11 | ACå€¼ | ac | 8 | |
| 12 | è¿å·ç»„æ•° | consecutive_groups | 10 | |
| 13 | æœ€é•¿è¿å· | max_consecutive_length | 10 | |
| 14 | æ’é™¤åŸå›  | exclude_reason | 30 | ä¸­æ–‡æè¿° |

### 2.2 å‘ˆç°æ–¹å¼ï¼šæŒ‰æ’é™¤æ¡ä»¶åˆ†ç»„

```
=== Step 7: è¿å·ç»„æ•°æ’é™¤ (æ’é™¤ 150 ä¸ªç»„åˆ) ===
[æ•°æ®è¡Œ 1-150]

=== Step 8: æœ€é•¿è¿å·é•¿åº¦æ’é™¤ (æ’é™¤ 80 ä¸ªç»„åˆ) ===
[æ•°æ®è¡Œ 151-230]

=== Step 9: ç›¸å…‹å¯¹æ’é™¤ (æ’é™¤ 60 ä¸ªç»„åˆ) ===
[æ•°æ®è¡Œ 231-290]

=== Step 10: åŒç°æ¯”æ’é™¤ (æ’é™¤ 30 ä¸ªç»„åˆ) ===
[æ•°æ®è¡Œ 291-320]
```

**åˆ†ç»„æ ‡é¢˜è¡Œæ ·å¼**ï¼š
- å­—ä½“ï¼šåŠ ç²—ï¼Œ11å·
- èƒŒæ™¯è‰²ï¼šæµ…è“è‰² `#E3F2FD`
- å¯¹é½ï¼šå·¦å¯¹é½
- åˆå¹¶ï¼šç¬¬1-3åˆ—åˆå¹¶æ˜¾ç¤ºå®Œæ•´æ ‡é¢˜

**æ•°æ®è¡Œæ ·å¼**ï¼š
- å¶æ•°è¡Œï¼šæµ…ç°èƒŒæ™¯ `#F5F5F5`ï¼ˆæ–‘é©¬çº¹ï¼‰
- å¥‡æ•°è¡Œï¼šç™½è‰²èƒŒæ™¯

---

## ä¸‰ã€æŠ€æœ¯å®æ–½æ–¹æ¡ˆ

### 3.1 é˜¶æ®µ1ï¼šè¡¥å……è¿å·æ¡ä»¶çš„æ’é™¤è¯¦æƒ…è®°å½•ï¼ˆ30åˆ†é’Ÿï¼‰

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/server/server.js`

#### ä¿®æ”¹ä½ç½®1ï¼šè¿å·ç»„æ•°æ’é™¤ï¼ˆ20952-20986è¡Œï¼‰

**å½“å‰ä»£ç **ï¼š
```javascript
// â­ 5.1 è¿å·ç»„æ•°æ’é™¤
if (exclusion_conditions?.consecutiveGroups?.enabled) {
    const { groups } = exclusion_conditions.consecutiveGroups;

    if (groups && groups.length > 0) {
        log(`  ğŸ”¢ åº”ç”¨è¿å·ç»„æ•°æ’é™¤: æ’é™¤ ${groups.join(', ')} ç»„`);

        const beforeCount = combinations.length;

        // è¿‡æ»¤: æ’é™¤æŒ‡å®šè¿å·ç»„æ•°çš„ç»„åˆ
        combinations = combinations.filter(combo => {
            // ... è¿‡æ»¤é€»è¾‘ ...
            return !groups.includes(consecutiveGroups);
        });

        const excludedCount = beforeCount - combinations.length;
        log(`  ğŸ”¢ è¿å·ç»„æ•°æ’é™¤å: ${combinations.length} ä¸ªç»„åˆ (æ’é™¤${excludedCount}ä¸ª)`);
    }
}
```

**ä¿®æ”¹ä¸º**ï¼š
```javascript
// â­ 5.1 è¿å·ç»„æ•°æ’é™¤
if (exclusion_conditions?.consecutiveGroups?.enabled) {
    const { groups } = exclusion_conditions.consecutiveGroups;

    if (groups && groups.length > 0) {
        log(`  ğŸ”¢ åº”ç”¨è¿å·ç»„æ•°æ’é™¤: æ’é™¤ ${groups.join(', ')} ç»„`);

        const beforeIds = combinations.map(c => c.combination_id);  // â­ æ–°å¢
        const beforeCount = combinations.length;

        // è¿‡æ»¤: æ’é™¤æŒ‡å®šè¿å·ç»„æ•°çš„ç»„åˆ
        combinations = combinations.filter(combo => {
            let consecutiveGroups;
            if (combo.consecutive_groups !== undefined && combo.consecutive_groups !== null) {
                consecutiveGroups = combo.consecutive_groups;
            } else {
                const redBalls = [
                    combo.red_ball_1,
                    combo.red_ball_2,
                    combo.red_ball_3,
                    combo.red_ball_4,
                    combo.red_ball_5
                ];
                const analysis = analyzeConsecutive(redBalls);
                consecutiveGroups = analysis.consecutiveGroups;
            }

            // ä¿ç•™: è¿å·ç»„æ•°ä¸åœ¨æ’é™¤åˆ—è¡¨ä¸­
            return !groups.includes(consecutiveGroups);
        });

        const afterIds = combinations.map(c => c.combination_id);   // â­ æ–°å¢
        const excludedCount = beforeCount - combinations.length;

        // â­ è®¡ç®—å¹¶ä¿å­˜æ’é™¤çš„ID
        const afterIdSet = new Set(afterIds);
        const excludedIds = beforeIds.filter(id => !afterIdSet.has(id));

        if (excludedIds.length > 0) {
            exclusionsToSave.push({
                step: 7,
                condition: 'exclusion_consecutive_groups',
                excludedIds: excludedIds
            });
        }

        log(`  ğŸ”¢ è¿å·ç»„æ•°æ’é™¤å: ${combinations.length} ä¸ªç»„åˆ (æ’é™¤${excludedCount}ä¸ª)`);
    }
}
```

#### ä¿®æ”¹ä½ç½®2ï¼šæœ€é•¿è¿å·é•¿åº¦æ’é™¤ï¼ˆ20988-21022è¡Œï¼‰

**ä¿®æ”¹ä¸º**ï¼ˆç±»ä¼¼ä¸Šé¢ï¼‰ï¼š
```javascript
// â­ 5.2 æœ€é•¿è¿å·é•¿åº¦æ’é™¤
if (exclusion_conditions?.maxConsecutiveLength?.enabled) {
    const { lengths } = exclusion_conditions.maxConsecutiveLength;

    if (lengths && lengths.length > 0) {
        log(`  ğŸ“ åº”ç”¨æœ€é•¿è¿å·é•¿åº¦æ’é™¤: æ’é™¤ ${lengths.join(', ')}`);

        const beforeIds = combinations.map(c => c.combination_id);  // â­ æ–°å¢
        const beforeCount = combinations.length;

        // è¿‡æ»¤: æ’é™¤æŒ‡å®šæœ€é•¿è¿å·é•¿åº¦çš„ç»„åˆ
        combinations = combinations.filter(combo => {
            let maxConsecutiveLength;
            if (combo.max_consecutive_length !== undefined && combo.max_consecutive_length !== null) {
                maxConsecutiveLength = combo.max_consecutive_length;
            } else {
                const redBalls = [
                    combo.red_ball_1,
                    combo.red_ball_2,
                    combo.red_ball_3,
                    combo.red_ball_4,
                    combo.red_ball_5
                ];
                const analysis = analyzeConsecutive(redBalls);
                maxConsecutiveLength = analysis.maxConsecutiveLength;
            }

            // ä¿ç•™: æœ€é•¿è¿å·é•¿åº¦ä¸åœ¨æ’é™¤åˆ—è¡¨ä¸­
            return !lengths.includes(maxConsecutiveLength);
        });

        const afterIds = combinations.map(c => c.combination_id);   // â­ æ–°å¢
        const excludedCount = beforeCount - combinations.length;

        // â­ è®¡ç®—å¹¶ä¿å­˜æ’é™¤çš„ID
        const afterIdSet = new Set(afterIds);
        const excludedIds = beforeIds.filter(id => !afterIdSet.has(id));

        if (excludedIds.length > 0) {
            exclusionsToSave.push({
                step: 8,
                condition: 'exclusion_max_consecutive_length',
                excludedIds: excludedIds
            });
        }

        log(`  ğŸ“ æœ€é•¿è¿å·é•¿åº¦æ’é™¤å: ${combinations.length} ä¸ªç»„åˆ (æ’é™¤${excludedCount}ä¸ª)`);
    }
}
```

---

### 3.2 é˜¶æ®µ2ï¼šå®ç°ç›¸å…‹å¯¹æ’é™¤ï¼ˆ1å°æ—¶ï¼‰

#### æ·»åŠ ä½ç½®ï¼š20988-21022è¡Œä¹‹å

```javascript
// â­ 5.3 ç›¸å…‹å¯¹æ’é™¤
if (exclusion_conditions?.conflictPairs?.enabled) {
    log(`  âš”ï¸ åº”ç”¨ç›¸å…‹å¯¹æ’é™¤...`);

    const beforeIds = combinations.map(c => c.combination_id);
    const beforeCount = combinations.length;

    // æ„å»ºç›¸å…‹å¯¹Setï¼ˆä»å†å²æ•°æ®åˆ†æï¼‰
    const conflictPairsSet = new Set();

    // ç®€åŒ–å®ç°ï¼šåˆ†ææœ€è¿‘50æœŸï¼Œæ‰¾å‡ºä»æœªåŒæ—¶å‡ºç°çš„å·ç å¯¹
    const recentIssues = await DLT.find({})
        .sort({ Issue: -1 })
        .limit(50)
        .lean();

    // ç»Ÿè®¡æ‰€æœ‰å·ç å¯¹çš„åŒç°æ¬¡æ•°
    const pairCounts = new Map();
    for (const issue of recentIssues) {
        const reds = issue.Red || [];
        for (let i = 0; i < reds.length - 1; i++) {
            for (let j = i + 1; j < reds.length; j++) {
                const key = reds[i] < reds[j] ? `${reds[i]}-${reds[j]}` : `${reds[j]}-${reds[i]}`;
                pairCounts.set(key, (pairCounts.get(key) || 0) + 1);
            }
        }
    }

    // æ‰¾å‡ºç›¸å…‹å¯¹ï¼ˆåŒç°æ¬¡æ•° <= é˜ˆå€¼ï¼Œä¾‹å¦‚ <= 2 æ¬¡ï¼‰
    const threshold = 2;
    for (const [pair, count] of pairCounts) {
        if (count <= threshold) {
            conflictPairsSet.add(pair);
        }
    }

    log(`  âš”ï¸ è¯†åˆ«åˆ° ${conflictPairsSet.size} å¯¹ç›¸å…‹å·ç `);

    // è¿‡æ»¤ï¼šæ’é™¤åŒ…å«ç›¸å…‹å¯¹çš„ç»„åˆ
    combinations = combinations.filter(combo => {
        const balls = [combo.red_ball_1, combo.red_ball_2, combo.red_ball_3, combo.red_ball_4, combo.red_ball_5];

        // æ£€æŸ¥ç»„åˆä¸­æ˜¯å¦åŒ…å«ç›¸å…‹å¯¹
        for (let i = 0; i < balls.length - 1; i++) {
            for (let j = i + 1; j < balls.length; j++) {
                const key = balls[i] < balls[j] ? `${balls[i]}-${balls[j]}` : `${balls[j]}-${balls[i]}`;
                if (conflictPairsSet.has(key)) {
                    return false; // åŒ…å«ç›¸å…‹å¯¹ï¼Œæ’é™¤
                }
            }
        }
        return true; // ä¸åŒ…å«ç›¸å…‹å¯¹ï¼Œä¿ç•™
    });

    const afterIds = combinations.map(c => c.combination_id);
    const excludedCount = beforeCount - combinations.length;

    // â­ ä¿å­˜æ’é™¤çš„ID
    const afterIdSet = new Set(afterIds);
    const excludedIds = beforeIds.filter(id => !afterIdSet.has(id));

    if (excludedIds.length > 0) {
        exclusionsToSave.push({
            step: 9,
            condition: 'exclusion_conflict_pairs',
            excludedIds: excludedIds
        });
    }

    log(`  âš”ï¸ ç›¸å…‹å¯¹æ’é™¤å: ${combinations.length} ä¸ªç»„åˆ (æ’é™¤${excludedCount}ä¸ª)`);
}
```

---

### 3.3 é˜¶æ®µ3ï¼šå®ç°åŒç°æ¯”æ’é™¤ï¼ˆ1å°æ—¶ï¼‰

#### æ·»åŠ ä½ç½®ï¼šç›¸å…‹å¯¹æ’é™¤ä¹‹å

```javascript
// â­ 5.4 åŒç°æ¯”æ’é™¤
if (exclusion_conditions?.coOccurrence?.enabled) {
    log(`  ğŸ”— åº”ç”¨åŒç°æ¯”æ’é™¤...`);

    const beforeIds = combinations.map(c => c.combination_id);
    const beforeCount = combinations.length;

    // è·å–å‰ä¸€æœŸçš„é—æ¼å€¼æ•°æ®
    const previousIssue = parseInt(targetIssue) - 1;
    const missingRecord = await mongoose.connection.db
        .collection('hit_dlt_basictrendchart_redballmissing_histories')
        .findOne({ Issue: previousIssue.toString() });

    if (missingRecord) {
        // æ‰¾å‡ºé—æ¼å€¼ <= 5 çš„å·ç ï¼ˆé«˜é¢‘å·ï¼‰
        const hotNumbers = [];
        for (let i = 1; i <= 35; i++) {
            const missing = missingRecord[`RedBall_${String(i).padStart(2, '0')}`];
            if (missing !== undefined && missing <= 5) {
                hotNumbers.push(i);
            }
        }

        log(`  ğŸ”— è¯†åˆ«åˆ° ${hotNumbers.length} ä¸ªé«˜é¢‘å·: ${hotNumbers.join(', ')}`);

        // è¿‡æ»¤ï¼šæ’é™¤åŒ…å« >= 3 ä¸ªé«˜é¢‘å·çš„ç»„åˆ
        combinations = combinations.filter(combo => {
            const balls = [combo.red_ball_1, combo.red_ball_2, combo.red_ball_3, combo.red_ball_4, combo.red_ball_5];

            let hotCount = 0;
            for (const ball of balls) {
                if (hotNumbers.includes(ball)) {
                    hotCount++;
                }
            }

            // ä¿ç•™ï¼šé«˜é¢‘å·ä¸è¶…è¿‡2ä¸ª
            return hotCount <= 2;
        });

        const afterIds = combinations.map(c => c.combination_id);
        const excludedCount = beforeCount - combinations.length;

        // â­ ä¿å­˜æ’é™¤çš„ID
        const afterIdSet = new Set(afterIds);
        const excludedIds = beforeIds.filter(id => !afterIdSet.has(id));

        if (excludedIds.length > 0) {
            exclusionsToSave.push({
                step: 10,
                condition: 'exclusion_co_occurrence',
                excludedIds: excludedIds
            });
        }

        log(`  ğŸ”— åŒç°æ¯”æ’é™¤å: ${combinations.length} ä¸ªç»„åˆ (æ’é™¤${excludedCount}ä¸ª)`);
    } else {
        log(`  âš ï¸ æœªæ‰¾åˆ°å‰ä¸€æœŸ ${previousIssue} çš„é—æ¼å€¼æ•°æ®ï¼Œè·³è¿‡åŒç°æ¯”æ’é™¤`);
    }
}
```

---

### 3.4 é˜¶æ®µ4ï¼šå®ç°Sheet 2å¯¼å‡ºé€»è¾‘ï¼ˆ1å°æ—¶ï¼‰

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/server/server.js`
#### ä¿®æ”¹ä½ç½®ï¼šå¯¼å‡ºAPIï¼ˆ20001-20422è¡Œï¼‰ä¸­çš„ Sheet 2 éƒ¨åˆ†ï¼ˆ20274-20319è¡Œï¼‰

**å½“å‰ä»£ç **ï¼š
```javascript
// ===== Sheet 2: çº¢çƒæ’é™¤è¯¦æƒ…è¡¨ =====
// TODO: éœ€è¦å®ç°æ’é™¤é€»è¾‘é‡ç®—ï¼Œè·å–è¢«æ’é™¤çš„ç»„åˆ
const sheet2 = workbook.addWorksheet('çº¢çƒæ’é™¤è¯¦æƒ…');
// ... ä»…æœ‰å ä½ç¬¦ ...
```

**æ›¿æ¢ä¸ºå®Œæ•´å®ç°**ï¼š
```javascript
// ===== Sheet 2: çº¢çƒæ’é™¤è¯¦æƒ…è¡¨ï¼ˆæ’é™¤æ¡ä»¶é˜¶æ®µï¼‰=====
log(`  ğŸ“‹ ç”Ÿæˆ Sheet 2: çº¢çƒæ’é™¤è¯¦æƒ…è¡¨...`);
const sheet2 = workbook.addWorksheet('çº¢çƒæ’é™¤è¯¦æƒ…');

sheet2.columns = [
    { header: 'çº¢çƒ1', key: 'red1', width: 8 },
    { header: 'çº¢çƒ2', key: 'red2', width: 8 },
    { header: 'çº¢çƒ3', key: 'red3', width: 8 },
    { header: 'çº¢çƒ4', key: 'red4', width: 8 },
    { header: 'çº¢çƒ5', key: 'red5', width: 8 },
    { header: 'å’Œå€¼', key: 'sum', width: 8 },
    { header: 'è·¨åº¦', key: 'span', width: 8 },
    { header: 'åŒºé—´æ¯”', key: 'zone_ratio', width: 10 },
    { header: 'å¥‡å¶æ¯”', key: 'odd_even', width: 10 },
    { header: 'çƒ­æ¸©å†·æ¯”', key: 'hwc_ratio', width: 10 },
    { header: 'ACå€¼', key: 'ac', width: 8 },
    { header: 'è¿å·ç»„æ•°', key: 'consecutive_groups', width: 10 },
    { header: 'æœ€é•¿è¿å·', key: 'max_consecutive_length', width: 10 },
    { header: 'æ’é™¤åŸå› ', key: 'exclude_reason', width: 30 }
];

// è¡¨å¤´æ ·å¼
sheet2.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
sheet2.getRow(1).fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FFFF9800' }
};

// 1. æŸ¥è¯¢æ‰€æœ‰æ’é™¤è¯¦æƒ…ï¼ˆä»…Step 7-10ï¼šæ’é™¤æ¡ä»¶é˜¶æ®µï¼‰
const exclusionRecords = await DLTExclusionDetails.find({
    task_id,
    period: period.toString(),
    step: { $in: [7, 8, 9, 10] }  // â­ ä»…æŸ¥è¯¢æ’é™¤æ¡ä»¶é˜¶æ®µ
}).sort({ step: 1, chunk_index: 1 }).lean();

log(`  ğŸ“Š æŸ¥è¯¢åˆ° ${exclusionRecords.length} æ¡æ’é™¤è¯¦æƒ…è®°å½•ï¼ˆStep 7-10ï¼‰`);

// 2. æŒ‰æ­¥éª¤åˆ†ç»„å¹¶åˆå¹¶åˆ†ç‰‡
const excludedByStep = {};
for (const record of exclusionRecords) {
    if (!excludedByStep[record.step]) {
        excludedByStep[record.step] = {
            condition: record.condition,
            ids: []
        };
    }
    excludedByStep[record.step].ids.push(...record.excluded_combination_ids);
}

// 3. æŸ¥è¯¢æ‰€æœ‰è¢«æ’é™¤çš„ç»„åˆè¯¦æƒ…ï¼ˆå»é‡ï¼‰
const allExcludedIds = [...new Set(
    Object.values(excludedByStep).flatMap(s => s.ids)
)];

log(`  ğŸ“Š å…± ${allExcludedIds.length} ä¸ªè¢«æ’é™¤çš„ç»„åˆï¼ˆå»é‡åï¼‰`);

if (allExcludedIds.length === 0) {
    // æ— æ’é™¤æ•°æ®ï¼Œæ·»åŠ æç¤ºè¡Œ
    sheet2.addRow({
        red1: '-',
        red2: '-',
        red3: '-',
        red4: '-',
        red5: '-',
        exclude_reason: 'å½“å‰ä»»åŠ¡æœªå¯ç”¨æ’é™¤æ¡ä»¶ï¼Œæ— è¢«æ’é™¤çš„ç»„åˆ'
    });
} else {
    // æ‰¹é‡æŸ¥è¯¢ç»„åˆè¯¦æƒ…
    const excludedCombos = await DLTRedCombinations.find({
        combination_id: { $in: allExcludedIds }
    }).lean();

    // æ„å»ºIDåˆ°ç»„åˆçš„æ˜ å°„
    const comboMap = new Map(excludedCombos.map(c => [c.combination_id, c]));

    log(`  ğŸ“Š æŸ¥è¯¢åˆ° ${excludedCombos.length} ä¸ªç»„åˆçš„è¯¦ç»†ä¿¡æ¯`);

    // æ’é™¤åŸå› æ˜ å°„
    const conditionLabels = {
        'exclusion_consecutive_groups': 'è¿å·ç»„æ•°ä¸ç¬¦åˆè¦æ±‚',
        'exclusion_max_consecutive_length': 'æœ€é•¿è¿å·é•¿åº¦ä¸ç¬¦åˆè¦æ±‚',
        'exclusion_conflict_pairs': 'åŒ…å«ç›¸å…‹å·ç å¯¹',
        'exclusion_co_occurrence': 'é«˜é¢‘å·è¿‡å¤šï¼ˆåŒç°æ¯”è¶…æ ‡ï¼‰'
    };

    // æ­¥éª¤åç§°æ˜ å°„
    const stepNames = {
        7: 'è¿å·ç»„æ•°æ’é™¤',
        8: 'æœ€é•¿è¿å·é•¿åº¦æ’é™¤',
        9: 'ç›¸å…‹å¯¹æ’é™¤',
        10: 'åŒç°æ¯”æ’é™¤'
    };

    // 4. æŒ‰æ­¥éª¤ç”ŸæˆExcelè¡Œ
    let totalRowsAdded = 0;
    for (const step of [7, 8, 9, 10]) {
        const stepData = excludedByStep[step];
        if (!stepData || stepData.ids.length === 0) continue;

        // æ·»åŠ åˆ†ç»„æ ‡é¢˜è¡Œ
        const titleRow = sheet2.addRow({
            red1: `=== Step ${step}:`,
            red2: stepNames[step],
            red3: `(æ’é™¤ ${stepData.ids.length} ä¸ªç»„åˆ)`,
            red4: '==='
        });

        // æ ‡é¢˜è¡Œæ ·å¼
        titleRow.font = { bold: true, size: 11 };
        titleRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE3F2FD' }
        };
        titleRow.alignment = { horizontal: 'left' };

        // æ·»åŠ æ•°æ®è¡Œ
        let rowIndex = 0;
        for (const id of stepData.ids) {
            const combo = comboMap.get(id);
            if (!combo) continue;

            // æ ¼å¼åŒ–è¿å·æƒ…å†µ
            let consecutiveDisplay = '-';
            if (combo.max_consecutive_length > 0) {
                consecutiveDisplay = combo.max_consecutive_length === 2 ? '2è¿å·' :
                                   combo.max_consecutive_length === 3 ? '3è¿å·' :
                                   combo.max_consecutive_length >= 4 ? `${combo.max_consecutive_length}è¿å·` : '-';
            } else {
                consecutiveDisplay = 'æ— è¿å·';
            }

            const dataRow = sheet2.addRow({
                red1: combo.red_ball_1,
                red2: combo.red_ball_2,
                red3: combo.red_ball_3,
                red4: combo.red_ball_4,
                red5: combo.red_ball_5,
                sum: combo.sum_value,
                span: combo.span_value,
                zone_ratio: combo.zone_ratio || '-',
                odd_even: combo.odd_even_ratio || '-',
                hwc_ratio: combo.hot_warm_cold_ratio || '-',
                ac: combo.ac_value,
                consecutive_groups: combo.consecutive_groups !== undefined ? combo.consecutive_groups : '-',
                max_consecutive_length: consecutiveDisplay,
                exclude_reason: conditionLabels[stepData.condition] || stepData.condition
            });

            // æ–‘é©¬çº¹ï¼šå¶æ•°è¡Œç°è‰²èƒŒæ™¯
            if (rowIndex % 2 === 0) {
                dataRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF5F5F5' }
                };
            }

            rowIndex++;
            totalRowsAdded++;
        }
    }

    log(`  âœ… Sheet 2 å®Œæˆ: å…±æ·»åŠ  ${totalRowsAdded} è¡Œæ’é™¤æ•°æ®`);
}
```

---

## å››ã€å®æ–½è®¡åˆ’ä¸æ—¶é—´ä¼°ç®—

### é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | æ–‡ä»¶ä¿®æ”¹ |
|------|------|---------|---------|
| **é˜¶æ®µ1** | è¡¥å……è¿å·ç»„æ•°æ’é™¤è®°å½• | 15åˆ†é’Ÿ | `server.js` (20952-20986è¡Œ) |
| **é˜¶æ®µ1** | è¡¥å……æœ€é•¿è¿å·æ’é™¤è®°å½• | 15åˆ†é’Ÿ | `server.js` (20988-21022è¡Œ) |
| **é˜¶æ®µ2** | å®ç°ç›¸å…‹å¯¹æ’é™¤é€»è¾‘ | 1å°æ—¶ | `server.js` (æ–°å¢ï¼Œ21022è¡Œå) |
| **é˜¶æ®µ3** | å®ç°åŒç°æ¯”æ’é™¤é€»è¾‘ | 1å°æ—¶ | `server.js` (æ–°å¢ï¼Œç›¸å…‹å¯¹å) |
| **é˜¶æ®µ4** | å®ç°Sheet 2å¯¼å‡ºé€»è¾‘ | 1å°æ—¶ | `server.js` (20274-20319è¡Œ) |
| **æµ‹è¯•** | åˆ›å»ºæµ‹è¯•ä»»åŠ¡å¹¶éªŒè¯ | 30åˆ†é’Ÿ | - |

**æ€»è®¡**ï¼šçº¦ 4 å°æ—¶

---

## äº”ã€éªŒè¯æµ‹è¯•æ–¹æ¡ˆ

### 5.1 æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæµ‹è¯•ä»»åŠ¡**ï¼ˆåŒ…å«å…¨éƒ¨æ’é™¤æ¡ä»¶ï¼‰
```javascript
// çƒ­æ¸©å†·æ­£é€‰ + å…¨éƒ¨æ’é™¤æ¡ä»¶
{
    task_name: "Sheet2æµ‹è¯•ä»»åŠ¡",
    period_range: { type: "recent", total: 5 },
    positive_selection: {
        hwc_ratios: ["4:1:0", "3:2:0"],
        zone_ratios: ["2:1:2", "2:2:1"],
        sum_ranges: [{ min: 65, max: 95 }],
        span_ranges: [{ min: 15, max: 30 }],
        odd_even_ratios: ["3:2", "2:3"],
        ac_values: [5, 6, 7, 8]
    },
    exclusion_conditions: {
        consecutiveGroups: {
            enabled: true,
            groups: [0, 4]  // æ’é™¤æ— è¿å·å’Œ4è¿å·
        },
        maxConsecutiveLength: {
            enabled: true,
            lengths: [5]  // æ’é™¤5è¿å·
        },
        conflictPairs: {
            enabled: true
        },
        coOccurrence: {
            enabled: true
        }
    }
}
```

2. **ç­‰å¾…ä»»åŠ¡å®Œæˆ**

3. **å¯¼å‡ºExceléªŒè¯**
   - Sheet 1ï¼šé¢„æµ‹ç»„åˆè¡¨ï¼ˆæœ€ç»ˆä¿ç•™çš„ç»„åˆï¼‰
   - **Sheet 2ï¼šçº¢çƒæ’é™¤è¯¦æƒ…è¡¨**ï¼ˆStep 7-10æ’é™¤çš„ç»„åˆï¼‰â­
   - Sheet 3ï¼šæ’é™¤ç»Ÿè®¡è¡¨ï¼ˆæ±‡æ€»ï¼‰

4. **æ£€æŸ¥Sheet 2å†…å®¹**
   - âœ… æ˜¯å¦æœ‰4ä¸ªåˆ†ç»„ï¼ˆStep 7-10ï¼‰
   - âœ… æ¯ä¸ªåˆ†ç»„çš„æ ‡é¢˜è¡Œæ ·å¼æ­£ç¡®
   - âœ… æ•°æ®è¡Œå®Œæ•´ï¼ˆçº¢çƒã€ç‰¹å¾å€¼ã€æ’é™¤åŸå› ï¼‰
   - âœ… æ–‘é©¬çº¹æ ·å¼æ­£ç¡®

### 5.2 æ•°æ®åº“éªŒè¯

```javascript
// 1. æŸ¥è¯¢æ’é™¤æ¡ä»¶çš„æ’é™¤è¯¦æƒ…
db.hit_dlt_exclusiondetails.find({
    task_id: "hwc-pos-20250111-001",
    period: "25121",
    step: { $in: [7, 8, 9, 10] }  // ä»…æ’é™¤æ¡ä»¶é˜¶æ®µ
}).pretty();

// 2. ç»Ÿè®¡æ¯æ­¥æ’é™¤æ•°é‡
db.hit_dlt_exclusiondetails.aggregate([
    {
        $match: {
            task_id: "hwc-pos-20250111-001",
            period: "25121"
        }
    },
    {
        $group: {
            _id: "$step",
            count: { $sum: "$excluded_count" },
            condition: { $first: "$condition" }
        }
    },
    { $sort: { _id: 1 } }
]);
```

---

## å…­ã€æ³¨æ„äº‹é¡¹ä¸é£é™©

### 6.1 æ€§èƒ½è€ƒè™‘

| åœºæ™¯ | é£é™© | å¯¹ç­– |
|------|------|------|
| ç›¸å…‹å¯¹è®¡ç®—è€—æ—¶ | åˆ†æ50æœŸÃ—C(35,2)å¯¹ | ä½¿ç”¨Mapç¼“å­˜ï¼Œå¤æ‚åº¦O(n) |
| åŒç°æ¯”æŸ¥è¯¢æ…¢ | æŸ¥è¯¢é—æ¼å€¼å†å²è¡¨ | æ·»åŠ ç´¢å¼•ï¼Œé™åˆ¶æŸ¥è¯¢æœŸæ•° |
| ç»„åˆè¯¦æƒ…æŸ¥è¯¢æ…¢ | ä¸€æ¬¡æŸ¥è¯¢500ä¸ªID | æ‰¹é‡æŸ¥è¯¢ï¼Œä½¿ç”¨$inä¼˜åŒ– |

### 6.2 æ•°æ®ä¸€è‡´æ€§

- âœ… æ‰€æœ‰æ’é™¤è¯¦æƒ…ä¿å­˜åˆ°åŒä¸€ä¸ªäº‹åŠ¡ï¼ˆå¼‚æ­¥Promise.allï¼‰
- âœ… åˆ†ç‰‡æ”¯æŒï¼šå•ä¸ªæ¡ä»¶æ’é™¤è¶…è¿‡5ä¸‡ä¸ªæ—¶è‡ªåŠ¨åˆ†ç‰‡
- âœ… å»é‡å¤„ç†ï¼šallExcludedIdsä½¿ç”¨Setå»é‡

### 6.3 å‘åå…¼å®¹

- âœ… æ—§ä»»åŠ¡æ— æ’é™¤è¯¦æƒ…æ—¶ï¼ŒSheet 2æ˜¾ç¤ºå‹å¥½æç¤º
- âœ… æœªå¯ç”¨æ’é™¤æ¡ä»¶æ—¶ï¼ŒSheet 2æ˜¾ç¤º"æ— è¢«æ’é™¤çš„ç»„åˆ"

---

## ä¸ƒã€äº¤ä»˜ç‰©

### 7.1 ä»£ç ä¿®æ”¹
- âœ… `src/server/server.js`ï¼š4å¤„ä¿®æ”¹
  - è¡Œ20952-20986ï¼šè¡¥å……è¿å·ç»„æ•°è®°å½•
  - è¡Œ20988-21022ï¼šè¡¥å……æœ€é•¿è¿å·è®°å½•
  - è¡Œ21022åï¼šæ–°å¢ç›¸å…‹å¯¹æ’é™¤
  - è¡Œç›¸å…‹å¯¹åï¼šæ–°å¢åŒç°æ¯”æ’é™¤
  - è¡Œ20274-20319ï¼šå®ç°Sheet 2å¯¼å‡º

### 7.2 æ–‡æ¡£
- âœ… æœ¬æ–¹æ¡ˆæ–‡æ¡£ï¼ˆ`çƒ­æ¸©å†·æ­£é€‰ä»»åŠ¡-Sheet2çº¢çƒæ’é™¤è¯¦æƒ…-å®Œæ•´å®æ–½æ–¹æ¡ˆ.md`ï¼‰
- âœ… æµç¨‹è¯¦è§£æ–‡æ¡£ï¼ˆå·²ç”Ÿæˆï¼‰

### 7.3 æµ‹è¯•è„šæœ¬
- âœ… MongoDBéªŒè¯æŸ¥è¯¢ï¼ˆè§5.2èŠ‚ï¼‰

---

## å…«ã€é¢„æœŸæ•ˆæœ

**å¯¼å‡ºçš„ExcelåŒ…å«**ï¼š

### Sheet 1ï¼šé¢„æµ‹ç»„åˆè¡¨
- å†…å®¹ï¼šæœ€ç»ˆä¿ç•™çš„2,800ä¸ªç»„åˆï¼ˆ5çº¢+2è“ï¼‰
- åˆ—ï¼šçº¢çƒã€è“çƒã€ç‰¹å¾å€¼ã€å‘½ä¸­åˆ†æã€ä¸­å¥–æƒ…å†µ

### Sheet 2ï¼šçº¢çƒæ’é™¤è¯¦æƒ…è¡¨ â­ **æœ¬æ¬¡æ–°å¢**
- å†…å®¹ï¼š**ä»…æ’é™¤æ¡ä»¶é˜¶æ®µ**ï¼ˆStep 7-10ï¼‰è¢«æ’é™¤çš„çº¦220-500ä¸ªçº¢çƒç»„åˆ
- åˆ†ç»„ï¼š
  - Step 7: è¿å·ç»„æ•°æ’é™¤ï¼ˆå¦‚æ— è¿å·ã€4è¿å·ï¼‰
  - Step 8: æœ€é•¿è¿å·é•¿åº¦æ’é™¤ï¼ˆå¦‚5è¿å·ï¼‰
  - Step 9: ç›¸å…‹å¯¹æ’é™¤ï¼ˆåŒ…å«ç›¸å…‹å·ç å¯¹ï¼‰
  - Step 10: åŒç°æ¯”æ’é™¤ï¼ˆé«˜é¢‘å·è¿‡å¤šï¼‰
- åˆ—ï¼šçº¢çƒ1-5ã€å’Œå€¼ã€è·¨åº¦ã€åŒºé—´æ¯”ã€å¥‡å¶æ¯”ã€çƒ­æ¸©å†·æ¯”ã€ACå€¼ã€è¿å·ç»„æ•°ã€æœ€é•¿è¿å·ã€æ’é™¤åŸå› 

### Sheet 3ï¼šæ’é™¤ç»Ÿè®¡è¡¨
- å†…å®¹ï¼šå„ç±»æ’é™¤æ¡ä»¶çš„ç»Ÿè®¡æ±‡æ€»

---

## ä¹ã€ç¡®è®¤ç‚¹æ¸…å•

è¯·æ‚¨ç¡®è®¤ä»¥ä¸‹è®¾è®¡å†³ç­–ï¼š

| ç¡®è®¤é¡¹ | è®¾è®¡å†³ç­– | æ˜¯å¦åŒæ„ |
|--------|---------|---------|
| 1 | Sheet 2ä»…åŒ…å«**æ’é™¤æ¡ä»¶é˜¶æ®µ**ï¼ˆStep 7-10ï¼‰ï¼Œä¸åŒ…å«æ­£é€‰æ¡ä»¶ï¼ˆStep 1-6ï¼‰ | â¬œ |
| 2 | éœ€è¦å®ç°å…¨éƒ¨4ä¸ªæ’é™¤æ¡ä»¶ï¼ˆè¿å·Ã—2 + ç›¸å…‹å¯¹ + åŒç°æ¯”ï¼‰ | â¬œ |
| 3 | ç›¸å…‹å¯¹æ’é™¤é€»è¾‘ï¼šç®€åŒ–ç‰ˆï¼Œåˆ†ææœ€è¿‘50æœŸï¼ŒåŒç°â‰¤2æ¬¡è§†ä¸ºç›¸å…‹ | â¬œ |
| 4 | åŒç°æ¯”æ’é™¤é€»è¾‘ï¼šç®€åŒ–ç‰ˆï¼Œé«˜é¢‘å·ï¼ˆé—æ¼â‰¤5ï¼‰è¶…è¿‡2ä¸ªå³æ’é™¤ | â¬œ |
| 5 | åˆ†ç»„æ–¹å¼ï¼šæŒ‰Step 7-10åˆ†ç»„ï¼Œæ¯ç»„æ·»åŠ æ ‡é¢˜è¡Œ | â¬œ |
| 6 | æ ·å¼ï¼šæ ‡é¢˜è¡Œæµ…è“è‰²ï¼Œæ•°æ®è¡Œæ–‘é©¬çº¹ | â¬œ |
| 7 | é¢„è®¡å®æ–½æ—¶é—´ï¼š4å°æ—¶ï¼ˆå«æµ‹è¯•ï¼‰ | â¬œ |

---

**ç”Ÿæˆæ—¶é—´**ï¼š2025-01-11
**å‡†å¤‡çŠ¶æ€**ï¼šâœ… æ–¹æ¡ˆå®Œæ•´ï¼Œç­‰å¾…ç¡®è®¤åç«‹å³å®æ–½

---

è¯·æ‚¨ç¡®è®¤ä»¥ä¸Šæ–¹æ¡ˆï¼Œæˆ‘å°†ç«‹å³å¼€å§‹å®æ–½ï¼ğŸš€
