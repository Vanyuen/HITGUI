diff --git a/src/server/server.js b/src/server/server.js
index ccce44d..c7b83ea 100644
--- a/src/server/server.js
+++ b/src/server/server.js
@@ -15292,19 +15292,27 @@ class HwcPositivePredictor extends StreamBatchPredictor {
      */
     async calculateHistoricalStatsForIssue(baseID, exclusionConditions) {
         try {
+            // â­ 2025-12-09ä¿®å¤: å…¼å®¹å‰ç«¯æ–°ç»“æ„ (sum.historical) å’Œæ—§ç»“æ„ (historicalSum)
+            // å‰ç«¯å‘é€: { sum: { historical: { enabled, count } } }
+            // æ—§æ ¼å¼:   { historicalSum: { enabled, period } }
+            const sumHistorical = exclusionConditions.sum?.historical || exclusionConditions.historicalSum;
+            const spanHistorical = exclusionConditions.span?.historical || exclusionConditions.historicalSpan;
+            const hwcHistorical = exclusionConditions.hwc?.historical || exclusionConditions.historicalHwc;
+            const zoneHistorical = exclusionConditions.zone?.historical || exclusionConditions.historicalZone;
+
             // ç¡®å®šéœ€è¦çš„æœ€å¤§å†å²æœŸæ•°
             let maxPeriod = 0;
-            if (exclusionConditions.historicalSum?.enabled) {
-                maxPeriod = Math.max(maxPeriod, exclusionConditions.historicalSum.period || 10);
+            if (sumHistorical?.enabled) {
+                maxPeriod = Math.max(maxPeriod, sumHistorical.count || sumHistorical.period || 10);
             }
-            if (exclusionConditions.historicalSpan?.enabled) {
-                maxPeriod = Math.max(maxPeriod, exclusionConditions.historicalSpan.period || 10);
+            if (spanHistorical?.enabled) {
+                maxPeriod = Math.max(maxPeriod, spanHistorical.count || spanHistorical.period || 10);
             }
-            if (exclusionConditions.historicalHwc?.enabled) {
-                maxPeriod = Math.max(maxPeriod, exclusionConditions.historicalHwc.period || 10);
+            if (hwcHistorical?.enabled) {
+                maxPeriod = Math.max(maxPeriod, hwcHistorical.count || hwcHistorical.period || 10);
             }
-            if (exclusionConditions.historicalZone?.enabled) {
-                maxPeriod = Math.max(maxPeriod, exclusionConditions.historicalZone.period || 10);
+            if (zoneHistorical?.enabled) {
+                maxPeriod = Math.max(maxPeriod, zoneHistorical.count || zoneHistorical.period || 10);
             }
             if (exclusionConditions.conflictPairs?.enabled) {
                 maxPeriod = Math.max(maxPeriod, 50); // ç›¸å…‹å¯¹ç»Ÿè®¡50æœŸ
@@ -15328,8 +15336,9 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             log(`  âœ… æŸ¥è¯¢å†å²æ•°æ®: ä»ID=${baseID}å¾€å‰${maxPeriod}æœŸï¼Œå®é™…è·å–${historicalRecords.length}æœŸ`);
 
             // 1. è®¡ç®—å†å²å’Œå€¼
-            if (exclusionConditions.historicalSum?.enabled) {
-                const period = exclusionConditions.historicalSum.period || 10;
+            // â­ 2025-12-09ä¿®å¤: ä½¿ç”¨å…¼å®¹å˜é‡
+            if (sumHistorical?.enabled) {
+                const period = sumHistorical.count || sumHistorical.period || 10;
                 this.historicalStatsCache.sums = new Set(
                     historicalRecords.slice(0, period).map(h =>
                         h.Red1 + h.Red2 + h.Red3 + h.Red4 + h.Red5
@@ -15339,8 +15348,9 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             }
 
             // 2. è®¡ç®—å†å²è·¨åº¦
-            if (exclusionConditions.historicalSpan?.enabled) {
-                const period = exclusionConditions.historicalSpan.period || 10;
+            // â­ 2025-12-09ä¿®å¤: ä½¿ç”¨å…¼å®¹å˜é‡
+            if (spanHistorical?.enabled) {
+                const period = spanHistorical.count || spanHistorical.period || 10;
                 this.historicalStatsCache.spans = new Set(
                     historicalRecords.slice(0, period).map(h => {
                         const reds = [h.Red1, h.Red2, h.Red3, h.Red4, h.Red5];
@@ -15351,8 +15361,9 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             }
 
             // 3. è®¡ç®—å†å²åŒºé—´æ¯”
-            if (exclusionConditions.historicalZone?.enabled) {
-                const period = exclusionConditions.historicalZone.period || 10;
+            // â­ 2025-12-09ä¿®å¤: ä½¿ç”¨å…¼å®¹å˜é‡
+            if (zoneHistorical?.enabled) {
+                const period = zoneHistorical.count || zoneHistorical.period || 10;
                 this.historicalStatsCache.zoneRatios = new Set(
                     historicalRecords.slice(0, period).map(h => {
                         const reds = [h.Red1, h.Red2, h.Red3, h.Red4, h.Red5];
@@ -15850,19 +15861,79 @@ class HwcPositivePredictor extends StreamBatchPredictor {
         const BATCH_SIZE = 10000;
 
         // ============ Exclude 1: å†å²å’Œå€¼æ’é™¤ ============
+        // â­ 2025-12-09ä¿®å¤: æ·»åŠ æ’é™¤è¯¦æƒ…æ”¶é›†
         if (exclusionConditions.sum?.historical?.enabled && this.historicalStatsCache.sums) {
             const beforeCount = filtered.length;
-            filtered = filtered.filter(c => !this.historicalStatsCache.sums.has(c.sum_value));
+            const detailsMap_sum = collectDetails ? {} : null;
+            const excludedIds_sum = [];
+
+            filtered = filtered.filter(c => {
+                if (this.historicalStatsCache.sums.has(c.sum_value)) {
+                    excludedIds_sum.push(c.combination_id);
+                    if (collectDetails) {
+                        detailsMap_sum[c.combination_id] = {
+                            sum_value: c.sum_value,
+                            description: `å’Œå€¼ ${c.sum_value} åœ¨å†å²æœŸå·ä¸­å‡ºç°è¿‡`
+                        };
+                    }
+                    return false;
+                }
+                return true;
+            });
+
             excludeStats.historicalSum = beforeCount - filtered.length;
             log(`  âœ… Exclude1 å†å²å’Œå€¼æ’é™¤: ${excludeStats.historicalSum}ä¸ªç»„åˆ (${beforeCount}â†’${filtered.length})`);
+
+            exclusionsToSave.push({
+                step: 9,
+                condition: 'exclude_step9_historical_sum',
+                excludedIds: excludedIds_sum,
+                detailsMap: detailsMap_sum,
+                metadata: {
+                    historical_sum: {
+                        excluded_sums: Array.from(this.historicalStatsCache.sums),
+                        total_count: this.historicalStatsCache.sums.size
+                    }
+                }
+            });
         }
 
         // ============ Exclude 2: å†å²è·¨åº¦æ’é™¤ ============
+        // â­ 2025-12-09ä¿®å¤: æ·»åŠ æ’é™¤è¯¦æƒ…æ”¶é›†
         if (exclusionConditions.span?.historical?.enabled && this.historicalStatsCache.spans) {
             const beforeCount = filtered.length;
-            filtered = filtered.filter(c => !this.historicalStatsCache.spans.has(c.span_value));
+            const detailsMap_span = collectDetails ? {} : null;
+            const excludedIds_span = [];
+
+            filtered = filtered.filter(c => {
+                if (this.historicalStatsCache.spans.has(c.span_value)) {
+                    excludedIds_span.push(c.combination_id);
+                    if (collectDetails) {
+                        detailsMap_span[c.combination_id] = {
+                            span_value: c.span_value,
+                            description: `è·¨åº¦ ${c.span_value} åœ¨å†å²æœŸå·ä¸­å‡ºç°è¿‡`
+                        };
+                    }
+                    return false;
+                }
+                return true;
+            });
+
             excludeStats.historicalSpan = beforeCount - filtered.length;
             log(`  âœ… Exclude2 å†å²è·¨åº¦æ’é™¤: ${excludeStats.historicalSpan}ä¸ªç»„åˆ (${beforeCount}â†’${filtered.length})`);
+
+            exclusionsToSave.push({
+                step: 10,
+                condition: 'exclude_step10_historical_span',
+                excludedIds: excludedIds_span,
+                detailsMap: detailsMap_span,
+                metadata: {
+                    historical_span: {
+                        excluded_spans: Array.from(this.historicalStatsCache.spans),
+                        total_count: this.historicalStatsCache.spans.size
+                    }
+                }
+            });
         }
 
         // ============ Exclude 3: å†å²çƒ­æ¸©å†·æ¯”æ’é™¤ ============
@@ -15899,13 +15970,42 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                         }
                     }
 
+                    // â­ 2025-12-09ä¿®å¤: æ·»åŠ æ’é™¤è¯¦æƒ…æ”¶é›†
                     const beforeCount = filtered.length;
+                    const detailsMap_hwc = collectDetails ? {} : null;
+                    const excludedIds_hwc = [];
+
                     filtered = filtered.filter(c => {
                         const hwcRatio = comboToHwcMap.get(c.combination_id);
-                        return !historicalHwcRatios.has(hwcRatio);
+                        if (historicalHwcRatios.has(hwcRatio)) {
+                            excludedIds_hwc.push(c.combination_id);
+                            if (collectDetails) {
+                                detailsMap_hwc[c.combination_id] = {
+                                    hwc_ratio: hwcRatio,
+                                    description: `çƒ­æ¸©å†·æ¯” ${hwcRatio} åœ¨å†å²æœŸå·ä¸­å‡ºç°è¿‡`
+                                };
+                            }
+                            return false;
+                        }
+                        return true;
                     });
+
                     excludeStats.historicalHwc = beforeCount - filtered.length;
                     log(`  âœ… Exclude3 å†å²çƒ­æ¸©å†·æ¯”æ’é™¤: ${excludeStats.historicalHwc}ä¸ªç»„åˆ (${beforeCount}â†’${filtered.length})`);
+
+                    exclusionsToSave.push({
+                        step: 12,
+                        condition: 'exclude_step12_historical_hwc',
+                        excludedIds: excludedIds_hwc,
+                        detailsMap: detailsMap_hwc,
+                        metadata: {
+                            historical_hwc: {
+                                excluded_ratios: Array.from(historicalHwcRatios),
+                                period: period,
+                                total_count: historicalHwcRatios.size
+                            }
+                        }
+                    });
                 }
             } else {
                 log(`  âš ï¸ Exclude3 å†å²çƒ­æ¸©å†·æ¯”æ’é™¤: ç¼ºå°‘é—æ¼å€¼æ•°æ®,è·³è¿‡`);
@@ -15913,11 +16013,41 @@ class HwcPositivePredictor extends StreamBatchPredictor {
         }
 
         // ============ Exclude 4: å†å²åŒºé—´æ¯”æ’é™¤ ============
+        // â­ 2025-12-09ä¿®å¤: æ·»åŠ æ’é™¤è¯¦æƒ…æ”¶é›†
         if (exclusionConditions.zone?.historical?.enabled && this.historicalStatsCache.zoneRatios) {
             const beforeCount = filtered.length;
-            filtered = filtered.filter(c => !this.historicalStatsCache.zoneRatios.has(c.zone_ratio));
+            const detailsMap_zone = collectDetails ? {} : null;
+            const excludedIds_zone = [];
+
+            filtered = filtered.filter(c => {
+                if (this.historicalStatsCache.zoneRatios.has(c.zone_ratio)) {
+                    excludedIds_zone.push(c.combination_id);
+                    if (collectDetails) {
+                        detailsMap_zone[c.combination_id] = {
+                            zone_ratio: c.zone_ratio,
+                            description: `åŒºé—´æ¯” ${c.zone_ratio} åœ¨å†å²æœŸå·ä¸­å‡ºç°è¿‡`
+                        };
+                    }
+                    return false;
+                }
+                return true;
+            });
+
             excludeStats.historicalZone = beforeCount - filtered.length;
             log(`  âœ… Exclude4 å†å²åŒºé—´æ¯”æ’é™¤: ${excludeStats.historicalZone}ä¸ªç»„åˆ (${beforeCount}â†’${filtered.length})`);
+
+            exclusionsToSave.push({
+                step: 11,
+                condition: 'exclude_step11_historical_zone',
+                excludedIds: excludedIds_zone,
+                detailsMap: detailsMap_zone,
+                metadata: {
+                    historical_zone: {
+                        excluded_ratios: Array.from(this.historicalStatsCache.zoneRatios),
+                        total_count: this.historicalStatsCache.zoneRatios.size
+                    }
+                }
+            });
         }
 
         // ============ Exclude 5: ç›¸å…‹å¯¹æ’é™¤ (Step 9, âš¡ åˆ†æ‰¹å¤„ç†) ============
@@ -16025,8 +16155,8 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             };
 
             exclusionsToSave.push({
-                step: 9,
-                condition: 'exclude_step9_conflict_pairs',
+                step: 7,
+                condition: 'exclude_step7_conflict_pairs',
                 excludedIds: excludedIds,
                 detailsMap: detailsMap,
                 metadata: metadata  // â­ å…ƒæ•°æ®
@@ -16084,8 +16214,8 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                 };
 
                 exclusionsToSave.push({
-                    step: 7,
-                    condition: 'exclude_step7_consecutive_groups',
+                    step: 13,
+                    condition: 'exclude_step13_consecutive_groups',
                     excludedIds: excludedIds,
                     detailsMap: detailsMap,
                     metadata: metadata
@@ -16144,8 +16274,8 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                 };
 
                 exclusionsToSave.push({
-                    step: 8,
-                    condition: 'exclude_step8_max_consecutive_length',
+                    step: 14,
+                    condition: 'exclude_step14_max_consecutive_length',
                     excludedIds: excludedIds,
                     detailsMap: detailsMap,
                     metadata: metadata
@@ -16155,6 +16285,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
 
         // ============ Exclude 8: åŒç°æ¯”æ’é™¤ (Step 10) ============
         // â­ 2025-11-14: å®Œæ•´å®ç°åŒç°æ¯”æ’é™¤é€»è¾‘
+        // â­ 2025-12-09ä¿®å¤: æ­£ç¡®è¯»å– historical.combo2/combo3/combo4 + æ¨ç®—æœŸæ”¯æŒ
         if (exclusionConditions.coOccurrence?.enabled) {
             log(`  ğŸ“Š Step 10: åŒç°æ¯”æ’é™¤...`);
 
@@ -16163,36 +16294,63 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             const detailsMap = collectDetails ? {} : null;  // ğŸ› å†…å­˜ä¼˜åŒ–
 
             // ğŸ”§ åŒç°æ¯”é…ç½®è¯´æ˜ï¼š
-            // - mode: 'all' æˆ–ç‰¹å®šæ¨¡å¼ 'combo_2', 'combo_3', 'combo_4'
-            // - periods: åˆ†æçš„å†å²æœŸæ•°ï¼ˆé»˜è®¤30æœŸï¼‰
+            // å‰ç«¯å‘é€çš„ç»“æ„: coOccurrence.historical = { combo2, combo3, combo4, period }
             // é€»è¾‘ï¼šæ’é™¤åœ¨å†å²æœŸå·ä¸­å‡ºç°è¿‡çš„ç‰¹å¾ç»„åˆ
 
-            const mode = exclusionConditions.coOccurrence.mode || 'combo_2';
-            const periods = exclusionConditions.coOccurrence.periods || 30;
+            // â­ è¯»å–ç”¨æˆ·é€‰æ‹©çš„ç»„åˆç±»å‹
+            const historicalConfig = exclusionConditions.coOccurrence.historical;
+            let doCombo2 = historicalConfig?.combo2 || false;
+            let doCombo3 = historicalConfig?.combo3 || false;
+            let doCombo4 = historicalConfig?.combo4 || false;
 
-            // ğŸ“ æ³¨æ„ï¼šç”±äºå½“å‰ç³»ç»Ÿæš‚æ—  DLTComboFeatures è¡¨ï¼Œ
-            // æˆ‘ä»¬é‡‡ç”¨ç®€åŒ–å®ç°ï¼šåŸºäºå†å²å¼€å¥–å·ç ç›´æ¥æ„å»ºç‰¹å¾é›†åˆ
+            // å‘åå…¼å®¹ï¼šå¦‚æœæœ‰æ—§ç‰ˆ mode å­—æ®µ
+            if (!historicalConfig && exclusionConditions.coOccurrence.mode) {
+                const oldMode = exclusionConditions.coOccurrence.mode;
+                doCombo2 = oldMode === 'combo_2' || oldMode === 'all';
+                doCombo3 = oldMode === 'combo_3' || oldMode === 'all';
+                doCombo4 = oldMode === 'combo_4' || oldMode === 'all';
+            }
+
+            // å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©ä»»ä½•ç»„åˆç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨2ç 
+            if (!doCombo2 && !doCombo3 && !doCombo4) {
+                doCombo2 = true;
+            }
 
-            // â­ 2025-11-14ä¿®å¤: åŸºäºID-1è§„åˆ™è·å–å†å²æœŸå·åˆ—è¡¨
-            // 1. è·å–targetIssueçš„IDï¼Œä»ID-1å¼€å§‹å¾€å‰æŸ¥è¯¢periodsæœŸ
-            const targetIssueID = this.issueToIdMap.get(targetIssue.toString());
+            const periods = historicalConfig?.period || exclusionConditions.coOccurrence.periods || 30;
+
+            // ç”Ÿæˆ mode å­—ç¬¦ä¸²ç”¨äºæ—¥å¿—å’Œå…ƒæ•°æ®
+            const modeStr = [doCombo2 && '2ç ', doCombo3 && '3ç ', doCombo4 && '4ç '].filter(Boolean).join('+');
+            const modeForMeta = doCombo2 && doCombo3 && doCombo4 ? 'all' :
+                               doCombo2 ? 'combo_2' : doCombo3 ? 'combo_3' : 'combo_4';
+
+            // â­ 2025-12-09ä¿®å¤: æ¨ç®—æœŸæ”¯æŒ - ä½¿ç”¨baseIssueçš„ID
+            const targetIssueIDForCoOcc = this.issueToIdMap.get(targetIssue.toString());
+            const baseIssueIDForCoOcc = this.issueToIdMap.get(baseIssue?.toString());
+
+            // è®¡ç®—æœ‰æ•ˆçš„åŒç°åˆ†æåŸºå‡†ID
+            // - å†å²æœŸ: ä½¿ç”¨ targetIssueIDForCoOcc - 1
+            // - æ¨ç®—æœŸ: ä½¿ç”¨ baseIssueIDForCoOcc (baseIssueæœ¬èº«å°±æ˜¯ä¸Šä¸€æœŸ)
+            const effectiveBaseIDForCoOcc = targetIssueIDForCoOcc ? (targetIssueIDForCoOcc - 1) : baseIssueIDForCoOcc;
 
             // â­ åˆå§‹åŒ–å˜é‡ï¼ˆé¿å…æœªå®šä¹‰é”™è¯¯ï¼‰
             const excludedFeatures = new Set();
             const analyzedBalls = [];
             const analyzedIssues = [];
 
-            if (!targetIssueID) {
-                log(`    âš ï¸ æ— æ³•è·å–æœŸå·${targetIssue}çš„IDï¼Œè·³è¿‡åŒç°æ¯”æ’é™¤`);
+            if (!effectiveBaseIDForCoOcc) {
+                log(`    âš ï¸ æ— æ³•è·å–æœŸå·${targetIssue}æˆ–baseIssue(${baseIssue})çš„IDï¼Œè·³è¿‡åŒç°æ¯”æ’é™¤`);
             } else {
-                const baseID = targetIssueID - 1;  // ID-1è§„åˆ™
-                log(`    ğŸ“ é¢„æµ‹æœŸå·${targetIssue}(ID=${targetIssueID}), åŒç°åˆ†æä»ID=${baseID}å¼€å§‹å¾€å‰${periods}æœŸ`);
+                if (targetIssueIDForCoOcc) {
+                    log(`    ğŸ“ å†å²æœŸ${targetIssue}(ID=${targetIssueIDForCoOcc}), åŒç°åˆ†æä»ID=${effectiveBaseIDForCoOcc}å¼€å§‹å¾€å‰${periods}æœŸ`);
+                } else {
+                    log(`    ğŸ“ æ¨ç®—æœŸ${targetIssue}: ä½¿ç”¨baseIssue(${baseIssue}, ID=${baseIssueIDForCoOcc})ä½œä¸ºåŒç°åˆ†æåŸºå‡†ï¼Œå¾€å‰${periods}æœŸ`);
+                }
 
-                // 2. æŸ¥è¯¢å†å²æœŸå·çš„å¼€å¥–å·ç ï¼ˆä»baseIDå¾€å‰æŸ¥periodsæœŸï¼‰
+                // 2. æŸ¥è¯¢å†å²æœŸå·çš„å¼€å¥–å·ç ï¼ˆä»effectiveBaseIDForCoOccå¾€å‰æŸ¥periodsæœŸï¼‰
                 const historicalDrawings = await hit_dlts.find({
                     ID: {
-                        $lte: baseID,
-                        $gt: baseID - periods
+                        $lte: effectiveBaseIDForCoOcc,
+                        $gt: effectiveBaseIDForCoOcc - periods
                     }
                 }).sort({ ID: -1 }).limit(periods).select('Issue ID Red1 Red2 Red3 Red4 Red5').lean();
 
@@ -16204,8 +16362,8 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                     analyzedBalls.push(...balls);
                     analyzedIssues.push(drawing.Issue.toString());
 
-                    // æ ¹æ® mode æ„å»ºç‰¹å¾
-                    if (mode === 'combo_2' || mode === 'all') {
+                    // æ ¹æ®ç”¨æˆ·é€‰æ‹©æ„å»ºç‰¹å¾
+                    if (doCombo2) {
                         // 2-çƒç»„åˆ
                         for (let i = 0; i < balls.length - 1; i++) {
                             for (let j = i + 1; j < balls.length; j++) {
@@ -16214,7 +16372,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                         }
                     }
 
-                    if (mode === 'combo_3' || mode === 'all') {
+                    if (doCombo3) {
                         // 3-çƒç»„åˆ
                         for (let i = 0; i < balls.length - 2; i++) {
                             for (let j = i + 1; j < balls.length - 1; j++) {
@@ -16225,7 +16383,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                         }
                     }
 
-                    if (mode === 'combo_4' || mode === 'all') {
+                    if (doCombo4) {
                         // 4-çƒç»„åˆ
                         for (let i = 0; i < balls.length - 3; i++) {
                             for (let j = i + 1; j < balls.length - 2; j++) {
@@ -16239,7 +16397,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                     }
                 }
 
-                log(`    ğŸ“Š æ„å»ºåŒç°ç‰¹å¾é›†åˆ: ${excludedFeatures.size} ä¸ªç‰¹å¾ (æ¨¡å¼: ${mode}, åˆ†æ: ${historicalIssues.length}æœŸ)`);
+                log(`    ğŸ“Š æ„å»ºåŒç°ç‰¹å¾é›†åˆ: ${excludedFeatures.size} ä¸ªç‰¹å¾ (æ¨¡å¼: ${modeStr}, åˆ†æ: ${historicalDrawings.length}æœŸ)`);
 
                 // 4. æ£€æŸ¥æ¯ä¸ªç»„åˆå¹¶æ’é™¤åŒ¹é…çš„ç‰¹å¾
                 filtered = filtered.filter(c => {
@@ -16247,7 +16405,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                     const comboFeatures = [];
 
                     // ç”Ÿæˆè¯¥ç»„åˆçš„ç‰¹å¾
-                    if (mode === 'combo_2' || mode === 'all') {
+                    if (doCombo2) {
                         for (let i = 0; i < balls.length - 1; i++) {
                             for (let j = i + 1; j < balls.length; j++) {
                                 comboFeatures.push(`${balls[i]}-${balls[j]}`);
@@ -16255,7 +16413,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                         }
                     }
 
-                    if (mode === 'combo_3' || mode === 'all') {
+                    if (doCombo3) {
                         for (let i = 0; i < balls.length - 2; i++) {
                             for (let j = i + 1; j < balls.length - 1; j++) {
                                 for (let k = j + 1; k < balls.length; k++) {
@@ -16265,7 +16423,7 @@ class HwcPositivePredictor extends StreamBatchPredictor {
                         }
                     }
 
-                    if (mode === 'combo_4' || mode === 'all') {
+                    if (doCombo4) {
                         for (let i = 0; i < balls.length - 3; i++) {
                             for (let j = i + 1; j < balls.length - 2; j++) {
                                 for (let k = j + 1; k < balls.length - 1; k++) {
@@ -16301,22 +16459,22 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             // â­ 2025-11-14: å§‹ç»ˆä¿å­˜æ’é™¤è¯¦æƒ…ï¼ˆå³ä½¿ excludedIds.length === 0ï¼‰ï¼Œé™„å¸¦å…ƒæ•°æ®
             const metadata = {
                 cooccurrence: {
-                    mode: mode,
+                    mode: modeForMeta,
                     periods: periods,
                     analyzed_balls: Array.from(new Set(analyzedBalls)).sort((a, b) => a - b),
-                    analyzed_issues: analyzedIssues,  // â­ 2025-11-14ä¿®å¤: ä½¿ç”¨ID-1è§„åˆ™æŸ¥è¯¢çš„æœŸå·åˆ—è¡¨
+                    analyzed_issues: analyzedIssues,
                     excluded_features: {
-                        combo_2: mode === 'combo_2' || mode === 'all' ? Array.from(excludedFeatures).filter(f => f.split('-').length === 2) : [],
-                        combo_3: mode === 'combo_3' || mode === 'all' ? Array.from(excludedFeatures).filter(f => f.split('-').length === 3) : [],
-                        combo_4: mode === 'combo_4' || mode === 'all' ? Array.from(excludedFeatures).filter(f => f.split('-').length === 4) : []
+                        combo_2: doCombo2 ? Array.from(excludedFeatures).filter(f => f.split('-').length === 2) : [],
+                        combo_3: doCombo3 ? Array.from(excludedFeatures).filter(f => f.split('-').length === 3) : [],
+                        combo_4: doCombo4 ? Array.from(excludedFeatures).filter(f => f.split('-').length === 4) : []
                     },
                     total_features_count: excludedFeatures.size
                 }
             };
 
             exclusionsToSave.push({
-                step: 10,
-                condition: 'exclude_step10_cooccurrence',
+                step: 8,
+                condition: 'exclude_step8_cooccurrence',
                 excludedIds: excludedIds,
                 detailsMap: detailsMap,
                 metadata: metadata
@@ -16603,14 +16761,18 @@ class HwcPositivePredictor extends StreamBatchPredictor {
             // å…¨éƒ¨æœŸå·éƒ½æ”¶é›†è¯¦æƒ…
             issuesBatch.forEach(issue => collectDetailsForIssues.add(issue.toString()));
             log(`ğŸ“ [${this.sessionId}] æ’é™¤è¯¦æƒ…æ¨¡å¼: all - æ‰€æœ‰${issuesBatch.length}æœŸéƒ½æ”¶é›†è¯¦æƒ…`);
-        } else if (detailsMode === 'recent' || detailsMode === 'top_hit') {
+        } else if (detailsMode === 'top_hit') {
+            // â­ 2025-12-09ä¿®å¤: top_hitæ¨¡å¼éœ€è¦æ”¶é›†æ‰€æœ‰æœŸå·çš„è¯¦æƒ…
+            // å› ä¸ºåªæœ‰ä»»åŠ¡å®Œæˆåæ‰çŸ¥é“å“ªäº›æœŸå·å‘½ä¸­æœ€å¤šï¼Œä¿å­˜æ—¶å†æ ¹æ®å‘½ä¸­æƒ…å†µç­›é€‰
+            issuesBatch.forEach(issue => collectDetailsForIssues.add(issue.toString()));
+            log(`ğŸ“ [${this.sessionId}] æ’é™¤è¯¦æƒ…æ¨¡å¼: top_hit - è¿è¡Œæ—¶æ”¶é›†æ‰€æœ‰${issuesBatch.length}æœŸè¯¦æƒ…ï¼Œä¿å­˜æ—¶æŒ‰å‘½ä¸­ç­›é€‰`);
+        } else if (detailsMode === 'recent') {
             // recentæ¨¡å¼: æœ€åNæœŸ + æ¨ç®—æœŸ
-            // top_hitæ¨¡å¼: é¢„å¤„ç†æ—¶æ— æ³•ç¡®å®šå‘½ä¸­æœ€å¤šçš„æœŸå·ï¼Œæš‚æ—¶ä½¿ç”¨recenté€»è¾‘ï¼Œåç»­ä¼šåœ¨ä»»åŠ¡å®Œæˆæ—¶ç­›é€‰
             const sortedIssues = [...issuesBatch].sort((a, b) => parseInt(b) - parseInt(a));
             for (let i = 0; i < Math.min(recentCount, sortedIssues.length); i++) {
                 collectDetailsForIssues.add(sortedIssues[i].toString());
             }
-            log(`ğŸ“ [${this.sessionId}] æ’é™¤è¯¦æƒ…æ¨¡å¼: ${detailsMode} - é¢„æ”¶é›†æœ€è¿‘${collectDetailsForIssues.size}æœŸè¯¦æƒ…`);
+            log(`ğŸ“ [${this.sessionId}] æ’é™¤è¯¦æƒ…æ¨¡å¼: recent - é¢„æ”¶é›†æœ€è¿‘${collectDetailsForIssues.size}æœŸè¯¦æƒ…`);
         } else if (detailsMode === 'none') {
             // noneæ¨¡å¼: ä»…æ¨ç®—æœŸæ”¶é›†è¯¦æƒ…ï¼ˆåœ¨å¾ªç¯ä¸­åˆ¤æ–­ï¼‰
             log(`ğŸ“ [${this.sessionId}] æ’é™¤è¯¦æƒ…æ¨¡å¼: none - ä»…æ¨ç®—æœŸæ”¶é›†è¯¦æƒ…`);
@@ -19304,21 +19466,27 @@ app.get('/api/dlt/export-exclusion-details/:taskId/:period', async (req, res) =>
         const summaryExclusionRecords = await getExclusionDetailsSmart({
             task_id: taskId,
             period: period.toString(),
-            step: { $in: [2, 3, 4, 5, 6, 7, 8, 9, 10] }
+            step: { $in: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14] }
         });
 
         // æŒ‰stepåˆ†ç»„ç»Ÿè®¡æ’é™¤è¯¦æƒ…
         const stepSummary = {};
         const stepNames = {
-            2: 'Step 2: åŒºé—´æ¯”æ’é™¤',
-            3: 'Step 3: å’Œå€¼èŒƒå›´æ’é™¤',
-            4: 'Step 4: è·¨åº¦èŒƒå›´æ’é™¤',
-            5: 'Step 5: å¥‡å¶æ¯”æ’é™¤',
-            6: 'Step 6: ACå€¼æ’é™¤',
-            7: 'Step 7: è¿å·ç»„æ•°æ’é™¤',
-            8: 'Step 8: æœ€é•¿è¿å·æ’é™¤',
-            9: 'Step 9: ç›¸å…‹å¯¹æ’é™¤',
-            10: 'Step 10: åŒç°æ¯”æ’é™¤'
+            // æ­£é€‰æ¡ä»¶ (Step 2-6)
+            2: 'Step 2: åŒºé—´æ¯”æ­£é€‰æ’é™¤',
+            3: 'Step 3: å’Œå€¼èŒƒå›´æ­£é€‰æ’é™¤',
+            4: 'Step 4: è·¨åº¦èŒƒå›´æ­£é€‰æ’é™¤',
+            5: 'Step 5: å¥‡å¶æ¯”æ­£é€‰æ’é™¤',
+            6: 'Step 6: ACå€¼æ­£é€‰æ’é™¤',
+            // æ’é™¤æ¡ä»¶ (Step 7-14) - æŒ‰æ’é™¤é‡ä»å¤§åˆ°å°
+            7: 'Step 7: ç›¸å…‹å¯¹æ’é™¤',
+            8: 'Step 8: åŒç°æ¯”æ’é™¤',
+            9: 'Step 9: å†å²å’Œå€¼æ’é™¤',
+            10: 'Step 10: å†å²è·¨åº¦æ’é™¤',
+            11: 'Step 11: å†å²åŒºé—´æ¯”æ’é™¤',
+            12: 'Step 12: å†å²çƒ­æ¸©å†·æ¯”æ’é™¤',
+            13: 'Step 13: è¿å·ç»„æ•°æ’é™¤',
+            14: 'Step 14: æœ€é•¿è¿å·æ’é™¤'
         };
 
         for (const record of summaryExclusionRecords) {
@@ -19350,7 +19518,7 @@ app.get('/api/dlt/export-exclusion-details/:taskId/:period', async (req, res) =>
 
         // ç”Ÿæˆæ±‡æ€»è¡Œæ•°æ®
         const summaryRows = [];
-        for (let step = 2; step <= 10; step++) {
+        for (let step = 2; step <= 14; step++) {
             const summary = stepSummary[step];
 
             if (!summary) {
@@ -19399,7 +19567,7 @@ app.get('/api/dlt/export-exclusion-details/:taskId/:period', async (req, res) =>
                 // æœ€é•¿è¿å·æ’é™¤
                 const mcl = metadata.max_consecutive_length;
                 metadataSummary = `æ’é™¤é•¿åº¦: ${mcl.excluded_lengths ? mcl.excluded_lengths.join(', ') : '-'}`;
-            } else if (step === 9 && metadata.conflict_pairs) {
+            } else if (step === 7 && metadata.conflict_pairs) {
                 // ç›¸å…‹å¯¹æ’é™¤
                 const cp = metadata.conflict_pairs;
                 const pairsCount = cp.total_pairs_count || 0;
@@ -19408,8 +19576,8 @@ app.get('/api/dlt/export-exclusion-details/:taskId/:period', async (req, res) =>
                 metadataSummary = excludedCount > 0
                     ? `${analysisInfo}, ${topNInfo}, ç›¸å…‹å¯¹æ•°:${pairsCount}`
                     : `å·²æ£€æŸ¥ï¼Œæ— åŒ¹é…ã€‚${analysisInfo}, ç›¸å…‹å¯¹æ•°:${pairsCount}`;
-            } else if (step === 10 && metadata.cooccurrence) {
-                // åŒç°æ¯”æ’é™¤
+            } else if (step === 8 && metadata.cooccurrence) {
+                // åŒç°æ¯”æ’é™¤ (æ–°Step 8)
                 const co = metadata.cooccurrence;
                 const mode = co.mode || 'combo_2';
                 const periods = co.periods || 0;
@@ -19417,6 +19585,30 @@ app.get('/api/dlt/export-exclusion-details/:taskId/:period', async (req, res) =>
                 metadataSummary = excludedCount > 0
                     ? `æ¨¡å¼:${mode}, åˆ†ææœŸæ•°:${periods}æœŸ, ç‰¹å¾æ•°:${featuresCount}`
                     : `å·²æ£€æŸ¥ï¼Œæ— åŒ¹é…ã€‚æ¨¡å¼:${mode}, åˆ†ææœŸæ•°:${periods}æœŸ`;
+            } else if (step === 9 && metadata.historical_sum) {
+                // å†å²å’Œå€¼æ’é™¤
+                const hs = metadata.historical_sum;
+                metadataSummary = `æ’é™¤å’Œå€¼: ${hs.excluded_sums ? hs.excluded_sums.slice(0, 10).join(', ') + (hs.excluded_sums.length > 10 ? '...' : '') : '-'} (å…±${hs.total_count || 0}ä¸ª)`;
+            } else if (step === 10 && metadata.historical_span) {
+                // å†å²è·¨åº¦æ’é™¤
+                const hsp = metadata.historical_span;
+                metadataSummary = `æ’é™¤è·¨åº¦: ${hsp.excluded_spans ? hsp.excluded_spans.join(', ') : '-'} (å…±${hsp.total_count || 0}ä¸ª)`;
+            } else if (step === 11 && metadata.historical_zone) {
+                // å†å²åŒºé—´æ¯”æ’é™¤
+                const hz = metadata.historical_zone;
+                metadataSummary = `æ’é™¤åŒºé—´æ¯”: ${hz.excluded_ratios ? hz.excluded_ratios.join(', ') : '-'} (å…±${hz.total_count || 0}ä¸ª)`;
+            } else if (step === 12 && metadata.historical_hwc) {
+                // å†å²çƒ­æ¸©å†·æ¯”æ’é™¤
+                const hh = metadata.historical_hwc;
+                metadataSummary = `æ’é™¤çƒ­æ¸©å†·æ¯”: ${hh.excluded_ratios ? hh.excluded_ratios.join(', ') : '-'}, æœŸæ•°:${hh.period || '-'} (å…±${hh.total_count || 0}ä¸ª)`;
+            } else if (step === 13 && metadata.consecutive_groups) {
+                // è¿å·ç»„æ•°æ’é™¤ (æ–°Step 13)
+                const cg = metadata.consecutive_groups;
+                metadataSummary = `æ’é™¤ç»„æ•°: ${cg.excluded_groups ? cg.excluded_groups.join(', ') : '-'}`;
+            } else if (step === 14 && metadata.max_consecutive_length) {
+                // æœ€é•¿è¿å·æ’é™¤ (æ–°Step 14)
+                const mcl = metadata.max_consecutive_length;
+                metadataSummary = `æ’é™¤é•¿åº¦: ${mcl.excluded_lengths ? mcl.excluded_lengths.join(', ') : '-'}`;
             } else {
                 metadataSummary = excludedCount > 0 ? 'å·²æ‰§è¡Œæ’é™¤' : 'å·²æ£€æŸ¥ï¼Œæ— åŒ¹é…';
             }
@@ -22528,21 +22720,27 @@ app.get('/api/dlt/hwc-positive-tasks/:task_id/period/:period/export', async (req
         const exclusionRecords = await getExclusionDetailsSmart({
             task_id: task_id,
             period: period.toString(),
-            step: { $in: [2, 3, 4, 5, 6, 7, 8, 9, 10] }
+            step: { $in: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14] }
         });
 
         if (exclusionRecords.length > 0) {
             // æŒ‰ step åˆ†ç»„
             const stepGroups = {
-                2: { name: 'åŒºé—´æ¯”æ’é™¤', excludedIds: [], detailsMap: {} },
-                3: { name: 'å’Œå€¼èŒƒå›´æ’é™¤', excludedIds: [], detailsMap: {} },
-                4: { name: 'è·¨åº¦èŒƒå›´æ’é™¤', excludedIds: [], detailsMap: {} },
-                5: { name: 'å¥‡å¶æ¯”æ’é™¤', excludedIds: [], detailsMap: {} },
-                6: { name: 'ACå€¼æ’é™¤', excludedIds: [], detailsMap: {} },
-                7: { name: 'è¿å·ç»„æ•°æ’é™¤', excludedIds: [], detailsMap: {} },
-                8: { name: 'æœ€é•¿è¿å·æ’é™¤', excludedIds: [], detailsMap: {} },
-                9: { name: 'ç›¸å…‹å¯¹æ’é™¤', excludedIds: [], detailsMap: {} },
-                10: { name: 'åŒç°æ¯”æ’é™¤', excludedIds: [], detailsMap: {} }
+                // æ­£é€‰æ¡ä»¶ (Step 2-6)
+                2: { name: 'åŒºé—´æ¯”æ­£é€‰æ’é™¤', excludedIds: [], detailsMap: {} },
+                3: { name: 'å’Œå€¼èŒƒå›´æ­£é€‰æ’é™¤', excludedIds: [], detailsMap: {} },
+                4: { name: 'è·¨åº¦èŒƒå›´æ­£é€‰æ’é™¤', excludedIds: [], detailsMap: {} },
+                5: { name: 'å¥‡å¶æ¯”æ­£é€‰æ’é™¤', excludedIds: [], detailsMap: {} },
+                6: { name: 'ACå€¼æ­£é€‰æ’é™¤', excludedIds: [], detailsMap: {} },
+                // æ’é™¤æ¡ä»¶ (Step 7-14) - æŒ‰æ’é™¤é‡ä»å¤§åˆ°å°
+                7: { name: 'ç›¸å…‹å¯¹æ’é™¤', excludedIds: [], detailsMap: {} },
+                8: { name: 'åŒç°æ¯”æ’é™¤', excludedIds: [], detailsMap: {} },
+                9: { name: 'å†å²å’Œå€¼æ’é™¤', excludedIds: [], detailsMap: {} },
+                10: { name: 'å†å²è·¨åº¦æ’é™¤', excludedIds: [], detailsMap: {} },
+                11: { name: 'å†å²åŒºé—´æ¯”æ’é™¤', excludedIds: [], detailsMap: {} },
+                12: { name: 'å†å²çƒ­æ¸©å†·æ¯”æ’é™¤', excludedIds: [], detailsMap: {} },
+                13: { name: 'è¿å·ç»„æ•°æ’é™¤', excludedIds: [], detailsMap: {} },
+                14: { name: 'æœ€é•¿è¿å·æ’é™¤', excludedIds: [], detailsMap: {} }
             };
 
             // æ™ºèƒ½æŸ¥è¯¢å·²ç»å¤„ç†äº†åˆ†ç‰‡/å‹ç¼©ï¼Œç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°æ®
@@ -22558,7 +22756,7 @@ app.get('/api/dlt/hwc-positive-tasks/:task_id/period/:period/export', async (req
 
             // æŒ‰ Step é¡ºåºå¤„ç†æ’é™¤æ•°æ®
             let currentRow = 2; // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆç¬¬1è¡Œæ˜¯è¡¨å¤´ï¼‰
-            for (const step of [2, 3, 4, 5, 6, 7, 8, 9, 10]) {
+            for (const step of [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]) {
                 const group = stepGroups[step];
                 if (group.excludedIds.length === 0) continue;
 
@@ -27946,6 +28144,353 @@ app.post('/api/dlt/unified-update', async (req, res) => {
     }
 });
 
+
+/**
+ * ä¸€é”®å¢é‡æ›´æ–°API - åªå¤„ç†æ–°å¢æœŸå·çš„æ•°æ®
+ * POST /api/dlt/unified-update-incremental
+ */
+app.post('/api/dlt/unified-update-incremental', async (req, res) => {
+    const startTime = Date.now();
+    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
+    log('âš¡ å¼€å§‹ä¸€é”®å¢é‡æ›´æ–°æ‰€æœ‰æ•°æ®è¡¨');
+    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
+
+    try {
+        const results = {
+            missingTable: { newRecords: 0 },
+            statistics: { newRecords: 0 },
+            comboFeatures: { newRecords: 0 },
+            hwcOptimized: { createdCount: 0 }
+        };
+
+        // æ­¥éª¤1: å¢é‡æ›´æ–°é—æ¼å€¼è¡¨
+        log('ğŸ“Š [1/4] å¢é‡æ›´æ–°é—æ¼å€¼è¡¨...');
+        const missingResult = await generateMissingTablesIncremental();
+        results.missingTable.newRecords = missingResult.newRecords;
+        log(`   âœ… æ–°å¢ ${missingResult.newRecords} æ¡è®°å½•\n`);
+
+        // æ­¥éª¤2: å¢é‡æ›´æ–°statisticså­—æ®µ
+        log('ğŸ“ˆ [2/4] å¢é‡æ›´æ–°statisticså­—æ®µ...');
+        const statsResult = await generateStatisticsIncremental();
+        results.statistics.newRecords = statsResult.newRecords;
+        log(`   âœ… æ–°å¢ ${statsResult.newRecords} æ¡è®°å½•\n`);
+
+        // æ­¥éª¤3: å¢é‡æ›´æ–°ç»„åˆç‰¹å¾è¡¨
+        log('ğŸ”¢ [3/4] å¢é‡æ›´æ–°ç»„åˆç‰¹å¾è¡¨...');
+        const comboResult = await generateComboFeaturesIncremental();
+        results.comboFeatures.newRecords = comboResult.newRecords;
+        log(`   âœ… æ–°å¢ ${comboResult.newRecords} æ¡è®°å½•\n`);
+
+        // æ­¥éª¤4: å¢é‡æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨ï¼ˆåˆ é™¤æ—§æ¨ç®—æœŸ + å¢é‡æ›´æ–°ï¼‰
+        log('ğŸ”¥ [4/4] å¢é‡æ›´æ–°çƒ­æ¸©å†·ä¼˜åŒ–è¡¨...');
+        const hwcResult = await generateUnifiedHotWarmColdOptimizedTable({ fullRegeneration: false });
+        results.hwcOptimized.createdCount = hwcResult?.createdCount || 0;
+        log(`   âœ… æ–°å¢ ${results.hwcOptimized.createdCount} æ¡è®°å½•\n`);
+
+        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
+        log(`\nâœ… ä¸€é”®å¢é‡æ›´æ–°å®Œæˆï¼Œæ€»è€—æ—¶ ${elapsed} ç§’`);
+        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
+
+        res.json({
+            success: true,
+            totalTime: `${elapsed}ç§’`,
+            results
+        });
+    } catch (error) {
+        log(`âŒ å¢é‡æ›´æ–°å¤±è´¥: ${error.message}`);
+        console.error(error);
+        res.status(500).json({
+            success: false,
+            message: error.message
+        });
+    }
+});
+
+/**
+ * å¢é‡ç”Ÿæˆé—æ¼å€¼è¡¨ - åªå¤„ç†æ–°å¢æœŸå·
+ */
+async function generateMissingTablesIncremental() {
+    // è·å–é—æ¼å€¼è¡¨æœ€æ–°ID
+    const latestRedMissing = await mongoose.connection.db
+        .collection('hit_dlt_basictrendchart_redballmissing_histories')
+        .findOne({}, { sort: { ID: -1 } });
+
+    const latestMissingID = latestRedMissing?.ID || 0;
+
+    // è·å–hit_dltsä¸­æ¯”é—æ¼å€¼è¡¨æ›´æ–°çš„è®°å½•
+    const newRecords = await hit_dlts.find({ ID: { $gt: latestMissingID } })
+        .sort({ ID: 1 }).lean();
+
+    if (newRecords.length === 0) {
+        log('   ğŸ“Š é—æ¼å€¼è¡¨å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°');
+        return { newRecords: 0 };
+    }
+
+    log(`   ğŸ“Š å‘ç° ${newRecords.length} æœŸæ–°æ•°æ®éœ€è¦å¤„ç†`);
+
+    // è·å–ä¸Šä¸€æœŸçš„é—æ¼å€¼çŠ¶æ€ä½œä¸ºèµ·ç‚¹
+    let redMissing = Array(35).fill(0);
+    let blueMissing = Array(12).fill(0);
+
+    if (latestRedMissing) {
+        for (let j = 1; j <= 35; j++) {
+            redMissing[j - 1] = latestRedMissing[String(j)] || 0;
+        }
+        const latestBlueMissing = await mongoose.connection.db
+            .collection('hit_dlt_basictrendchart_blueballmissing_histories')
+            .findOne({ ID: latestMissingID });
+        if (latestBlueMissing) {
+            for (let j = 1; j <= 12; j++) {
+                blueMissing[j - 1] = latestBlueMissing[String(j)] || 0;
+            }
+        }
+    }
+
+    // è®¡ç®—çƒ­æ¸©å†·æ¯”è¾…åŠ©å‡½æ•°
+    const calculateHWCRatio = (missingValues) => {
+        let hot = 0, warm = 0, cold = 0;
+        missingValues.forEach(missing => {
+            if (missing <= 4) hot++;
+            else if (missing <= 9) warm++;
+            else cold++;
+        });
+        return `${hot}:${warm}:${cold}`;
+    };
+
+    const redMissingRecords = [];
+    const blueMissingRecords = [];
+
+    for (const record of newRecords) {
+        const drawnReds = [record.Red1, record.Red2, record.Red3, record.Red4, record.Red5];
+        const drawnBlues = [record.Blue1, record.Blue2];
+
+        // é—æ¼å€¼é€’å¢
+        for (let j = 0; j < 35; j++) redMissing[j]++;
+        for (let j = 0; j < 12; j++) blueMissing[j]++;
+
+        // é‡ç½®å¼€å‡ºå·ç çš„é—æ¼å€¼
+        drawnReds.forEach(ball => { redMissing[ball - 1] = 0; });
+        drawnBlues.forEach(ball => { blueMissing[ball - 1] = 0; });
+
+        const hotWarmColdRatio = calculateHWCRatio(redMissing);
+
+        // çº¢çƒé—æ¼è®°å½•
+        const redRecord = {
+            ID: record.ID,
+            Issue: record.Issue.toString(),
+            DrawingDay: record.DrawDate ? new Date(record.DrawDate).toLocaleDateString('zh-CN') : '',
+            FrontHotWarmColdRatio: hotWarmColdRatio
+        };
+        for (let j = 0; j < 35; j++) {
+            redRecord[(j + 1).toString()] = redMissing[j];
+        }
+        redMissingRecords.push(redRecord);
+
+        // è“çƒé—æ¼è®°å½•
+        const blueRecord = {
+            ID: record.ID,
+            Issue: record.Issue.toString(),
+            DrawingDay: record.DrawDate ? new Date(record.DrawDate).toLocaleDateString('zh-CN') : ''
+        };
+        for (let j = 0; j < 12; j++) {
+            blueRecord[(j + 1).toString()] = blueMissing[j];
+        }
+        blueMissingRecords.push(blueRecord);
+    }
+
+    // æ’å…¥æ–°è®°å½•
+    if (redMissingRecords.length > 0) {
+        await mongoose.connection.db
+            .collection('hit_dlt_basictrendchart_redballmissing_histories')
+            .insertMany(redMissingRecords);
+        await mongoose.connection.db
+            .collection('hit_dlt_basictrendchart_blueballmissing_histories')
+            .insertMany(blueMissingRecords);
+    }
+
+    return { newRecords: newRecords.length };
+}
+
+/**
+ * å¢é‡ç”Ÿæˆstatisticså­—æ®µ - åªå¤„ç†ç¼ºå°‘statisticsçš„è®°å½•
+ */
+async function generateStatisticsIncremental() {
+    // æŸ¥æ‰¾æ²¡æœ‰statisticså­—æ®µçš„è®°å½•
+    const recordsWithoutStats = await hit_dlts.find({
+        $or: [
+            { statistics: { $exists: false } },
+            { statistics: null }
+        ]
+    }).sort({ ID: 1 }).lean();
+
+    if (recordsWithoutStats.length === 0) {
+        log('   ğŸ“ˆ statisticså­—æ®µå·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°');
+        return { newRecords: 0 };
+    }
+
+    log(`   ğŸ“ˆ å‘ç° ${recordsWithoutStats.length} æ¡è®°å½•éœ€è¦æ›´æ–°statistics`);
+
+    // è·å–é—æ¼å€¼æ˜ å°„
+    const allRedMissing = await mongoose.connection.db
+        .collection('hit_dlt_basictrendchart_redballmissing_histories')
+        .find({}).sort({ ID: 1 }).toArray();
+    const missingMap = new Map();
+    allRedMissing.forEach(record => missingMap.set(record.ID, record));
+
+    let updateCount = 0;
+
+    for (const record of recordsWithoutStats) {
+        const reds = [record.Red1, record.Red2, record.Red3, record.Red4, record.Red5];
+        const blues = [record.Blue1, record.Blue2];
+
+        // åŸºç¡€ç»Ÿè®¡
+        const frontSum = reds.reduce((a, b) => a + b, 0);
+        const frontSpan = Math.max(...reds) - Math.min(...reds);
+
+        let zone1 = 0, zone2 = 0, zone3 = 0;
+        reds.forEach(n => {
+            if (n <= 12) zone1++;
+            else if (n <= 24) zone2++;
+            else zone3++;
+        });
+        const frontZoneRatio = `${zone1}:${zone2}:${zone3}`;
+
+        let frontOdd = 0, frontEven = 0;
+        reds.forEach(n => n % 2 === 0 ? frontEven++ : frontOdd++);
+        const frontOddEvenRatio = `${frontOdd}:${frontEven}`;
+
+        const frontAcValue = calculateACValue(reds);
+
+        const backSum = blues.reduce((a, b) => a + b, 0);
+        let backOdd = 0, backEven = 0;
+        blues.forEach(n => n % 2 === 0 ? backEven++ : backOdd++);
+        const backOddEvenRatio = `${backOdd}:${backEven}`;
+
+        // çƒ­æ¸©å†·æ¯”
+        let frontHotWarmColdRatio = '0:0:0';
+        const previousMissingRecord = missingMap.get(record.ID - 1);
+        if (previousMissingRecord) {
+            const missingValues = reds.map(ball => previousMissingRecord[String(ball)] || 0);
+            let hot = 0, warm = 0, cold = 0;
+            missingValues.forEach(missing => {
+                if (missing <= 4) hot++;
+                else if (missing <= 9) warm++;
+                else cold++;
+            });
+            frontHotWarmColdRatio = `${hot}:${warm}:${cold}`;
+        }
+
+        // è¿å·ç»„æ•°
+        const sortedReds = [...reds].sort((a, b) => a - b);
+        let consecutiveCount = 0;
+        for (let j = 0; j < sortedReds.length - 1; j++) {
+            if (sortedReds[j + 1] - sortedReds[j] === 1) consecutiveCount++;
+        }
+
+        // é‡å·æ•°
+        let repeatCount = 0;
+        const previousRecord = await hit_dlts.findOne({ ID: record.ID - 1 }).lean();
+        if (previousRecord) {
+            const prevReds = [previousRecord.Red1, previousRecord.Red2, previousRecord.Red3,
+                             previousRecord.Red4, previousRecord.Red5];
+            repeatCount = reds.filter(r => prevReds.includes(r)).length;
+        }
+
+        const statistics = {
+            frontSum, frontSpan, frontHotWarmColdRatio, frontZoneRatio,
+            frontOddEvenRatio, frontAcValue, backSum, backOddEvenRatio,
+            consecutiveCount, repeatCount
+        };
+
+        await hit_dlts.updateOne({ ID: record.ID }, { $set: { statistics, updatedAt: new Date() } });
+        updateCount++;
+    }
+
+    return { newRecords: updateCount };
+}
+
+/**
+ * å¢é‡ç”Ÿæˆç»„åˆç‰¹å¾è¡¨ - åªå¤„ç†ç¼ºå°‘ç‰¹å¾çš„è®°å½•
+ */
+async function generateComboFeaturesIncremental() {
+    // è·å–ç»„åˆç‰¹å¾è¡¨æœ€æ–°ID
+    const latestCombo = await DLTComboFeatures.findOne({}).sort({ ID: -1 }).lean();
+    const latestComboID = latestCombo?.ID || 0;
+
+    // æŸ¥æ‰¾æ¯”ç»„åˆç‰¹å¾è¡¨æ›´æ–°çš„è®°å½•
+    const newRecords = await hit_dlts.find({ ID: { $gt: latestComboID } })
+        .sort({ ID: 1 }).lean();
+
+    if (newRecords.length === 0) {
+        log('   ğŸ”¢ ç»„åˆç‰¹å¾è¡¨å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°');
+        return { newRecords: 0 };
+    }
+
+    log(`   ğŸ”¢ å‘ç° ${newRecords.length} æ¡è®°å½•éœ€è¦ç”Ÿæˆç»„åˆç‰¹å¾`);
+
+    const generateCombo2 = (balls) => {
+        const combos = [];
+        for (let i = 0; i < balls.length - 1; i++) {
+            for (let j = i + 1; j < balls.length; j++) {
+                combos.push(`${String(balls[i]).padStart(2, '0')}-${String(balls[j]).padStart(2, '0')}`);
+            }
+        }
+        return combos;
+    };
+
+    const generateCombo3 = (balls) => {
+        const combos = [];
+        for (let i = 0; i < balls.length - 2; i++) {
+            for (let j = i + 1; j < balls.length - 1; j++) {
+                for (let k = j + 1; k < balls.length; k++) {
+                    combos.push(`${String(balls[i]).padStart(2, '0')}-${String(balls[j]).padStart(2, '0')}-${String(balls[k]).padStart(2, '0')}`);
+                }
+            }
+        }
+        return combos;
+    };
+
+    const generateCombo4 = (balls) => {
+        const combos = [];
+        for (let i = 0; i < balls.length - 3; i++) {
+            for (let j = i + 1; j < balls.length - 2; j++) {
+                for (let k = j + 1; k < balls.length - 1; k++) {
+                    for (let l = k + 1; l < balls.length; l++) {
+                        combos.push(`${String(balls[i]).padStart(2, '0')}-${String(balls[j]).padStart(2, '0')}-${String(balls[k]).padStart(2, '0')}-${String(balls[l]).padStart(2, '0')}`);
+                    }
+                }
+            }
+        }
+        return combos;
+    };
+
+    const bulkOps = newRecords.map(record => {
+        const balls = [record.Red1, record.Red2, record.Red3, record.Red4, record.Red5].sort((a, b) => a - b);
+        return {
+            updateOne: {
+                filter: { ID: record.ID },
+                update: {
+                    $set: {
+                        Issue: record.Issue.toString(),
+                        combo_2: generateCombo2(balls),
+                        combo_3: generateCombo3(balls),
+                        combo_4: generateCombo4(balls),
+                        updated_at: new Date()
+                    },
+                    $setOnInsert: { created_at: new Date() }
+                },
+                upsert: true
+            }
+        };
+    });
+
+    if (bulkOps.length > 0) {
+        await DLTComboFeatures.bulkWrite(bulkOps, { ordered: false });
+    }
+
+    return { newRecords: newRecords.length };
+}
+
 /**
  * æ‰§è¡Œç»Ÿä¸€æ›´æ–°ä»»åŠ¡ (å¸¦è¿›åº¦æ¨é€)
  */
@@ -28551,11 +29096,15 @@ async function generateUnifiedHotWarmColdOptimizedTable(options = {}) {
         issuesToProcess = allIssues.slice(1); // è·³è¿‡ç¬¬ä¸€æœŸ
     } else {
         // å¢é‡æ›´æ–°ï¼šåªå¤„ç†æ–°å¼€å¥–æœŸ
-        const latestOptimizedRecord = await DLTRedCombinationsHotWarmColdOptimized
-            .findOne({ 'hit_analysis.is_drawn': true })
-            .sort({ target_issue: -1 })
-            .select('target_issue')
-            .lean();
+        // â­ ä¿®å¤BUGï¼šä½¿ç”¨èšåˆç®¡é“å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—åæ’åºï¼Œé¿å…å­—å…¸åºæ’åºé—®é¢˜
+        const latestOptimizedRecords = await DLTRedCombinationsHotWarmColdOptimized.aggregate([
+            { $match: { 'hit_analysis.is_drawn': true } },
+            { $addFields: { target_issue_num: { $toInt: '$target_issue' } } },
+            { $sort: { target_issue_num: -1 } },
+            { $limit: 1 },
+            { $project: { target_issue: 1 } }
+        ]);
+        const latestOptimizedRecord = latestOptimizedRecords[0] || null;
 
         const latestProcessedIssue = latestOptimizedRecord ?
             parseInt(latestOptimizedRecord.target_issue) : 0;
@@ -28649,21 +29198,26 @@ async function generateUnifiedHotWarmColdOptimizedTable(options = {}) {
                     ratioCounts[ratio] = combinationIds.length;
                 }
 
-                // ä¿å­˜åˆ°æ•°æ®åº“
-                await DLTRedCombinationsHotWarmColdOptimized.create({
-                    base_issue: baseIssueStr,
-                    target_issue: targetIssueStr,
-                    hot_warm_cold_data: hotWarmColdData,
-                    total_combinations: allRedCombinations.length,
-                    hit_analysis: {
-                        target_winning_reds: [targetIssue.Red1, targetIssue.Red2, targetIssue.Red3, targetIssue.Red4, targetIssue.Red5],
-                        target_winning_blues: [targetIssue.Blue1, targetIssue.Blue2],
-                        red_hit_data: {},
-                        hit_statistics: { hit_0: 0, hit_1: 0, hit_2: 0, hit_3: 0, hit_4: 0, hit_5: 0 },
-                        is_drawn: true
+                // ä¿å­˜åˆ°æ•°æ®åº“ - ä½¿ç”¨upserté¿å…é‡å¤é”®é”™è¯¯
+                await DLTRedCombinationsHotWarmColdOptimized.findOneAndUpdate(
+                    { base_issue: baseIssueStr, target_issue: targetIssueStr },
+                    {
+                        $set: {
+                            hot_warm_cold_data: hotWarmColdData,
+                            total_combinations: allRedCombinations.length,
+                            hit_analysis: {
+                                target_winning_reds: [targetIssue.Red1, targetIssue.Red2, targetIssue.Red3, targetIssue.Red4, targetIssue.Red5],
+                                target_winning_blues: [targetIssue.Blue1, targetIssue.Blue2],
+                                red_hit_data: {},
+                                hit_statistics: { hit_0: 0, hit_1: 0, hit_2: 0, hit_3: 0, hit_4: 0, hit_5: 0 },
+                                is_drawn: true
+                            },
+                            statistics: { ratio_counts: ratioCounts },
+                            updated_at: new Date()
+                        }
                     },
-                    statistics: { ratio_counts: ratioCounts }
-                });
+                    { upsert: true, new: true }
+                );
 
                 createdCount++;
                 processedCount++;
