# 大乐透数据管理后台 - 使用说明

## 📋 目录

1. [概述](#概述)
2. [访问方式](#访问方式)
3. [功能模块](#功能模块)
4. [数据更新流程](#数据更新流程)
5. [API接口说明](#api接口说明)
6. [常见问题](#常见问题)

---

## 概述

**大乐透数据管理后台**是用于管理HIT大乐透数据分析系统核心数据的专用工具。当有新的开奖记录时，需要使用此后台导入数据并更新相关衍生数据表。

### 核心功能
- ✅ 新开奖数据导入 (手动输入/JSON批量)
- ✅ 自动更新所有衍生数据表
- ✅ 数据状态实时监控
- ✅ 过期缓存清理
- ✅ 操作日志追踪

---

## 访问方式

### 方式1: 通过菜单 (推荐)
1. 启动HIT数据分析系统
2. 点击顶部菜单: **工具 → 数据管理后台**
3. 或使用快捷键: **Ctrl+M** (Windows) / **Cmd+M** (macOS)

### 方式2: 直接访问URL
在浏览器中打开: `http://localhost:3003/admin.html`

---

## 功能模块

### 📈 数据状态监控

显示系统各数据表的实时状态，包括:

| 数据表 | 说明 | 状态检查 |
|--------|------|----------|
| **HIT_DLT** | 主开奖记录表 | 总记录数、最新期号 |
| **DLTRedMissing** | 红球遗漏值表 | 同步状态、落后期数 |
| **DLTBlueMissing** | 蓝球遗漏值表 | 同步状态、落后期数 |
| **DLTComboFeatures** | 组合特征表 | 同步状态、落后期数 |
| **statistics字段** | 统计数据 | 完整性检查 |

**状态指示:**
- ✅ **绿色 (已同步)**: 数据表与主表完全同步
- ⚠️ **黄色 (需更新)**: 数据表落后主表，需要更新

---

### 📥 数据导入

#### 方式1: 手动输入 (单条记录)

**适用场景**: 每周新开奖后，添加1-2期数据

**操作步骤**:
1. 选择导入方式: **手动输入**
2. 填写字段:
   - **期号**: 例如 `25121` (7位数字)
   - **红球**: 5个号码 (1-35范围)
   - **蓝球**: 2个号码 (1-12范围)
   - **开奖日期**: 选择日期
3. 勾选 "导入后自动更新衍生数据表" (推荐)
4. 点击 **✅ 添加开奖记录**

**示例**:
```
期号: 25121
红球: 3, 7, 15, 22, 28
蓝球: 5, 9
开奖日期: 2025-10-25
```

**验证规则**:
- ✅ 红球不重复
- ✅ 蓝球不重复
- ✅ 号码在合法范围内
- ✅ 期号唯一性检查

---

#### 方式2: JSON批量导入

**适用场景**: 初次导入历史数据，或批量补充多期数据

**操作步骤**:
1. 选择导入方式: **JSON批量导入**
2. 在文本框中输入JSON数组格式的数据
3. 勾选 "导入后自动更新衍生数据表"
4. 点击 **✅ 批量导入**

**JSON格式示例**:
```json
[
  {
    "Issue": "25121",
    "Red1": 3,
    "Red2": 7,
    "Red3": 15,
    "Red4": 22,
    "Red5": 28,
    "Blue1": 5,
    "Blue2": 9,
    "DrawDate": "2025-10-25",
    "PoolPrize": "1000000000",
    "TotalSales": "500000000"
  },
  {
    "Issue": "25122",
    "Red1": 5,
    "Red2": 12,
    "Red3": 18,
    "Red4": 25,
    "Red5": 33,
    "Blue1": 2,
    "Blue2": 11,
    "DrawDate": "2025-10-28"
  }
]
```

**字段说明**:
- **必填字段**: `Issue`, `Red1-Red5`, `Blue1-Blue2`, `DrawDate`
- **可选字段**: `PoolPrize`, `FirstPrizeCount`, `FirstPrizeAmount`, `SecondPrizeCount`, `SecondPrizeAmount`, `TotalSales`

**导入结果**:
系统会返回详细的导入报告:
- ✅ **成功**: 已成功导入的期号
- ⚠️ **跳过**: 已存在的期号
- ❌ **失败**: 验证失败或错误的记录

---

### 🔄 数据更新管理

#### 需要更新的数据表 (全自动)

导入新开奖数据后，系统需要更新以下衍生数据表:

| 序号 | 数据表 | 作用 | 更新内容 |
|------|--------|------|----------|
| 1 | **遗漏值表** | 记录每个号码的未出现期数 | 基于最新开奖计算所有号码遗漏值 |
| 2 | **组合特征表** | 存储号码的2/3/4码组合 | 生成新期号的组合特征 |
| 3 | **statistics字段** | 和值、跨度、区间比等统计 | 计算新期号的统计数据 |
| 4 | **热温冷比优化表** | 预计算热温冷比 | 生成新期号的热温冷比映射表 |

#### 一键更新操作

**触发方式**:
1. **自动触发**: 导入数据时勾选"导入后自动更新"
2. **手动触发**: 点击 **🚀 一键更新全部数据表** 按钮

**更新过程**:
```
开始更新
  ↓
[1/6] 生成遗漏值表
  ↓
[2/6] 生成组合特征表
  ↓
[3/6] 生成statistics字段 ⭐ (包含热温冷比)
  ↓
[4/6] 生成热温冷比优化表
  ↓
[5/6] 清理过期缓存
  ↓
[6/6] 验证数据完整性
  ↓
完成✓
```

**预计耗时**:
- 单期更新: 约30秒 - 2分钟
- 全量更新 (100+期): 约5-15分钟

**更新模式**:
- **repair模式** (默认): 快速修复，只更新缺失数据
- **full模式**: 全量重建所有数据

---

### 🧹 清理过期缓存

**作用**: 删除过期的热温冷比缓存，释放数据库空间

**触发条件**:
- 目标期号 < 最新期号的缓存将被清理

**操作步骤**:
1. 点击 **🧹 清理过期缓存** 按钮
2. 确认操作
3. 查看清理结果 (显示清理数量)

---

### 📋 操作日志

实时显示所有操作的日志信息:
- 🔵 **INFO (蓝色)**: 普通信息
- 🟢 **SUCCESS (绿色)**: 成功操作
- 🔴 **ERROR (红色)**: 错误信息

**日志示例**:
```
[21:30:15] [系统] 管理后台已就绪
[21:30:16] [信息] 正在获取数据状态...
[21:30:17] [成功] 数据状态刷新成功
[21:32:45] [信息] 正在添加期号 25121...
[21:32:46] [成功] ✅ 期号 25121 添加成功 (ID: 2547)
[21:32:47] [信息] 自动触发数据更新中，请稍候...
[21:33:50] [成功] ✅ 数据更新完成，请检查数据状态
```

---

## 数据更新流程

### 完整工作流程图

```
┌──────────────────────────────────────┐
│  新一期大乐透开奖 (例: 25121期)       │
└──────────────┬───────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│  步骤1: 打开数据管理后台              │
│  (工具 → 数据管理后台)                │
└──────────────┬───────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│  步骤2: 导入新开奖数据                │
│  • 手动输入: 填写期号、红球、蓝球      │
│  • 或JSON导入: 粘贴JSON数据           │
│  ✅ 勾选"自动更新衍生数据表"           │
└──────────────┬───────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│  步骤3: 系统自动执行更新 (后台运行)    │
│  [1/6] 遗漏值表                       │
│  [2/6] 组合特征表                     │
│  [3/6] statistics字段                │
│  [4/6] 热温冷比优化表                 │
│  [5/6] 清理过期缓存                   │
│  [6/6] 数据验证                       │
└──────────────┬───────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│  步骤4: 验证数据状态                  │
│  • 点击"刷新状态"                      │
│  • 检查所有表是否"✅ 已同步"            │
└──────────────┬───────────────────────┘
               │
               ↓
┌──────────────────────────────────────┐
│  完成! 系统可正常使用新数据            │
└──────────────────────────────────────┘
```

### 每周标准操作流程

**场景**: 每周一、三、六开奖后更新数据

**步骤**:
1. **准备数据**
   - 从官方网站获取最新开奖结果
   - 记录期号、红球、蓝球、开奖日期

2. **打开后台**
   - 快捷键: `Ctrl+M` 或 菜单: 工具 → 数据管理后台

3. **导入数据**
   - 选择"手动输入"方式
   - 填写所有必填字段
   - ✅ 勾选"导入后自动更新"
   - 点击"添加开奖记录"

4. **等待更新** (约1-2分钟)
   - 观察操作日志
   - 等待"数据更新完成"提示

5. **验证结果**
   - 点击"刷新状态"
   - 确认所有数据表显示"✅ 已同步"

6. **完成**
   - 关闭管理后台
   - 系统已可使用最新数据进行预测

**预计耗时**: 3-5分钟

---

## API接口说明

### 后台管理API列表

#### 1. 数据导入API

**批量导入**
```http
POST http://localhost:3003/api/admin/dlt/import-draw-data
Content-Type: application/json

{
  "drawData": [
    {
      "Issue": "25121",
      "Red1": 3, "Red2": 7, "Red3": 15, "Red4": 22, "Red5": 28,
      "Blue1": 5, "Blue2": 9,
      "DrawDate": "2025-10-25"
    }
  ],
  "autoUpdate": true
}
```

**单条添加**
```http
POST http://localhost:3003/api/admin/dlt/add-single-record
Content-Type: application/json

{
  "issue": "25121",
  "redBalls": [3, 7, 15, 22, 28],
  "blueBalls": [5, 9],
  "drawDate": "2025-10-25",
  "autoUpdate": true
}
```

#### 2. 数据状态查询API

```http
GET http://localhost:3003/api/dlt/data-status
```

**返回示例**:
```json
{
  "success": true,
  "data": {
    "latestIssue": 25121,
    "totalRecords": 2547,
    "tables": [
      {
        "name": "HIT_DLT",
        "count": 2547,
        "latestIssue": 25121,
        "status": "ok"
      },
      {
        "name": "DLTRedMissing",
        "count": 2547,
        "latestIssue": 25121,
        "status": "ok"
      }
    ],
    "needsUpdate": false
  }
}
```

#### 3. 统一更新API

```http
POST http://localhost:3003/api/dlt/unified-update
Content-Type: application/json

{
  "mode": "repair"
}
```

**模式说明**:
- `repair`: 快速修复模式 (推荐)
- `full`: 全量重建模式

#### 4. 清理缓存API

```http
POST http://localhost:3003/api/dlt/cleanup-expired-cache
```

---

## 常见问题

### Q1: 导入数据后为什么要更新衍生数据表?

**A**: 大乐透预测系统依赖多个预计算的数据表来提升性能:
- **遗漏值表**: 计算热号、温号、冷号
- **组合特征表**: 用于同出/相克分析
- **热温冷比优化表**: 预计算32万个组合的热温冷比，避免实时计算

如果不更新这些表，系统将无法正确分析最新一期的数据。

---

### Q2: 自动更新需要多长时间?

**A**: 取决于导入的数据量:
- **单期更新**: 30秒 - 2分钟
- **批量更新 (10期)**: 3-5分钟
- **全量更新 (100+期)**: 5-15分钟

更新过程在**后台异步执行**，不会阻塞界面操作。

---

### Q3: 如何判断数据更新是否完成?

**A**: 有3种方式:
1. **查看操作日志**: 等待 "✅ 数据更新完成" 日志
2. **刷新数据状态**: 所有表显示 "✅ 已同步"
3. **等待时间**: 一般2分钟后手动刷新状态

---

### Q4: 更新失败怎么办?

**A**: 按以下步骤排查:
1. **查看操作日志**: 找到错误信息
2. **检查MongoDB**: 确保MongoDB服务正在运行
3. **手动触发更新**: 点击 "🚀 一键更新全部数据表"
4. **查看控制台**: 打开开发者工具 (F12) 查看详细错误

常见错误:
- `MongoDB连接失败`: 启动MongoDB服务
- `端口3003占用`: 关闭占用端口的程序
- `内存不足`: 关闭其他应用释放内存

---

### Q5: 红球组合表需要更新吗?

**A**: **不需要!**

红球组合表 (`DLTRedCombinations`) 存储的是固定的C(35,5) = 324,632种组合，与具体期号无关，一次生成后**永久有效**。

**需要更新的表**:
- ✅ 遗漏值表 (依赖最新开奖)
- ✅ 组合特征表 (依赖最新开奖)
- ✅ statistics字段 (依赖最新开奖)
- ✅ 热温冷比优化表 (依赖最新遗漏值)

**不需要更新的表**:
- ❌ 红球组合表 (固定组合)
- ❌ 蓝球组合表 (固定组合)

---

### Q6: 可以删除旧的开奖记录吗?

**A**: **强烈不建议!**

删除历史开奖记录会导致:
- ❌ 遗漏值计算错误
- ❌ 历史趋势分析失效
- ❌ 热温冷比分析不准确
- ❌ 规律发现功能失效

如果确需删除，务必:
1. 先备份数据库
2. 删除后重新执行"全量更新"
3. 验证所有功能正常

---

### Q7: 如何备份数据?

**A**: 有两种方式:
1. **通过菜单**: 工具 → 数据库管理 → 备份数据库
2. **手动备份MongoDB**: 导出`lottery`数据库

**推荐备份频率**: 每月1次，或在大量数据导入前

---

### Q8: 如何初始化系统 (全新安装)?

**A**: 完整初始化流程:

1. **准备历史数据CSV文件**
   - 从官方网站下载历史开奖数据
   - 整理为JSON格式

2. **批量导入历史数据**
   - 打开数据管理后台
   - 使用"JSON批量导入"
   - 导入所有历史数据

3. **执行一键更新**
   - 点击"🚀 一键更新全部数据表"
   - 选择`full`模式
   - 等待15-30分钟

4. **验证数据**
   - 刷新数据状态
   - 确认所有表已同步

5. **完成!** 系统可正常使用

---

## 技术支持

如有问题，请联系开发团队或查看:
- **项目文档**: `CLAUDE.md`
- **API文档**: `src/server/server.js` (行18943起)
- **GitHub Issues**: 报告Bug或提出建议

---

**版本**: 1.0
**最后更新**: 2025-10-26
**作者**: HIT数据分析系统开发团队
