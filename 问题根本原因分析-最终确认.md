# çƒ­æ¸©å†·æ­£é€‰æ‰¹é‡é¢„æµ‹ - é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ (æœ€ç»ˆç¡®è®¤)

**è¯Šæ–­æ—¥æœŸ**: 2025-11-05
**è¯Šæ–­è„šæœ¬**: `diagnose-correct-schema-fields.js`
**çŠ¶æ€**: âœ… æ ¹æœ¬åŸå› å·²ç¡®è®¤

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜è¡¨ç°
ç”¨æˆ·çœ‹åˆ°çš„ä»»åŠ¡å¡è¯¦æƒ…é¢æ¿æ˜¾ç¤º:
```
æœŸå· 25114: ç»„åˆæ•° 3,858 | çº¢çƒæœ€é«˜å‘½ä¸­ 0/5 | è“çƒæœ€é«˜å‘½ä¸­ 0/2 | å‘½ä¸­ç‡ 0.00% | æ€»å¥–é‡‘ Â¥0
æœŸå· 25115: ç»„åˆæ•° 3,858 | çº¢çƒæœ€é«˜å‘½ä¸­ 0/5 | è“çƒæœ€é«˜å‘½ä¸­ 0/2 | å‘½ä¸­ç‡ 0.00% | æ€»å¥–é‡‘ Â¥0
```

**æ‰€æœ‰å‘½ä¸­ç»Ÿè®¡æ•°æ®å…¨éƒ¨ä¸º0ï¼Œå³ä½¿è¿™äº›æœŸå·å·²ç»å¼€å¥–ã€‚**

---

## ğŸ” è¯Šæ–­å‘ç°

### ä¹‹å‰çš„è¯¯åˆ¤ âŒ
ä¹‹å‰çš„è¯Šæ–­è„šæœ¬ (`diagnose-hit-statistics-issue.js`) **é”™è¯¯åœ°è®¤ä¸º**:
- ä»»åŠ¡è¡¨çš„ `base_issue`ã€`target_issue` å­—æ®µä¸º undefined
- ç»“æœè¡¨çš„ `red_balls`ã€`blue_balls` å­—æ®µç¼ºå¤±

**çœŸç›¸**: è¿™äº›å¹³é¢å­—æ®µæ ¹æœ¬ä¸åœ¨Schemaä¸­ï¼ŒSchemaä½¿ç”¨çš„æ˜¯åµŒå¥—ç»“æ„ï¼

### å®é™…Schemaç»“æ„ âœ…

#### ä»»åŠ¡è¡¨Schema (æ­£ç¡®):
```javascript
{
  period_range: {
    type: 'recent',
    start: '25115',   // âœ… æœ‰å€¼
    end: '25125',     // âœ… æœ‰å€¼
    total: 11,        // âœ… æœ‰å€¼
    predicted_count: 1
  },
  positive_selection: {
    hwc_ratios: ["4:1:0"],
    zone_ratios: ["2:1:2"],
    odd_even_ratios: ["2:3","3:2"]
  },
  output_config: {
    enableHitAnalysis: false,  // âŒ æœªå¯ç”¨ï¼
    pairingMode: undefined     // âŒ æœªå®šä¹‰ï¼
  }
}
```

#### ç»“æœè¡¨Schema (æ­£ç¡®):
```javascript
{
  paired_combinations: [],  // âŒ ç©ºæ•°ç»„ï¼å…³é”®é—®é¢˜
  hit_analysis: {
    max_red_hit: 0,
    max_blue_hit: 0,
    prize_stats: {
      first_prize: { count: 0 },
      second_prize: { count: 0 },
      // ...
    }
  },
  winning_numbers: {  // âœ… æœ‰å¼€å¥–æ•°æ®
    red: [2,3,8,13,21],
    blue: [7,12]
  }
}
```

---

## ğŸ’¡ æ ¹æœ¬åŸå› 

### åŸå› 1: `paired_combinations` æ•°ç»„ä¸ºç©º âš ï¸ P0
**ä½ç½®**: `src/server/server.js:16280-16293`

**å½“å‰ä»£ç **:
```javascript
await HwcPositivePredictionTaskResult.create({
    result_id: resultId,
    task_id: taskId,
    period: periodResult.target_issue,
    red_combinations: periodResult.red_combinations.map(c => c.combination_id),  // åªä¿å­˜ID
    blue_combinations: (periodResult.blue_combinations || []).map(c => c.combination_id),  // åªä¿å­˜ID
    combination_count: combinationCount,
    pairing_mode: periodResult.pairing_mode || 'default',
    hit_analysis: periodResult.hit_analysis || {},
    // âŒ ç¼ºå°‘ï¼špaired_combinations å­—æ®µæœªä¿å­˜ï¼
});
```

**é—®é¢˜**:
- åªä¿å­˜äº†deprecatedçš„ `red_combinations` å’Œ `blue_combinations` (ä»…IDåˆ—è¡¨)
- **æ²¡æœ‰ä¿å­˜ `paired_combinations`** (åŒ…å«çƒå·çš„å®Œæ•´é…å¯¹æ•°æ®)
- æ²¡æœ‰çƒå·æ•°æ®ï¼Œå°±æ— æ³•è¿›è¡Œå‘½ä¸­åˆ†æï¼

### åŸå› 2: å‘½ä¸­åˆ†ææœªå¯ç”¨ âš ï¸ P0
**ä½ç½®**: `src/server/server.js:16249`

**å½“å‰ä»£ç **:
```javascript
enableValidation: task.output_config?.enableHitAnalysis || false,
```

**é—®é¢˜**:
- ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œ`output_config.enableHitAnalysis` é»˜è®¤ä¸º **false**
- å³ä½¿æœ‰é…å¯¹æ•°æ®å’Œå¼€å¥–æ•°æ®ï¼Œå‘½ä¸­åˆ†æä¹Ÿä¸ä¼šæ‰§è¡Œ

### åŸå› 3: é…å¯¹æ¨¡å¼æœªä¼ é€’ âš ï¸ P1
**ä½ç½®**: `src/server/server.js:16250`

**å½“å‰ä»£ç **:
```javascript
combination_mode: task.output_config?.pairingMode || 'truly-unlimited'
```

**é—®é¢˜**:
- ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œ`output_config.pairingMode` ä¸º undefined
- è™½ç„¶æœ‰fallbackå€¼ `'truly-unlimited'`ï¼Œä½†ä»»åŠ¡è®°å½•ä¸­çœ‹ä¸åˆ°ç”¨æˆ·å®é™…é€‰æ‹©çš„æ¨¡å¼

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä¿å­˜ `paired_combinations` æ•°æ® (P0)

**ä½ç½®**: `src/server/server.js:16280-16293`

**æ–¹æ¡ˆA - æ‰©å±•ç°æœ‰ä¿å­˜é€»è¾‘** (æ¨è):
```javascript
// æ„å»ºpaired_combinationsæ•°ç»„
const pairedCombinations = [];

// æ ¹æ®pairing_modeç”Ÿæˆé…å¯¹
if (periodResult.pairing_mode === 'truly-unlimited') {
    // å…¨ç¬›å¡å°”ç§¯æ¨¡å¼
    for (const redCombo of periodResult.red_combinations) {
        for (const blueCombo of periodResult.blue_combinations) {
            pairedCombinations.push({
                red_combo_id: redCombo.combination_id,
                red_balls: redCombo.balls,  // å‡è®¾ HwcPositivePredictor è¿”å›çƒå·
                blue_combo_id: blueCombo.combination_id,
                blue_balls: blueCombo.balls
            });
        }
    }
} else if (periodResult.pairing_mode === 'default') {
    // å›ºå®šé…å¯¹æ¨¡å¼ (1:1)
    for (let i = 0; i < periodResult.red_combinations.length; i++) {
        const redCombo = periodResult.red_combinations[i];
        const blueCombo = periodResult.blue_combinations[i % periodResult.blue_combinations.length];
        pairedCombinations.push({
            red_combo_id: redCombo.combination_id,
            red_balls: redCombo.balls,
            blue_combo_id: blueCombo.combination_id,
            blue_balls: blueCombo.balls
        });
    }
}

await HwcPositivePredictionTaskResult.create({
    result_id: resultId,
    task_id: taskId,
    period: periodResult.target_issue,
    red_combinations: periodResult.red_combinations.map(c => c.combination_id),
    blue_combinations: (periodResult.blue_combinations || []).map(c => c.combination_id),
    combination_count: combinationCount,
    paired_combinations: pairedCombinations,  // âœ… æ·»åŠ æ­¤å­—æ®µ
    pairing_mode: periodResult.pairing_mode || 'default',
    hit_analysis: periodResult.hit_analysis || {},
    exclusion_summary: periodResult.exclusion_summary || {},
    positive_selection_details: periodResult.positive_selection_details || {},
    created_at: new Date()
});
```

**æ–¹æ¡ˆB - è®© HwcPositivePredictor ç›´æ¥è¿”å› paired_combinations**:

éœ€è¦ä¿®æ”¹ `HwcPositivePredictor.streamPredict()` çš„è¿”å›æ ¼å¼ï¼Œåœ¨ `periodResult` ä¸­ç›´æ¥åŒ…å« `paired_combinations` æ•°ç»„ã€‚

### ä¿®å¤2: é»˜è®¤å¯ç”¨å‘½ä¸­åˆ†æ (P0)

**ä½ç½®**: `src/server/server.js:19503-19508`

**ä¿®æ”¹**:
```javascript
// å½“å‰ä»£ç 
const safeOutputConfig = output_config || {
    enableHitAnalysis: true,   // âœ… å·²ç»æ˜¯ true
    pairingMode: 'truly-unlimited'
};
```

**æ£€æŸ¥**: ç¡®ä¿å‰ç«¯åˆ›å»ºä»»åŠ¡æ—¶ï¼Œç¡®å®ä¼ é€’äº† `output_config` ä¸” `enableHitAnalysis: true`ã€‚

**å‰ç«¯æ£€æŸ¥ä½ç½®**: `src/renderer/dlt-module.js` (çº¦è¡Œ10500-10800ï¼Œæœç´¢ä»»åŠ¡åˆ›å»ºè¡¨å•)

### ä¿®å¤3: ç¡®ä¿é…å¯¹æ¨¡å¼æ­£ç¡®ä¼ é€’ (P1)

**å‰ç«¯æ£€æŸ¥**:
1. ç”¨æˆ·é€‰æ‹©é…å¯¹æ¨¡å¼æ—¶ï¼Œç¡®ä¿åŒ…å«åœ¨è¯·æ±‚bodyçš„ `output_config.pairingMode` ä¸­
2. åç«¯æ¥æ”¶æ—¶ï¼Œä¸è¦è¢«è¦†ç›–

---

## ğŸ“‹ éªŒè¯æ­¥éª¤

### æ­¥éª¤1: éªŒè¯å½“å‰çŠ¶æ€
```bash
node diagnose-correct-schema-fields.js
```

æ£€æŸ¥è¾“å‡º:
- `paired_combinationsæ•°é‡: 0` âŒ (å½“å‰é—®é¢˜)
- `å¯ç”¨å‘½ä¸­åˆ†æ: âŒ å¦` (å½“å‰é—®é¢˜)
- `é…å¯¹æ¨¡å¼: âŒ undefined` (å½“å‰é—®é¢˜)

### æ­¥éª¤2: ä¿®å¤åéªŒè¯
1. ä¿®æ”¹ `src/server/server.js:16280-16293` æ·»åŠ  `paired_combinations` æ„å»ºé€»è¾‘
2. ç¡®è®¤å‰ç«¯ä¼ é€’ `output_config.enableHitAnalysis = true`
3. ç¡®è®¤å‰ç«¯ä¼ é€’ `output_config.pairingMode`

### æ­¥éª¤3: åˆ›å»ºæµ‹è¯•ä»»åŠ¡
```bash
# é€šè¿‡APIåˆ›å»ºæµ‹è¯•ä»»åŠ¡
curl -X POST http://localhost:3003/api/dlt/hwc-positive-tasks/create \
  -H "Content-Type: application/json" \
  -d '{
    "task_name": "ä¿®å¤æµ‹è¯•",
    "period_range": {
      "type": "custom",
      "value": { "start": "25120", "end": "25124" }
    },
    "positive_selection": {
      "hwc_ratios": ["4:1:0"],
      "zone_ratios": ["2:1:2"],
      "odd_even_ratios": ["2:3","3:2"]
    },
    "exclusion_conditions": {},
    "output_config": {
      "enableHitAnalysis": true,
      "pairingMode": "truly-unlimited"
    }
  }'
```

### æ­¥éª¤4: ç­‰å¾…ä»»åŠ¡å®ŒæˆåéªŒè¯
```bash
node diagnose-correct-schema-fields.js
```

æœŸæœ›è¾“å‡º:
- `paired_combinationsæ•°é‡: > 0` âœ…
- `å¯ç”¨å‘½ä¸­åˆ†æ: âœ… æ˜¯` âœ…
- `é…å¯¹æ¨¡å¼: truly-unlimited` âœ…
- `çº¢çƒæœ€é«˜å‘½ä¸­: > 0` âœ… (å¦‚æœæœ‰ä¸­å¥–)

---

## ğŸ¯ å…³é”®è¦ç‚¹

### ä¸ºä»€ä¹ˆä¹‹å‰çš„è¯Šæ–­æ˜¯é”™è¯¯çš„?

1. **å­—æ®µåè¯¯è§£**: é”™è¯¯åœ°å¯»æ‰¾ `base_issue`ã€`target_issue` ç­‰å¹³é¢å­—æ®µï¼Œå®é™…Schemaä½¿ç”¨åµŒå¥—ç»“æ„ `period_range.start/end`
2. **Schemaä¸ç†Ÿæ‚‰**: æ²¡æœ‰ä»”ç»†é˜…è¯»Schemaå®šä¹‰ (`src/server/server.js:1037-1317`)
3. **æ•°æ®ç»“æ„å‡è®¾**: å‡è®¾ç»“æœè¡¨æœ‰å¹³é¢çš„ `red_balls`ã€`blue_balls` å­—æ®µï¼Œå®é™…æ˜¯ `paired_combinations` æ•°ç»„

### çœŸæ­£çš„é—®é¢˜æ˜¯ä»€ä¹ˆ?

1. **æ•°æ®æœªä¿å­˜**: `paired_combinations` æ•°ç»„åœ¨ç»“æœä¿å­˜æ—¶æœªæ„å»º
2. **åŠŸèƒ½æœªå¯ç”¨**: `enableHitAnalysis` ä¸º falseï¼Œå‘½ä¸­åˆ†æè¢«è·³è¿‡
3. **æ¨¡å¼æœªè®°å½•**: `pairingMode` undefinedï¼Œæ— æ³•è¿½è¸ªç”¨æˆ·é€‰æ‹©

### æœ€é‡è¦çš„ä¿®å¤æ˜¯ä»€ä¹ˆ?

**ä¼˜å…ˆçº§P0 (é˜»å¡)**: ä¿®å¤ `paired_combinations` ä¿å­˜é€»è¾‘

æ²¡æœ‰é…å¯¹çƒå·æ•°æ®ï¼Œå³ä½¿å¯ç”¨å‘½ä¸­åˆ†æä¹Ÿæ— æ³•è®¡ç®—ï¼å¿…é¡»å…ˆä¿å­˜é…å¯¹æ•°æ®ã€‚

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|------|------|------|
| src/server/server.js | 1037-1215 | ä»»åŠ¡Schemaå®šä¹‰ |
| src/server/server.js | 1218-1317 | ç»“æœSchemaå®šä¹‰ |
| src/server/server.js | 16197-16346 | processHwcPositiveTask ä»»åŠ¡å¤„ç†å‡½æ•° |
| src/server/server.js | 16280-16293 | **ç»“æœä¿å­˜é€»è¾‘ (éœ€ä¿®æ”¹)** |
| src/server/server.js | 19436-19549 | ä»»åŠ¡åˆ›å»ºAPI |
| src/server/server.js | 19503-19508 | output_config é»˜è®¤å€¼è®¾ç½® |
| src/renderer/dlt-module.js | ~10500-10800 | å‰ç«¯ä»»åŠ¡åˆ›å»ºè¡¨å• (éœ€æ£€æŸ¥) |

---

## â­ï¸ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)
1. âœ… å·²è¯Šæ–­å‡ºæ ¹æœ¬åŸå› 
2. â³ ä¿®å¤ `paired_combinations` ä¿å­˜é€»è¾‘
3. â³ æ£€æŸ¥å‰ç«¯ `output_config` ä¼ é€’
4. â³ åˆ›å»ºæµ‹è¯•ä»»åŠ¡éªŒè¯ä¿®å¤

### æœ¬å‘¨å®Œæˆ
5. â³ é‡æ–°å¤„ç†æ‰€æœ‰å†å²ä»»åŠ¡ï¼Œå¡«å…… `paired_combinations`
6. â³ éªŒè¯å‘½ä¸­ç»Ÿè®¡è®¡ç®—å‡†ç¡®æ€§
7. â³ æ›´æ–°æ–‡æ¡£è¯´æ˜æ­£ç¡®çš„æ•°æ®ç»“æ„

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-05
**è¯Šæ–­è„šæœ¬**: `diagnose-correct-schema-fields.js`
**ä¿®å¤éš¾åº¦**: ä¸­ç­‰ (éœ€è¦ç†è§£é…å¯¹é€»è¾‘å’Œæ•°æ®æµ)
**é¢„è®¡ä¿®å¤æ—¶é—´**: 2-4å°æ—¶

