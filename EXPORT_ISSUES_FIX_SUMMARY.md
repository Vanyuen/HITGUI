# å¯¼å‡ºåŠŸèƒ½é—®é¢˜ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-11-05
**çŠ¶æ€**: âœ… éƒ¨åˆ†ä¿®å¤ / âš ï¸ æ•°æ®é—®é¢˜éœ€è¯´æ˜

---

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šå¯¼å‡ºExcelæ—¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

### é—®é¢˜1: è“çƒå…¨æ˜¯01å’Œ02
**ç—‡çŠ¶**: å¯¼å‡ºçš„Excelä¸­ï¼Œæ‰€æœ‰ç»„åˆçš„è“çƒéƒ½æ˜¾ç¤ºä¸º`01, 02`

### é—®é¢˜2: æ²¡æœ‰ä¸­å¥–ä¿¡æ¯å¯¼å‡º
**ç—‡çŠ¶**: å¯¼å‡ºçš„Excelä¸­æ²¡æœ‰çº¢çƒå‘½ä¸­ã€è“çƒå‘½ä¸­ã€ä¸­å¥–ç­‰çº§ã€å¥–é‡‘ç­‰åˆ—

---

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: è“çƒæ•°æ®é—®é¢˜ï¼ˆæ•°æ®æºé—®é¢˜ï¼Œéä»£ç BUGï¼‰

**è¯Šæ–­ç»“æœ**:

```javascript
// ä»»åŠ¡ hwc-pos-20251105-2dq çš„æ•°æ®
{
  task_id: 'hwc-pos-20251105-2dq',
  period: 25114,
  red_combinations: [256, 257, 258, 260, 261, ...], // å¤šä¸ªçº¢çƒç»„åˆID
  blue_combinations: [1],  // âŒ åªæœ‰1ä¸ªè“çƒç»„åˆID
  paired_combinations: [
    { red_balls: [1,2,3,13,26], blue_balls: [1,2] },  // è“çƒéƒ½æ˜¯[1,2]
    { red_balls: [1,2,3,13,27], blue_balls: [1,2] },  // è“çƒéƒ½æ˜¯[1,2]
    { red_balls: [1,2,3,13,28], blue_balls: [1,2] },  // è“çƒéƒ½æ˜¯[1,2]
    // ... æ‰€æœ‰49738ä¸ªé…å¯¹çš„è“çƒéƒ½æ˜¯[1,2]
  ]
}
```

**è“çƒç»„åˆID=1**:
```javascript
{
  combination_id: 1,
  blue_ball_1: 1,
  blue_ball_2: 2,
  sum_value: 3
}
```

**ç»“è®º**: è¿™ä¸æ˜¯å¯¼å‡ºä»£ç çš„é—®é¢˜ï¼Œè€Œæ˜¯**ä»»åŠ¡åˆ›å»ºæ—¶åªé€‰æ‹©äº†1ä¸ªè“çƒç»„åˆ**ï¼ˆ01, 02ï¼‰ã€‚å¯¼å‡ºåŠŸèƒ½æ­£ç¡®åœ°åæ˜ äº†æ•°æ®åº“ä¸­çš„å®é™…æ•°æ®ã€‚

### é—®é¢˜2: ä¸­å¥–ä¿¡æ¯å­—æ®µåç§°ä¸åŒ¹é…ï¼ˆä»£ç BUGï¼‰

**æ•°æ®åº“å®é™…å­—æ®µ**:
```javascript
{
  task_id: 'hwc-pos-20251105-2dq',
  period: 25114,
  is_predicted: false,
  winning_numbers: null,        // âŒ ç©ºå€¼
  winning_info: {               // âœ… å®é™…æ•°æ®åœ¨è¿™é‡Œ
    red: [3, 8, 9, 12, 16],
    blue: [1, 5]
  }
}
```

**å¯¼å‡ºä»£ç ** (src/server/server.js:19864, 19918):
```javascript
// é”™è¯¯ï¼šè¯»å– winning_numbersï¼ˆå€¼ä¸ºnullï¼‰
if (!periodResult.is_predicted && periodResult.winning_numbers) {
    // ... è¿™ä¸ªæ¡ä»¶æ°¸è¿œä¸æˆç«‹
}

// é”™è¯¯ï¼šä½¿ç”¨ winning_numbers
const winningRed = periodResult.winning_numbers.red || [];  // undefined
const winningBlue = periodResult.winning_numbers.blue || []; // undefined
```

**ç»“è®º**: ä»£ç è¯»å–`winning_numbers`å­—æ®µï¼ˆnullï¼‰ï¼Œä½†å®é™…æ•°æ®åœ¨`winning_info`å­—æ®µï¼Œå¯¼è‡´ä¸­å¥–ä¿¡æ¯åˆ—ä¸æ˜¾ç¤ºã€‚

---

## ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜1: è“çƒæ•°æ®é—®é¢˜

**æ— éœ€ä¿®å¤ä»£ç **ï¼Œè¿™æ˜¯æ•°æ®æºé—®é¢˜ï¼Œéœ€è¦ï¼š

1. **ç”¨æˆ·ç«¯æ“ä½œ**: é‡æ–°åˆ›å»ºä»»åŠ¡æ—¶ï¼Œé€‰æ‹©å¤šä¸ªè“çƒç»„åˆ
2. **ç³»ç»Ÿè¯´æ˜**: åœ¨ä»»åŠ¡åˆ›å»ºç•Œé¢æ·»åŠ æç¤ºï¼š"è‡³å°‘é€‰æ‹©2ä¸ªè“çƒç»„åˆä»¥è·å¾—å¤šæ ·æ€§"

**æŠ€æœ¯è¯´æ˜**:
- è“çƒç»„åˆæ€»æ•°: C(12,2) = 66ä¸ª
- çƒ­æ¸©å†·æ­£é€‰ä»»åŠ¡å¦‚æœåªé€‰æ‹©çƒ­çƒç»„åˆï¼Œå¯èƒ½åªåŒ…å«å°‘æ•°å‡ ä¸ªè“çƒç»„åˆ
- è¿™æ˜¯ç¬¦åˆé¢„æœŸçš„åŠŸèƒ½è¡Œä¸º

### é—®é¢˜2: ä¸­å¥–ä¿¡æ¯å­—æ®µåç§°ä¿®å¤

**ä¿®å¤ä½ç½®**: `src/server/server.js`

**ä¿®å¤1** (ç¬¬19863-19872è¡Œ):
```javascript
// ä¿®å¤å‰
if (!periodResult.is_predicted && periodResult.winning_numbers) {
    columns.push(...);
}

// ä¿®å¤å
const winningData = periodResult.winning_info || periodResult.winning_numbers;
if (!periodResult.is_predicted && winningData) {
    columns.push(...);
}
```

**ä¿®å¤2** (ç¬¬19917-19920è¡Œ):
```javascript
// ä¿®å¤å‰
if (!periodResult.is_predicted && periodResult.winning_numbers) {
    const winningRed = periodResult.winning_numbers.red || [];
    const winningBlue = periodResult.winning_numbers.blue || [];
    // ...
}

// ä¿®å¤å
if (!periodResult.is_predicted && winningData) {
    const winningRed = winningData.red || [];
    const winningBlue = winningData.blue || [];
    // ...
}
```

**å…¼å®¹æ€§**: åŒæ—¶æ”¯æŒ`winning_info`å’Œ`winning_numbers`ä¸¤ä¸ªå­—æ®µï¼Œç¡®ä¿å‘åå…¼å®¹ã€‚

---

## ä¿®å¤åæ•ˆæœ

### ä¸­å¥–ä¿¡æ¯å¯¼å‡º

ä¿®å¤åï¼Œå¯¼å‡ºçš„Excelå°†åŒ…å«ä»¥ä¸‹åˆ—ï¼š

| åºå· | çº¢çƒ1-5 | è“çƒ1-2 | å’Œå€¼ | è·¨åº¦ | ... | çº¢çƒå‘½ä¸­ | è“çƒå‘½ä¸­ | ä¸­å¥–ç­‰çº§ | å¥–é‡‘(å…ƒ) |
|------|---------|---------|------|------|-----|----------|----------|----------|----------|
| 1    | 01 02 03 13 26 | 01 02 | 45 | 25 | ... | 1 | 0 | ä¹ç­‰å¥– | 5 |
| 2    | 01 02 03 13 27 | 01 02 | 46 | 26 | ... | 1 | 0 | ä¹ç­‰å¥– | 5 |

**å¼€å¥–å·ç **: çº¢çƒ 03,08,09,12,16 è“çƒ 01,05

**å‘½ä¸­åˆ†æ**:
- çº¢çƒå‘½ä¸­ï¼šæ¯ä¸ªç»„åˆåŒ¹é…å¼€å¥–çº¢çƒçš„ä¸ªæ•°
- è“çƒå‘½ä¸­ï¼šæ¯ä¸ªç»„åˆåŒ¹é…å¼€å¥–è“çƒçš„ä¸ªæ•°
- ä¸­å¥–ç­‰çº§ï¼šæ ¹æ®çº¢çƒå‘½ä¸­+è“çƒå‘½ä¸­åˆ¤å®š
- å¥–é‡‘ï¼šå¯¹åº”ç­‰çº§çš„å¥–é‡‘é‡‘é¢

### è“çƒæ•°æ®è¯´æ˜

**å½“å‰ä»»åŠ¡ `hwc-pos-20251105-2dq` çš„è“çƒæ•°æ®**:
- æ‰€æœ‰49,738ä¸ªç»„åˆçš„è“çƒå‡ä¸º`[01, 02]`
- è¿™æ˜¯å› ä¸ºä»»åŠ¡åˆ›å»ºæ—¶åªé€‰æ‹©äº†è“çƒç»„åˆID=1ï¼ˆçƒ­çƒç»„åˆï¼‰
- è¿™**ä¸æ˜¯BUG**ï¼Œè€Œæ˜¯ç”¨æˆ·é€‰æ‹©çš„ç»“æœ

**å¦‚éœ€å¤šæ ·åŒ–çš„è“çƒç»„åˆ**:
1. é‡æ–°åˆ›å»ºä»»åŠ¡
2. åœ¨è“çƒçƒ­æ¸©å†·ç­›é€‰ä¸­æ”¾å®½æ¡ä»¶
3. æˆ–ä½¿ç”¨"æ— é™é…å¯¹"æ¨¡å¼ç”Ÿæˆæ›´å¤šè“çƒç»„åˆ

---

## æµ‹è¯•éªŒè¯

### éªŒè¯æ­¥éª¤

1. **é‡å¯æœåŠ¡**:
   ```bash
   # æ€æ‰æ—§è¿›ç¨‹
   TASKKILL /F /IM electron.exe /T
   TASKKILL /F /IM node.exe /T

   # å¯åŠ¨æ–°æœåŠ¡
   npm start
   ```

2. **å¯¼å‡ºæµ‹è¯•**:
   - æ‰“å¼€åº”ç”¨
   - è¿›å…¥çƒ­æ¸©å†·æ­£é€‰ä»»åŠ¡è¯¦æƒ…
   - ç‚¹å‡»æœŸå·25114çš„"ğŸ“¥ å¯¼å‡º"æŒ‰é’®
   - æ£€æŸ¥å¯¼å‡ºçš„Excelæ–‡ä»¶

3. **é¢„æœŸç»“æœ**:
   - âœ… åŒ…å«"çº¢çƒå‘½ä¸­"ã€"è“çƒå‘½ä¸­"ã€"ä¸­å¥–ç­‰çº§"ã€"å¥–é‡‘(å…ƒ)"åˆ—
   - âœ… æ¯è¡Œæ˜¾ç¤ºæ­£ç¡®çš„å‘½ä¸­æ•°æ®
   - âš ï¸  è“çƒä»ç„¶å…¨æ˜¯01, 02ï¼ˆè¿™æ˜¯æ•°æ®æºå†³å®šçš„ï¼ŒéBUGï¼‰

### APIæµ‹è¯•

```bash
# æµ‹è¯•å¯¼å‡ºAPI
curl -o test_export.xlsx \
  "http://localhost:3003/api/dlt/hwc-positive-tasks/hwc-pos-20251105-2dq/period/25114/export"

# æ£€æŸ¥æ–‡ä»¶
file test_export.xlsx
# åº”è¾“å‡º: test_export.xlsx: Microsoft Excel 2007+
```

---

## ç›¸å…³ä»£ç å˜æ›´

### ä¿®æ”¹æ–‡ä»¶
- `src/server/server.js` (2å¤„ä¿®æ”¹)
  - ç¬¬19864è¡Œ: æ·»åŠ `winningData`å˜é‡ï¼Œå…¼å®¹ä¸¤ä¸ªå­—æ®µ
  - ç¬¬19918è¡Œ: ä½¿ç”¨`winningData`æ›¿ä»£`periodResult.winning_numbers`

### æœªä¿®æ”¹çš„æ­£ç¡®ä»£ç 
- è“çƒæ•°æ®è¯»å–é€»è¾‘ (ç¬¬19738-19741, 19758-19761è¡Œ) - **æ­£ç¡®**
- Excelåˆ—å®šä¹‰ (ç¬¬19851-19852è¡Œ) - **æ­£ç¡®**
- æ•°æ®å¡«å……é€»è¾‘ (ç¬¬19904-19905è¡Œ) - **æ­£ç¡®**

---

## åç»­å»ºè®®

### 1. ä»»åŠ¡åˆ›å»ºç•Œé¢ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**å»ºè®®**:
- åœ¨çƒ­æ¸©å†·æ­£é€‰ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œæ˜¾ç¤ºè“çƒç»„åˆæ•°é‡
- å¦‚æœè“çƒç»„åˆ<5ä¸ªï¼Œæ˜¾ç¤ºè­¦å‘Šæç¤º

**ç¤ºä¾‹**:
```
âš ï¸ å½“å‰é€‰æ‹©çš„è“çƒç»„åˆåªæœ‰1ä¸ªï¼ˆ01,02ï¼‰ï¼Œå»ºè®®è‡³å°‘é€‰æ‹©5ä¸ªä»¥å¢åŠ å¤šæ ·æ€§
```

### 2. ç»Ÿä¸€å­—æ®µå‘½åï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**é—®é¢˜**: åŒä¸€æ•°æ®æœ‰ä¸¤ä¸ªå­—æ®µå
- `winning_numbers` (Schemaå®šä¹‰)
- `winning_info` (å®é™…ä½¿ç”¨)

**å»ºè®®**:
1. ç»Ÿä¸€ä½¿ç”¨`winning_numbers`
2. è¿ç§»æ‰€æœ‰`winning_info`æ•°æ®åˆ°`winning_numbers`
3. æ›´æ–°æ‰€æœ‰ç›¸å…³ä»£ç 

**è¿ç§»è„šæœ¬**:
```javascript
await db.collection('hit_dlt_hwcpositivepredictiontaskresults').updateMany(
  { winning_info: { $exists: true } },
  [
    {
      $set: {
        winning_numbers: '$winning_info'
      }
    },
    {
      $unset: 'winning_info'
    }
  ]
);
```

### 3. æ·»åŠ å¯¼å‡ºé…ç½®é€‰é¡¹ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

å…è®¸ç”¨æˆ·è‡ªå®šä¹‰å¯¼å‡ºå†…å®¹ï¼š
- â˜‘ åŒ…å«ä¸­å¥–ä¿¡æ¯
- â˜‘ åŒ…å«æ’é™¤è¯¦æƒ…
- â˜‘ åŒ…å«ç»Ÿè®¡ç‰¹å¾
- â˜‘ ä»…å¯¼å‡ºä¸­å¥–ç»„åˆ

---

## æŠ€æœ¯ç»†èŠ‚

### ä¸­å¥–åˆ¤å®šé€»è¾‘

**ä½ç½®**: src/server/server.js:19802-19817

```javascript
function judgePrize(redHit, blueHit) {
    if (redHit === 5 && blueHit === 2) return 'ä¸€ç­‰å¥–';  // 5+2
    if (redHit === 5 && blueHit === 1) return 'äºŒç­‰å¥–';  // 5+1
    if (redHit === 5 && blueHit === 0) return 'ä¸‰ç­‰å¥–';  // 5+0
    if (redHit === 4 && blueHit === 2) return 'å››ç­‰å¥–';  // 4+2
    if (redHit === 4 && blueHit === 1) return 'äº”ç­‰å¥–';  // 4+1
    if (redHit === 3 && blueHit === 2) return 'å…­ç­‰å¥–';  // 3+2
    if (redHit === 4 && blueHit === 0) return 'ä¸ƒç­‰å¥–';  // 4+0
    if (redHit === 3 && blueHit === 1) return 'å…«ç­‰å¥–';  // 3+1
    if (redHit === 2 && blueHit === 2) return 'å…«ç­‰å¥–';  // 2+2
    if (redHit === 3 && blueHit === 0) return 'ä¹ç­‰å¥–';  // 3+0
    if (redHit === 1 && blueHit === 2) return 'ä¹ç­‰å¥–';  // 1+2
    if (redHit === 2 && blueHit === 1) return 'ä¹ç­‰å¥–';  // 2+1
    if (redHit === 0 && blueHit === 2) return 'ä¹ç­‰å¥–';  // 0+2
    return 'æœªä¸­å¥–';
}
```

### å¥–é‡‘é…ç½®

**ä½ç½®**: src/server/server.js:19820-19834

```javascript
function getPrizeAmount(prizeName) {
    return {
        'ä¸€ç­‰å¥–': 10000000,  // 1000ä¸‡
        'äºŒç­‰å¥–': 500000,    // 50ä¸‡
        'ä¸‰ç­‰å¥–': 10000,     // 1ä¸‡
        'å››ç­‰å¥–': 3000,
        'äº”ç­‰å¥–': 300,
        'å…­ç­‰å¥–': 200,
        'ä¸ƒç­‰å¥–': 100,
        'å…«ç­‰å¥–': 15,
        'ä¹ç­‰å¥–': 5,
        'æœªä¸­å¥–': 0
    }[prizeName] || 0;
}
```

---

## æ€»ç»“

### é—®é¢˜1: è“çƒå…¨æ˜¯01å’Œ02
- **åŸå› **: ä»»åŠ¡åˆ›å»ºæ—¶åªé€‰æ‹©äº†1ä¸ªè“çƒç»„åˆ
- **ä¿®å¤**: æ— éœ€ä¿®å¤ä»£ç ï¼Œè¿™æ˜¯æ•°æ®æºå†³å®šçš„
- **è§£å†³æ–¹æ¡ˆ**: é‡æ–°åˆ›å»ºä»»åŠ¡ï¼Œé€‰æ‹©æ›´å¤šè“çƒç»„åˆ

### é—®é¢˜2: æ²¡æœ‰ä¸­å¥–ä¿¡æ¯å¯¼å‡º
- **åŸå› **: ä»£ç è¯»å–`winning_numbers`å­—æ®µï¼ˆnullï¼‰ï¼Œå®é™…æ•°æ®åœ¨`winning_info`å­—æ®µ
- **ä¿®å¤**: âœ… å·²ä¿®å¤ï¼Œå…¼å®¹ä¸¤ä¸ªå­—æ®µå
- **çŠ¶æ€**: éœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆ

### éªŒè¯æ¸…å•
- [x] è¯Šæ–­è“çƒæ•°æ®é—®é¢˜
- [x] è¯Šæ–­ä¸­å¥–ä¿¡æ¯é—®é¢˜
- [x] ä¿®å¤ä»£ç å­—æ®µåç§°
- [x] ç”Ÿæˆæµ‹è¯•è„šæœ¬
- [ ] é‡å¯æœåŠ¡
- [ ] æµ‹è¯•å¯¼å‡ºåŠŸèƒ½
- [ ] éªŒè¯Excelå†…å®¹
