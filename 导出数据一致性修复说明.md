# 导出数据一致性修复说明

## 问题描述

用户反馈："单期导出的表格与实际排除后的结果不一致"

## 问题分析

经过详细诊断，发现问题并非数据不一致，而是**导出逻辑没有正确处理 `unlimited` 组合模式**。

### 系统的三种组合模式

1. **默认模式 (default)**
   - 红球组合数：限制为100个
   - 蓝球组合数：全部66个
   - 组合生成：完全笛卡尔积
   - 总组合数：100 × 66 = 6,600

2. **普通无限制 (unlimited)** ⚠️ 问题所在
   - 红球组合数：使用所有排除后的组合（例如8,718个）
   - 蓝球组合数：全部66个
   - 组合生成：**1:1配对**（非笛卡尔积）
   - 总组合数：`Math.max(红球数, 蓝球数)` = 8,718

3. **真正无限制 (truly-unlimited)**
   - 红球组合数：使用所有排除后的组合
   - 蓝球组合数：全部66个
   - 组合生成：完全笛卡尔积
   - 总组合数：红球数 × 66

### 原始Bug

**导出脚本问题：**
- 位置：`export-period.js` Line 268-322
- 位置：`src/server/server.js` Line 11431-11537 (`streamPeriodDetailCSV`)
- **错误**：导出时**总是使用完全笛卡尔积**，没有根据任务的 `combination_mode` 来决定生成方式

**结果：**
- `unlimited` 模式下，界面显示 8,718 个组合（正确）
- 但导出时错误地生成了 8,718 × 66 = 575,388 个组合（错误）
- 用户看到的导出数据远多于预期

## 修复内容

### 1. 修复 `export-period.js`

**修改位置：** Line 224-399

**新增逻辑：**
```javascript
// 获取组合模式
const combinationMode = task.output_config?.combination_mode || 'default';

// 计算总组合数
let totalCombinations;
if (combinationMode === 'unlimited') {
    // 普通无限制：1:1配对
    totalCombinations = Math.max(redCombinations.length, blueCombinations.length);
} else {
    // 默认模式和真正无限制：完全笛卡尔积
    totalCombinations = redCombinations.length * blueCombinations.length;
}

// 生成组合时分两种情况
if (combinationMode === 'unlimited') {
    // 1:1配对：循环使用较短的数组
    for (let i = 0; i < maxLength; i++) {
        const red = redCombinations[i % redCombinations.length];
        const blue = blueCombinations[i % blueCombinations.length];
        // 生成组合...
    }
} else {
    // 完全笛卡尔积
    for (let i = 0; i < redCombinations.length; i++) {
        for (let j = 0; j < blueCombinations.length; j++) {
            // 生成组合...
        }
    }
}
```

### 2. 修复 `src/server/server.js`

**修改位置：** Line 11373-11660 (`streamPeriodDetailCSV` 函数)

**新增逻辑：** 同上，确保流式导出也正确处理组合模式

### 3. CSV元数据增强

在导出的CSV文件中增加了 `组合模式` 行，方便用户识别导出使用的模式：

```csv
任务名称,预测任务_2025-10-5 13-23-35
期号,24040
组合模式,unlimited  # ← 新增
导出时间,2025/10/5 21:00:00
组合总数,8718
```

## 验证结果

使用诊断脚本 `check-export-consistency.js` 验证：

```
✅ 任务名称: 预测任务_2025-10-5 13-23-35
   组合模式: unlimited
   相克排除: 启用
   同出排除: 禁用

📊 数据库中保存的统计：
   combination_count: 8,718
   red_combinations数组长度: 8718
   blue_combinations数组长度: 66

🔍 实际查询到的组合：
   红球组合数: 8718
   蓝球组合数: 66
   组合计算方式: 1:1配对 (unlimited模式)
   实际组合数: 8,718

📋 一致性检查：
   ✓ 红球数组长度一致: ✅ 是
   ✓ 蓝球数组长度一致: ✅ 是
   ✓ 组合总数一致: ✅ 是

✅ 数据完全一致！导出结果应该正确。
```

## 影响范围

### 受影响的功能
1. 单期详细组合导出（CLI方式，`export-period.js`）
2. 单期详细组合导出（流式导出，`streamPeriodDetailCSV`）

### 不受影响的功能
1. 批量预测任务执行（组合生成逻辑本身是正确的）
2. 界面显示的统计数据（一直是正确的）
3. 默认模式和真正无限制模式的导出（本来就使用笛卡尔积）

## 使用建议

### 如何选择组合模式？

1. **默认模式 (6,600组)**
   - 适合：快速预测、测试
   - 优点：组合数少，执行速度快
   - 缺点：覆盖面窄

2. **普通无限制 (数千到数万组)**
   - 适合：平衡覆盖面和性能
   - 优点：1:1配对，避免组合爆炸
   - 缺点：无法覆盖所有可能的红蓝配对

3. **真正无限制 (数百万组)**
   - 适合：完整分析、回测验证
   - 优点：覆盖所有可能的组合
   - 缺点：组合数巨大，导出和分析耗时

### 注意事项

- 使用 `unlimited` 模式时，导出的组合数等于红球组合数（假设红球数 > 66）
- 使用 `truly-unlimited` 模式时，导出可能生成数百万行数据，请确保磁盘空间充足
- CSV文件中会显示 `组合模式`，可以据此判断导出是否正确

## 诊断工具

新增了诊断脚本 `check-export-consistency.js`，可用于检查任务数据的一致性：

```bash
node check-export-consistency.js --task-id=任务ID --period=期号
```

该工具会检查：
- 数据库中保存的组合数与实际查询到的组合数是否一致
- 组合模式是否正确
- 导出时将生成多少条数据

## 总结

**问题本质：** 导出逻辑没有正确实现 `unlimited` 模式的1:1配对规则。

**修复方案：** 在导出时根据 `combination_mode` 选择不同的组合生成策略。

**验证结果：** 修复后，导出数据与界面显示完全一致。

**用户影响：** 使用 `unlimited` 模式的用户，修复后导出的数据会变少（从错误的完全笛卡尔积变为正确的1:1配对）。
