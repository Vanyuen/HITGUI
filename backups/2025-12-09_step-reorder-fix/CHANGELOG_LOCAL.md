# 本地存档 2025-12-09 - Step编号重新规划

## 存档说明

本次存档包含HWC正选批量预测功能的Step编号重新规划修复，解决了排除详情分类显示错误的问题。

## 问题描述

导出的Excel红球排除详情中，分类标题与详情内容不匹配：
- 【区间比排除】显示的是历史和值排除的详情
- 【和值范围排除】显示的是历史跨度排除的详情

## 根本原因

历史排除条件使用了与正选条件相同的step编号（2,3,4,6），导致数据库中同一step有多条记录，Excel导出时后者覆盖前者。

## 修复内容

### Step编号重新规划

**原则：先正选后排除，量大在前量小在后**

| Step | 条件类型 | 条件名称 | 原Step |
|------|---------|---------|--------|
| 2 | 正选 | 区间比正选排除 | 2 |
| 3 | 正选 | 和值范围正选排除 | 3 |
| 4 | 正选 | 跨度范围正选排除 | 4 |
| 5 | 正选 | 奇偶比正选排除 | 5 |
| 6 | 正选 | AC值正选排除 | 6 |
| 7 | 排除 | 相克对排除 | 9 |
| 8 | 排除 | 同现比排除 | 10 |
| 9 | 排除 | 历史和值排除 | 2(错误) |
| 10 | 排除 | 历史跨度排除 | 3(错误) |
| 11 | 排除 | 历史区间比排除 | 6(错误) |
| 12 | 排除 | 历史热温冷比排除 | 4(错误) |
| 13 | 排除 | 连号组数排除 | 7 |
| 14 | 排除 | 最长连号排除 | 8 |

### 修改位置汇总

| 修改点 | 行号范围 | 说明 |
|--------|---------|------|
| 保存排除详情step (8处) | ~15887-16476 | 修改exclusionsToSave.push中的step和condition |
| stepNames定义 | ~19474-19484 | 扩展到Step 2-14，添加历史排除条件名称 |
| 汇总表循环范围 | ~19515 | 2-10 → 2-14 |
| 元数据处理 | ~19536-19584 | 添加Step 9-12历史排除条件的元数据处理 |
| stepGroups定义 | ~22698-22708 | 扩展到Step 2-14 |
| 查询范围 (2处) | ~19469, 22693 | step: { $in: [2-10] } → [2-14] |
| Excel处理循环 | ~22723 | for step of [2-10] → [2-14] |

### 代码变更示例

```javascript
// 修复前 (错误)
exclusionsToSave.push({
    step: 2,  // 与区间比正选冲突
    condition: 'exclude_step2_historical_sum',
    ...
});

// 修复后 (正确)
exclusionsToSave.push({
    step: 9,  // 新的独立编号
    condition: 'exclude_step9_historical_sum',
    ...
});
```

```javascript
// stepNames定义 (修复后)
const stepNames = {
    // 正选条件 (Step 2-6)
    2: 'Step 2: 区间比正选排除',
    3: 'Step 3: 和值范围正选排除',
    4: 'Step 4: 跨度范围正选排除',
    5: 'Step 5: 奇偶比正选排除',
    6: 'Step 6: AC值正选排除',
    // 排除条件 (Step 7-14) - 按排除量从大到小
    7: 'Step 7: 相克对排除',
    8: 'Step 8: 同现比排除',
    9: 'Step 9: 历史和值排除',
    10: 'Step 10: 历史跨度排除',
    11: 'Step 11: 历史区间比排除',
    12: 'Step 12: 历史热温冷比排除',
    13: 'Step 13: 连号组数排除',
    14: 'Step 14: 最长连号排除'
};
```

## 存档文件列表

```
backups/2025-12-09_step-reorder-fix/
├── src/
│   └── server/
│       └── server.js      # 包含所有修复的服务端文件
└── CHANGELOG_LOCAL.md     # 本变更记录
```

## 测试验证

修复后应验证以下场景：

1. **Excel导出分类正确**：
   - 【区间比正选排除】显示区间比相关详情
   - 【历史和值排除】显示"和值 XX 在历史期号中出现过"
   - 【历史跨度排除】显示"跨度 XX 在历史期号中出现过"
   - 等等...

2. **汇总表显示完整**：
   - Step 2-14 全部显示
   - 各步骤的排除数量和元数据正确

## 兼容性说明

- **新任务**：正确分类显示
- **旧任务**：历史排除详情可能显示在错误分类下（因为旧数据使用了错误的step编号）

## 回滚方法

如需回滚，将备份文件复制回原位置：
```cmd
copy E:\HITGUI\backups\2025-12-09_step-reorder-fix\src\server\server.js E:\HITGUI\src\server\server.js
```

## 关联修复

本次修复基于之前的修复：
1. `2025-12-09_hwc-fixes` - 同现排除模式、推算期支持、top_hit详情收集
2. 历史排除条件详情收集修复
3. 字段兼容性修复 (sum.historical vs historicalSum)

---
存档时间: 2025-12-09
