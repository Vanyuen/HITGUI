# 热温冷正选批量预测 - 功能设计文档

## 文档版本
- **创建日期**: 2025-11-14
- **最后更新**: 2025-11-24
- **版本**: v2.1

## 核心设计原则

### 预测的本质
**预测目标期号视为未开奖期号**
- 预测期号25118时,系统将25118视为"未来期号"
- 所有分析数据(热温冷比、历史统计等)仅基于25118**之前的已开奖数据**
- 预测完成后,将预测结果与实际开奖记录比对,帮助用户寻找规律

### ID-1规则 (核心规则)
**定义**: 目标期号的ID - 1 = 基准期号的ID

**适用场景**:
1. ✅ 期号对生成(正选筛选)
2. ✅ 历史统计(排除条件)

**优势**:
- 适用于期号不连续的场景
- 始终获取正确的"上一期"数据
- 逻辑清晰,不依赖数组顺序

## 一、期号对生成规则

### 1.1 正选筛选的期号对

**用途**: 热温冷比筛选基于"期号对"进行

**生成逻辑** (src/server/server.js:16122-16147):
```javascript
// ⭐ 2025-11-14修复: 统一使用ID-1规则生成所有期号对
const issueRecords = allRecords.filter(r => issueNumbers.includes(r.Issue));

for (const record of issueRecords) {
    const targetID = record.ID;
    const targetIssue = record.Issue.toString();

    // 查询ID-1对应的基准期记录
    const baseRecord = idToRecordMap.get(targetID - 1);

    if (baseRecord) {
        issuePairs.push({
            base_issue: baseRecord.Issue.toString(),
            target_issue: targetIssue
        });

        log(`  ✅ 期号对: ${baseRecord.Issue}→${targetIssue} (ID ${baseRecord.ID}→${targetID})`);
    } else {
        log(`  ⚠️ 期号${targetIssue}(ID=${targetID})的上一期(ID=${targetID - 1})不存在，跳过该期`);
    }
}
```

**示例**:
```
数据库记录:
ID 2785: 期号 25117
ID 2786: 期号 25118
ID 2787: 期号 25119

用户选择: 预测25118-25119

生成期号对:
25117→25118 (ID 2785→2786) ✅
25118→25119 (ID 2786→2787) ✅
```

**非连续期号场景**:
```
数据库记录:
ID 2785: 期号 25117
ID 2787: 期号 25119  (跳过了25118)

用户选择: 预测25119

生成期号对:
25118→25119 (ID 2786→2787)

系统行为:
- 查询ID 2786的记录 → 期号25118
- 如果25118不存在,则使用ID-1规则仍能正确获取基准期
```

### 1.2 热温冷比计算

**原理**: 基于**基准期(base_issue)的遗漏值**计算热温冷分类

**数据来源**: 热温冷优化表

**重要**: Collection 名称
- ✅ **正确**: `hit_dlt_redcombinationshotwarmcoldoptimizeds` (小写+复数)
- ❌ **错误**: `HIT_DLT_RedCombinationsHotWarmColdOptimized` (大写+单数，已废弃)

**表结构**:
```javascript
{
    base_issue: "25117",        // 基准期号(用于计算遗漏)
    target_issue: "25118",      // 目标期号(预测期)
    hot_warm_cold_data: {
        "5:0:0": [1, 2, 3, ...],     // 热温冷比 → 组合ID列表
        "4:1:0": [10, 11, 12, ...],
        "3:2:0": [50, 51, 52, ...],
        // ... 21种热温冷比 (实际数量根据遗漏值分布决定)
    },
    combination_count: 324632,   // 总组合数
    generated_at: Date           // 生成时间
}
```

**Mongoose 模型定义** (src/server/server.js:518):
```javascript
const DLTRedCombinationsHotWarmColdOptimized = mongoose.model(
    'HIT_DLT_RedCombinationsHotWarmColdOptimized',           // 模型名
    dltRedCombinationsHotWarmColdOptimizedSchema,
    'hit_dlt_redcombinationshotwarmcoldoptimizeds'  // ⭐ Collection名称(小写+复数)
);
```

**查询逻辑**:
```javascript
// 预测25118时,查询期号对: 25117→25118
const hwcData = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: '25117',
    target_issue: '25118'
});
```

**热温冷分类标准**:
- **热号**: 遗漏值 ≤ 4
- **温号**: 5 ≤ 遗漏值 ≤ 9
- **冷号**: 遗漏值 ≥ 10

## 二、历史统计规则(排除条件)

### 2.1 核心原则

**每个预测期号使用各自的历史数据**

- 预测期号X → 历史统计从ID(X) - 1开始
- 历史数据**不包含**当前预测期号及之后的数据
- 符合真实预测场景

### 2.2 历史统计类型

1. **历史和值统计** - 最近N期的和值集合
2. **历史跨度统计** - 最近N期的跨度集合
3. **历史区间比统计** - 最近N期的区间比集合
4. **相克对统计** - 最近50期的球号对同现次数

### 2.3 动态计算逻辑

**位置**: src/server/server.js (HwcPositivePredictor.calculateHistoricalStatsForIssue)

**实现流程**:
```javascript
// Step 1: 获取预测期号的ID
const targetIssueID = this.issueToIdMap.get(targetIssue.toString());

// Step 2: 计算基准ID (ID-1规则)
const baseID = targetIssueID - 1;

// Step 3: 从baseID往前查询N期历史记录
const historicalRecords = await DLT.find({
    ID: {
        $lte: baseID,              // ID <= baseID
        $gt: baseID - maxPeriod    // ID > baseID - maxPeriod
    }
})
    .sort({ ID: -1 })
    .limit(maxPeriod)
    .lean();

// Step 4: 使用这些历史记录进行统计
this.historicalStatsCache.sums = new Set(
    historicalRecords.slice(0, period).map(h =>
        h.Red1 + h.Red2 + h.Red3 + h.Red4 + h.Red5
    )
);
```

**示例**:
```
数据库记录:
ID 2783: 期号 25115
ID 2784: 期号 25116
ID 2785: 25117
ID 2786: 期号 25118 ← 预测目标
ID 2787: 期号 25119
ID 2788: 期号 25120

用户配置:
- 预测期号: 25118
- 历史和值统计: 最近3期

计算过程:
targetIssueID = 2786
baseID = 2786 - 1 = 2785

查询条件:
ID <= 2785 AND ID > 2785 - 3
即: 2782 < ID <= 2785

查询结果 (按ID降序):
[ID 2785: 25117, ID 2784: 25116, ID 2783: 25115]

历史和值统计基于: [25117, 25116, 25115] ✅
不包含25118及之后的数据 ✅
```

### 2.4 多期号预测

**场景**: 用户选择预测25118-25120 (3个期号)

**系统行为**: 每个期号独立计算历史统计

```
预测25118:
  历史统计从 ID 2785 开始 → "最近3期": [25117, 25116, 25115]

预测25119:
  历史统计从 ID 2786 开始 → "最近3期": [25118, 25117, 25116]

预测25120:
  历史统计从 ID 2787 开始 → "最近3期": [25119, 25118, 25117]
```

**重要**: 虽然预测25119时历史数据包含25118,但这是正确的:
- 预测系统按期号顺序处理
- 预测25119时,25118已被视为"已完成预测"
- 用户可以根据25118的预测结果调整25119的策略

## 三、数据流架构

### 3.1 期号→ID映射缓存

**位置**: src/server/server.js:16084 (HwcPositivePredictor.preloadData)

**目的**: 为历史统计提供快速ID查询

```javascript
// ⭐ 2025-11-14新增: 构建期号→ID映射（用于历史统计）
this.issueToIdMap = new Map();
for (const record of allRecords) {
    this.issueToIdMap.set(record.Issue.toString(), record.ID);
}
```

### 3.2 历史统计缓存

**类型**: 按期号动态计算,每个期号处理前刷新

**缓存结构**:
```javascript
this.historicalStatsCache = {
    sums: Set,           // 历史和值集合
    spans: Set,          // 历史跨度集合
    hwcRatios: Set,      // 历史热温冷比集合
    zoneRatios: Set,     // 历史区间比集合
    conflictPairs: Set   // 相克对集合
};
```

### 3.3 处理流程

```
用户创建任务
    ↓
解析期号范围 → targetIssues: [25118, 25119, 25120]
    ↓
preloadData
    ├─ 构建期号→ID映射
    ├─ 生成期号对(ID-1规则)
    └─ 预加载热温冷优化表
    ↓
循环处理每个期号:
    ├─ 25118:
    │   ├─ calculateHistoricalStatsForIssue(baseID=2785)
    │   ├─ applyPositiveSelection(25117→25118)
    │   ├─ applyExclusionConditions(使用ID 2785的历史统计)
    │   └─ 保存结果
    ├─ 25119:
    │   ├─ calculateHistoricalStatsForIssue(baseID=2786)
    │   ├─ applyPositiveSelection(25118→25119)
    │   ├─ applyExclusionConditions(使用ID 2786的历史统计)
    │   └─ 保存结果
    └─ 25120:
        ├─ calculateHistoricalStatsForIssue(baseID=2787)
        ├─ applyPositiveSelection(25119→25120)
        ├─ applyExclusionConditions(使用ID 2787的历史统计)
        └─ 保存结果
```

## 四、数据生成与维护

### 4.1 热温冷优化表生成

**生成脚本**: `generate-hwc-optimized-table.js`

**Collection名称** (第29行):
```javascript
const HwcOptimized = mongoose.connection.db.collection(
    'hit_dlt_redcombinationshotwarmcoldoptimizeds'  // ⭐ 2025-11-24修复: 使用小写复数形式
);
```

**生成逻辑**:
1. 从 `hit_dlts` 获取所有期号列表
2. 生成所有相邻期号对 (base_issue → target_issue)
3. 对每个期号对:
   - 查询 `base_issue` 的遗漏值数据
   - 遍历所有 324,632 个红球组合
   - 根据遗漏值分类每个球号为热/温/冷
   - 按热温冷比分组存储组合ID
4. 保存到优化表

**生成命令**:
```bash
# 生成所有期号对
node generate-hwc-optimized-table.js --all

# 生成指定范围
node generate-hwc-optimized-table.js --start 25120 --end 25124
```

**数据维护**:
- 新增期号时需运行生成脚本
- 建议配置定时任务自动生成
- 生成时间: 约4-5小时 (全量2791个期号对)

### 4.2 Collection 名称统一 (2025-11-24)

**背景**: 发现collection名称不一致导致服务端无法读取数据

**问题**:
- 生成脚本使用: `HIT_DLT_RedCombinationsHotWarmColdOptimized` (大写)
- 服务端连接: `hit_dlt_redcombinationshotwarmcoldoptimizeds` (小写)
- 结果: 2,791条数据无法被服务端读取

**修复措施**:
1. ✅ 迁移数据: 大写collection → 小写collection
2. ✅ 修改生成脚本使用小写collection
3. ✅ 删除错误的大写collection
4. ✅ 验证数据完整性

**详细报告**: 参见 `COLLECTION_NAME_MIGRATION_REPORT.md`

## 五、修复历史

### 5.1 修复点1: 统一ID-1配对规则 (2025-11-14)

**问题**: 代码混用ID-1规则和数组索引配对
- 第一个期号: ID-1规则 ✅
- 其余期号: 数组索引相邻配对 ❌

**修复**: 所有期号统一使用ID-1规则

**影响**: 防止期号不连续时产生错误配对

### 5.2 修复点2: 添加参数验证 (2025-11-14)

**位置**: src/server/server.js:21197-21206

**验证**: 热温冷比不能为空

```javascript
if (!positive_selection ||
    !positive_selection.red_hot_warm_cold_ratios ||
    positive_selection.red_hot_warm_cold_ratios.length === 0) {
    return res.json({
        success: false,
        message: '热温冷比不能为空，请至少选择一个热温冷比例'
    });
}
```

### 5.3 修复点3-5: 历史统计ID-1规则 (2025-11-14)

**问题**: 所有期号共用全局历史数据,导致预测逻辑错误

**修复**:
- 修复点3: 在applyExclusionConditions中调用动态计算
- 修复点4: 实现calculateHistoricalStatsForIssue方法
- 修复点5: 移除全局预加载调用

### 5.4 修复点6: Collection名称统一 (2025-11-24)

**问题**: 生成脚本写入大写collection，服务端连接小写collection

**影响**:
- UI显示数据覆盖率0%
- 热温冷正选批量预测任务结果为0
- 实际有2,791条正确数据但无法读取

**修复**:
- 数据迁移: 2,791条记录从大写→小写collection
- 修改 `generate-hwc-optimized-table.js` 使用小写collection
- 验证数据完整性通过

**详细报告**: `COLLECTION_NAME_MIGRATION_REPORT.md`

## 六、验证清单

### 6.1 期号对生成
- [ ] 所有期号使用ID-1规则
- [ ] 期号不连续时配对正确
- [ ] 日志清晰显示每个期号对

### 6.2 历史统计
- [ ] 期号→ID映射正确构建
- [ ] 每个期号使用各自的历史数据起点
- [ ] 历史数据不包含当前预测期号
- [ ] 日志显示ID-1基准点

### 6.3 功能测试
- [ ] 参数验证生效(空热温冷比报错)
- [ ] 任务创建成功
- [ ] 组合数正确显示(非0)
- [ ] Excel导出成功
- [ ] 命中分析正确

### 6.4 数据完整性验证

- [x] Collection名称统一为小写复数形式
- [x] 所有2,791条记录包含 `hot_warm_cold_data` 字段
- [x] 期号25124包含21种比例，15种含温号
- [x] 4:1:0比例包含18,360个组合
- [x] 生成脚本使用正确的collection名称

## 七、性能优化

### 7.1 批量查询
- 期号对批量生成(一次查询所有ID)
- 热温冷优化表批量加载

### 7.2 缓存策略
- 期号→ID映射缓存
- 历史统计按需计算,避免重复查询

### 7.3 数据库索引
- `DLT.ID` 索引(用于ID-1查询)
- `hit_dlt_redcombinationshotwarmcoldoptimizeds` 复合索引:
  - `{ base_issue: 1 }` - 基准期号索引
  - `{ target_issue: 1 }` - 目标期号索引
  - `{ base_issue: 1, target_issue: 1 }` - 复合唯一索引

## 八、未来优化方向

1. **历史统计缓存复用**: 相邻期号的历史统计有重叠,可以增量更新而非完全重算
2. **并行处理**: 多个期号的历史统计可以并行计算
3. **预计算历史统计**: 为常用期号范围预先计算历史统计

## 总结

### 核心设计要点

1. **ID-1规则**: 所有涉及"上一期"的逻辑统一使用ID-1规则
2. **预测视角**: 目标期号视为未开奖,仅使用之前的数据
3. **独立计算**: 每个期号使用各自的历史数据,不共享
4. **防御性编程**: 参数验证、空值检查、日志记录

### 设计优势

- ✅ 逻辑清晰,符合真实预测场景
- ✅ 适用于期号不连续的情况
- ✅ 性能优化(批量查询、缓存)
- ✅ 可维护性强(统一规则)
