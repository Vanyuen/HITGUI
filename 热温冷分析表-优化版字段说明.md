# 热温冷分析表(优化版) - 字段详细说明

> **数据模型：** `HIT_DLT_RedCombinationsHotWarmColdOptimized`
> **代码位置：** `src/server/server.js` line 114-157
> **设计目的：** 压缩存储，节省99.7%空间，提升查询性能

---

## 一、核心字段

### 1. `base_issue` (基准期号)

**类型：** String (必填)

**说明：** 用于计算热温冷的基准期号，即获取遗漏数据的期号。

**示例：** `"24120"`

**业务逻辑：**
- 系统会读取该期号的遗漏数据（`DLTRedMissing`表）
- 基于遗漏值判断每个号码的热温冷状态
- 通常为 `target_issue - 1`

**关联：**
```javascript
// 获取基准期的遗漏数据
const missingData = await DLTRedMissing.findOne({ Issue: base_issue });
```

---

### 2. `target_issue` (目标期号)

**类型：** String (必填)

**说明：** 预测的目标期号，即要为哪一期生成热温冷分析数据。

**示例：** `"24121"`

**业务逻辑：**
- 用户进行组合预测时指定的期号
- 一个目标期号对应一份完整的热温冷分析数据
- 如果该期已开奖，还会包含命中分析

**索引：**
- 单字段索引：`{ target_issue: 1 }`
- 联合唯一索引：`{ base_issue: 1, target_issue: 1 }`（一个基准期+目标期组合只能有一条记录）

---

### 3. `hot_warm_cold_data` (热温冷分组数据) ⭐核心字段

**类型：** Map<String, Array<Number>>

**说明：** 按热温冷比分组存储的组合ID数组，这是优化存储的关键。

**数据结构：**
```javascript
{
  "3:2:0": [1, 15, 89, 234, 567, ...],      // 热温冷比为3:2:0的所有组合ID
  "2:2:1": [2, 20, 102, 398, 654, ...],     // 热温冷比为2:2:1的所有组合ID
  "2:3:0": [5, 32, 156, 489, 702, ...],     // 热温冷比为2:3:0的所有组合ID
  "3:1:1": [8, 45, 201, 521, 798, ...],     // 热温冷比为3:1:1的所有组合ID
  // ... 更多热温冷比
}
```

**Key (键)：** 热温冷比字符串，格式为 `"热号数:温号数:冷号数"`
- 示例：`"3:2:0"` 表示3个热号、2个温号、0个冷号
- 可能的取值：理论上有21种组合 (0:0:5, 0:1:4, ... 5:0:0)

**Value (值)：** 组合ID数组 `[Number]`
- 每个Number是 `DLTRedCombinations` 表中的 `combination_id` (1-324632)
- 数组长度表示该热温冷比有多少个组合

**存储优势：**

**传统方式：**
```javascript
// 需要 324,632 条记录
{ combination_id: 1, hot_warm_cold_ratio: "3:2:0", ... }
{ combination_id: 2, hot_warm_cold_ratio: "2:2:1", ... }
{ combination_id: 3, hot_warm_cold_ratio: "3:2:0", ... }
// ... 324,632 条
```

**优化方式：**
```javascript
// 只需 1 条记录
{
  base_issue: "24120",
  target_issue: "24121",
  hot_warm_cold_data: {
    "3:2:0": [1, 3, 15, ...],  // 假设80,000个组合
    "2:2:1": [2, 8, 23, ...],  // 假设90,000个组合
    // ... 约15-20个不同的热温冷比
  }
}
```

**查询示例：** (server.js line 7859)
```javascript
// 遍历所有热温冷比
for (const [ratio, combinationIds] of optimizedData.hot_warm_cold_data.entries()) {
    // ratio: "3:2:0"
    // combinationIds: [1, 15, 89, 234, ...]

    // 检查是否被用户排除
    if (excludedRatios.includes(ratio)) continue;

    // 收集符合条件的组合ID
    combinationIds.forEach(id => validCombinationIds.add(id));
}
```

---

### 4. `total_combinations` (总组合数)

**类型：** Number (必填)

**说明：** 该期热温冷分析的总组合数，通常为 324,632（大乐透前区所有5选35组合）。

**用途：**
- 快速统计验证
- 数据完整性检查
- 前端显示总数

**计算：**
```javascript
total_combinations = Object.values(hot_warm_cold_data)
    .reduce((sum, arr) => sum + arr.length, 0);
```

**示例：**
```javascript
{
  total_combinations: 324632,
  statistics: {
    ratio_counts: {
      "3:2:0": 78456,
      "2:2:1": 89234,
      "2:3:0": 67890,
      // ... 总和 = 324632
    }
  }
}
```

---

## 二、命中分析字段 (hit_analysis)

> **说明：** 当目标期号已开奖时，系统会计算所有组合与实际开奖结果的命中情况。

### 5. `hit_analysis` (命中分析对象)

**类型：** Object

**结构：**
```javascript
{
  target_winning_reds: [Number],      // 实际开奖红球
  target_winning_blues: [Number],     // 实际开奖蓝球
  red_hit_data: Map<String, [Number]>, // 命中分组数据
  hit_statistics: Object,             // 命中统计
  is_drawn: Boolean                   // 是否已开奖
}
```

---

#### 5.1 `target_winning_reds` (实际开奖红球)

**类型：** Array<Number> (长度5)

**说明：** 目标期号的实际开奖红球号码（升序排列）。

**示例：** `[5, 12, 18, 23, 31]`

**用途：**
- 计算每个组合命中了几个红球
- 展示在前端供用户对比

---

#### 5.2 `target_winning_blues` (实际开奖蓝球)

**类型：** Array<Number> (长度2)

**说明：** 目标期号的实际开奖蓝球号码（升序排列）。

**示例：** `[3, 9]`

**用途：**
- 蓝球命中分析
- 完整奖级判定

---

#### 5.3 `red_hit_data` (红球命中分组数据) ⭐关键字段

**类型：** Map<String, Array<Number>>

**说明：** 按红球命中数量分组存储的组合ID数组。

**数据结构：**
```javascript
{
  "0": [8, 45, 102, 389, ...],      // 命中0个红球的组合ID
  "1": [12, 67, 234, 512, ...],     // 命中1个红球的组合ID
  "2": [3, 89, 345, 678, ...],      // 命中2个红球的组合ID
  "3": [23, 156, 489, 801, ...],    // 命中3个红球的组合ID
  "4": [98, 234, 567, ...],         // 命中4个红球的组合ID
  "5": [1234, 5678, ...]            // 命中5个红球的组合ID (罕见)
}
```

**Key (键)：** 命中数量字符串 `"0"` 到 `"5"`

**Value (值)：** 组合ID数组

**应用场景：**
```javascript
// 查询命中2个以上红球的所有组合
const hit2Plus = [
    ...red_hit_data.get("2"),
    ...red_hit_data.get("3"),
    ...red_hit_data.get("4"),
    ...red_hit_data.get("5")
];

// 前端显示："您的组合命中了3个红球！在本期排名前15%"
```

---

#### 5.4 `hit_statistics` (命中统计)

**类型：** Object

**说明：** 各命中数量的组合统计，用于快速查看分布情况。

**字段：**
```javascript
{
  hit_0: Number,  // 命中0个的组合数
  hit_1: Number,  // 命中1个的组合数
  hit_2: Number,  // 命中2个的组合数
  hit_3: Number,  // 命中3个的组合数
  hit_4: Number,  // 命中4个的组合数
  hit_5: Number   // 命中5个的组合数 (一等奖前区)
}
```

**示例数据：**
```javascript
{
  hit_0: 132456,   // 40.8% 未命中
  hit_1: 145678,   // 44.9% 命中1个
  hit_2: 38234,    // 11.8% 命中2个
  hit_3: 7456,     // 2.3% 命中3个
  hit_4: 756,      // 0.23% 命中4个
  hit_5: 52        // 0.016% 命中5个 (52个组合可能中一等奖)
}
// 总计: 324,632 组合
```

**验证公式：**
```javascript
hit_0 + hit_1 + hit_2 + hit_3 + hit_4 + hit_5 === total_combinations
```

**应用场景：**
- 前端展示命中率分布图表
- 评估预测系统的准确性
- 历史回测分析

---

#### 5.5 `is_drawn` (是否已开奖)

**类型：** Boolean (默认false)

**说明：** 标识目标期号是否已开奖，决定是否有命中分析数据。

**取值：**
- `true`：已开奖，包含完整命中分析
- `false`：未开奖，命中分析字段为空

**逻辑：**
```javascript
if (is_drawn === true) {
    // 可以展示命中分析
    console.log(`命中5个红球的组合: ${red_hit_data.get("5").length}个`);
} else {
    // 显示"等待开奖"
    console.log("该期尚未开奖，暂无命中数据");
}
```

---

## 三、统计字段 (statistics)

### 6. `statistics` (统计信息对象)

**类型：** Object

**说明：** 存储各种统计信息，方便前端快速展示。

---

#### 6.1 `ratio_counts` (热温冷比分布统计)

**类型：** Map<String, Number>

**说明：** 每个热温冷比对应的组合数量。

**数据结构：**
```javascript
{
  "3:2:0": 78456,    // 热温冷比3:2:0有78,456个组合
  "2:2:1": 89234,    // 热温冷比2:2:1有89,234个组合
  "2:3:0": 67890,    // 热温冷比2:3:0有67,890个组合
  "3:1:1": 45678,
  "2:1:2": 23456,
  "4:1:0": 12345,
  // ... 约15-20个不同的热温冷比
}
```

**计算方法：**
```javascript
const ratio_counts = new Map();
for (const [ratio, combinationIds] of hot_warm_cold_data.entries()) {
    ratio_counts.set(ratio, combinationIds.length);
}
```

**应用场景：**
```javascript
// 前端展示热温冷比分布图表
const chartData = {
  labels: Array.from(ratio_counts.keys()),
  values: Array.from(ratio_counts.values())
};

// 饼图：显示各热温冷比占比
// 柱状图：显示各热温冷比的组合数量
```

**验证：**
```javascript
// 所有ratio_counts的值之和应等于total_combinations
const sum = Array.from(ratio_counts.values()).reduce((a, b) => a + b, 0);
assert(sum === total_combinations); // 应为324,632
```

---

## 四、元数据字段

### 7. `created_at` (创建时间)

**类型：** Date (自动生成)

**说明：** 该条记录的创建时间戳。

**用途：**
- 数据追溯
- 清理过期数据
- 展示"数据更新时间"

**示例：** `2025-09-29T10:30:15.123Z`

---

## 五、数据库索引

### 索引设计

```javascript
// 1. 单字段索引 - 用于按基准期查询
{ base_issue: 1 }

// 2. 单字段索引 - 用于按目标期查询
{ target_issue: 1 }

// 3. 联合唯一索引 - 确保一个基准期+目标期只有一条记录
{ base_issue: 1, target_issue: 1 }, { unique: true }
```

**查询优化：**
```javascript
// 快速查询 - 命中索引
await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: "24120",
    target_issue: "24121"
});

// 批量查询
await DLTRedCombinationsHotWarmColdOptimized.find({
    target_issue: { $in: ["24121", "24122", "24123"] }
});
```

---

## 六、完整数据示例

```javascript
{
  _id: ObjectId("..."),

  // 核心字段
  base_issue: "24120",
  target_issue: "24121",
  total_combinations: 324632,

  // 热温冷分组数据
  hot_warm_cold_data: {
    "5:0:0": [1, 89, 234, ...],           // 456个组合
    "4:1:0": [15, 102, 345, ...],         // 12,345个组合
    "4:0:1": [23, 156, 456, ...],         // 8,901个组合
    "3:2:0": [5, 67, 201, ...],           // 78,456个组合 ⭐最常见
    "3:1:1": [32, 145, 389, ...],         // 45,678个组合
    "3:0:2": [8, 178, 423, ...],          // 19,234个组合
    "2:3:0": [45, 234, 567, ...],         // 67,890个组合 ⭐最常见
    "2:2:1": [12, 189, 501, ...],         // 89,234个组合 ⭐最常见
    "2:1:2": [76, 298, 612, ...],         // 23,456个组合
    "2:0:3": [98, 312, 678, ...],         // 6,789个组合
    "1:4:0": [56, 245, 589, ...],         // 34,567个组合
    "1:3:1": [123, 367, 701, ...],        // 45,678个组合
    "1:2:2": [145, 456, 789, ...],        // 23,456个组合
    "1:1:3": [167, 489, 823, ...],        // 8,901个组合
    "1:0:4": [189, 512, 867, ...],        // 2,345个组合
    "0:5:0": [201, 534, 901, ...],        // 5,678个组合
    "0:4:1": [223, 567, 934, ...],        // 3,456个组合
    "0:3:2": [245, 589, 967, ...],        // 1,234个组合
    "0:2:3": [267, 612, 987, ...],        // 567个组合
    "0:1:4": [289, 634, 1001, ...],       // 234个组合
    "0:0:5": [301, 656, 1023, ...]        // 89个组合
  },

  // 命中分析数据 (如果已开奖)
  hit_analysis: {
    target_winning_reds: [5, 12, 18, 23, 31],   // 实际开奖
    target_winning_blues: [3, 9],
    is_drawn: true,

    red_hit_data: {
      "0": [8, 45, 102, ...],           // 132,456个组合
      "1": [12, 67, 234, ...],          // 145,678个组合
      "2": [3, 89, 345, ...],           // 38,234个组合
      "3": [23, 156, 489, ...],         // 7,456个组合
      "4": [98, 234, 567, ...],         // 756个组合
      "5": [1234, 5678, 9012, ...]      // 52个组合 🎉
    },

    hit_statistics: {
      hit_0: 132456,  // 40.8%
      hit_1: 145678,  // 44.9%
      hit_2: 38234,   // 11.8%
      hit_3: 7456,    // 2.3%
      hit_4: 756,     // 0.23%
      hit_5: 52       // 0.016%
    }
  },

  // 统计信息
  statistics: {
    ratio_counts: {
      "5:0:0": 456,
      "4:1:0": 12345,
      "3:2:0": 78456,    // 最多
      "2:3:0": 67890,    // 第二多
      "2:2:1": 89234,    // 第三多
      // ... 共21个可能的热温冷比
    }
  },

  created_at: ISODate("2025-09-29T10:30:15.123Z")
}
```

---

## 七、数据存储对比

### 传统方式 (DLTRedCombinationsHotWarmCold)

**记录数：** 324,632 条/期

**单条记录：**
```javascript
{
  base_issue: "24120",
  target_issue: "24121",
  combination_id: 1,
  red_ball_1: 1,
  red_ball_2: 2,
  red_ball_3: 3,
  red_ball_4: 4,
  red_ball_5: 5,
  hot_warm_cold_ratio: "3:2:0",
  hot_count: 3,
  warm_count: 2,
  cold_count: 0,
  created_at: ISODate(...)
}
```

**存储空间估算：**
- 每条记录约 150 bytes
- 324,632 条 × 150 bytes ≈ **48.7 MB** / 期
- 200期数据 ≈ **9.74 GB**

---

### 优化方式 (DLTRedCombinationsHotWarmColdOptimized)

**记录数：** 1 条/期

**单条记录：** (如上面完整示例)

**存储空间估算：**
- 每个组合ID: 4 bytes (Number)
- 324,632 个ID × 4 bytes = 1.3 MB
- 加上Map键、统计信息等 ≈ **1.5 MB** / 期
- 200期数据 ≈ **300 MB**

**压缩比：** `9.74 GB / 300 MB ≈ 32.5倍` 🎉

---

## 八、查询性能对比

### 场景：查询热温冷比为"3:2:0"或"2:2:1"的所有组合

**传统方式：**
```javascript
// 需要扫描 324,632 条记录
const result = await DLTRedCombinationsHotWarmCold.find({
    base_issue: "24120",
    target_issue: "24121",
    hot_warm_cold_ratio: { $in: ["3:2:0", "2:2:1"] }
});
// 耗时：~3-5秒
```

**优化方式：**
```javascript
// 只需读取1条记录，内存中筛选
const data = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: "24120",
    target_issue: "24121"
});

const combinationIds = [
    ...data.hot_warm_cold_data.get("3:2:0"),
    ...data.hot_warm_cold_data.get("2:2:1")
];
// 耗时：~0.5-1秒
```

**性能提升：** 3-5倍 🚀

---

## 九、常见查询模式

### 1. 获取指定热温冷比的组合

```javascript
const data = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: "24120",
    target_issue: "24121"
});

// 获取热温冷比为"3:2:0"的所有组合ID
const combinationIds = data.hot_warm_cold_data.get("3:2:0");
console.log(`找到${combinationIds.length}个组合`);
```

### 2. 排除特定热温冷比

```javascript
const excludedRatios = ["5:0:0", "0:0:5", "4:1:0"];
const validIds = new Set();

for (const [ratio, ids] of data.hot_warm_cold_data.entries()) {
    if (!excludedRatios.includes(ratio)) {
        ids.forEach(id => validIds.add(id));
    }
}
```

### 3. 查询命中分析

```javascript
if (data.hit_analysis.is_drawn) {
    // 获取命中3个以上红球的组合
    const hit3Plus = [
        ...data.hit_analysis.red_hit_data.get("3"),
        ...data.hit_analysis.red_hit_data.get("4"),
        ...data.hit_analysis.red_hit_data.get("5")
    ];

    console.log(`本期共有${hit3Plus.length}个组合命中3个以上红球`);
}
```

### 4. 统计分析

```javascript
// 查看热温冷比分布
console.log("热温冷比分布：");
for (const [ratio, count] of data.statistics.ratio_counts.entries()) {
    const percentage = (count / data.total_combinations * 100).toFixed(2);
    console.log(`${ratio}: ${count}个 (${percentage}%)`);
}

// 查看命中分布
if (data.hit_analysis.is_drawn) {
    console.log("\n命中分布：");
    const stats = data.hit_analysis.hit_statistics;
    for (let i = 0; i <= 5; i++) {
        const count = stats[`hit_${i}`];
        const percentage = (count / data.total_combinations * 100).toFixed(2);
        console.log(`命中${i}个: ${count}个 (${percentage}%)`);
    }
}
```

---

## 十、与传统表的兼容性

系统保留了传统表 `DLTRedCombinationsHotWarmCold`，确保向后兼容。

**使用策略：**
1. 优先使用优化版表（如果存在）
2. 回退到传统表（兼容旧数据）

**代码示例：** (server.js line 7370)
```javascript
// 检查优化版数据
let hotWarmColdData = await DLTRedCombinationsHotWarmColdOptimized.findOne({
    base_issue: baseIssue,
    target_issue: targetIssue
});

if (!hotWarmColdData) {
    // 回退到传统表
    return res.status(404).json({
        success: false,
        message: `期号${targetIssue}的优化版热温冷数据不存在，请先生成数据`
    });
}
```

---

## 十一、数据生成流程

```
1. 接收API请求
   POST /api/dlt/generate-hot-warm-cold/:baseIssue/:targetIssue

2. 获取基准期遗漏数据
   DLTRedMissing.findOne({ Issue: baseIssue })

3. 读取所有红球组合 (324,632个)
   DLTRedCombinations.find({})

4. 为每个组合计算热温冷比
   ├─ 遍历5个红球
   ├─ 查询遗漏值
   ├─ 判断热/温/冷
   └─ 生成比例字符串 "热:温:冷"

5. 按热温冷比分组
   hot_warm_cold_data: {
     "3:2:0": [组合ID数组],
     "2:2:1": [组合ID数组],
     ...
   }

6. 如果目标期已开奖，计算命中分析
   ├─ 获取开奖结果
   ├─ 遍历所有组合
   ├─ 计算命中数量
   └─ 按命中数分组

7. 生成统计信息
   ├─ ratio_counts
   ├─ hit_statistics
   └─ total_combinations

8. 保存到数据库
   DLTRedCombinationsHotWarmColdOptimized.create({...})
```

---

## 十二、最佳实践

### 1. 数据生成建议
- 每次新期开奖后立即生成热温冷数据
- 使用批量生成API一次性生成最近200期
- 定期检查数据完整性

### 2. 查询优化建议
- 优先使用优化版表
- 利用索引查询 (base_issue + target_issue)
- 使用Set进行组合ID去重
- 分页加载大量结果

### 3. 前端展示建议
- 使用图表展示热温冷比分布
- 高亮显示常见热温冷比
- 展示命中分析（如已开奖）
- 提供快捷筛选按钮

---

**文档版本：** v1.0
**创建日期：** 2025-09-29
**维护者：** Claude Code
**参考代码：** `src/server/server.js` line 114-185, 7318-8172