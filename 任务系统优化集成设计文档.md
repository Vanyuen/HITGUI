# ä»»åŠ¡ç³»ç»Ÿä¼˜åŒ–é›†æˆè®¾è®¡æ–‡æ¡£

## ğŸ“‹ è®¾è®¡ç›®æ ‡

å°†å·²å®ç°çš„æ‰¹é‡é¢„æµ‹æ€§èƒ½ä¼˜åŒ–ï¼ˆStreamBatchPredictorï¼‰é›†æˆåˆ°ä»»åŠ¡ç³»ç»Ÿï¼ˆexecutePredictionTaskå‡½æ•°ï¼‰ï¼Œå®ç°6-20å€æ€§èƒ½æå‡ï¼ŒåŒæ—¶ä¿æŒ100%å‘åå…¼å®¹ã€‚

---

## ğŸ” å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜æ ¹æº
**ä»»åŠ¡ç³»ç»Ÿï¼ˆexecutePredictionTaskï¼‰å’Œä¼˜åŒ–APIï¼ˆ/api/dlt/batch-predictionï¼‰æ˜¯ä¸¤æ¡ç‹¬ç«‹çš„ä»£ç è·¯å¾„**

```
å‰ç«¯å‘é€è¯·æ±‚
    â†“
POST /api/dlt/prediction-tasks/create
    â†“
åˆ›å»ºPredictionTaskè®°å½•
    â†“
è°ƒç”¨ executePredictionTask(taskId)
    â†“
âŒ é€æœŸforå¾ªç¯å¤„ç†ï¼ˆ14453è¡Œï¼‰  â† æ—§ä»£ç ï¼Œæ…¢
    â”œâ”€ æ¯æœŸå•ç‹¬æŸ¥æ•°æ®åº“
    â”œâ”€ æ¯æœŸå•ç‹¬åº”ç”¨æ’é™¤æ¡ä»¶
    â””â”€ æ²¡æœ‰ä½¿ç”¨ç¼“å­˜

âœ… ä¼˜åŒ–çš„æ‰¹é‡é¢„æµ‹APIä½¿ç”¨ï¼š
POST /api/dlt/batch-prediction
    â†“
StreamBatchPredictor.streamPredict()
    â”œâ”€ ä¸€æ¬¡é¢„åŠ è½½æ‰€æœ‰æ•°æ®
    â”œâ”€ å†…å­˜ç¼“å­˜å¤ç”¨
    â””â”€ 6-20å€æ€§èƒ½æå‡
```

### æ€§èƒ½å¯¹æ¯”
| åœºæ™¯ | å½“å‰ä»»åŠ¡ç³»ç»Ÿ | ä¼˜åŒ–API | å·®è· |
|------|-------------|---------|------|
| 5æœŸé¢„æµ‹ | ~5ç§’ | ~0.5ç§’ | **10x** |
| 20æœŸé¢„æµ‹ | ~20ç§’ | ~3ç§’ | **6-7x** |

---

## ğŸ¯ é›†æˆæ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒæ€è·¯
**è®©executePredictionTaskå†…éƒ¨è°ƒç”¨StreamBatchPredictorï¼Œè€Œä¸æ˜¯è‡ªå·±é€æœŸå¤„ç†**

### å‚æ•°è½¬æ¢æ˜ å°„

#### 1. ä»»åŠ¡ç³»ç»Ÿ â†’ StreamBatchPredictor å‚æ•°è½¬æ¢

```javascript
// ä»»åŠ¡ç³»ç»Ÿè¾“å…¥ï¼ˆæ¥è‡ªå‰ç«¯ï¼‰
{
    task_name: "xxx",
    period_range: {
        type: "recent",     // rangeType
        value: 20           // recentCount
    },
    exclude_conditions: { ... },
    output_config: {
        combination_mode: "default"
    }
}

// â†“ è½¬æ¢ä¸º â†“

// StreamBatchPredictor éœ€è¦çš„å‚æ•°
{
    targetIssues: ["2025001", "2025002", ...],  // â† éœ€è¦è§£æperiod_range
    filters: {
        maxRedCombinations: 100,
        maxBlueCombinations: 66,
        combinationMode: "default"
    },
    exclude_conditions: { ... },  // ç›´æ¥ä¼ é€’
    enableValidation: true
}
```

#### 2. å…³é”®è½¬æ¢æ­¥éª¤

```javascript
// Step 1: å°†period_rangeè½¬æ¢ä¸ºæœŸå·åˆ—è¡¨
// ä»»åŠ¡ç³»ç»Ÿ: task.period_range = { type: "recent", value: 20 }
// éœ€è¦è½¬æ¢ä¸º: targetIssues = ["2025001", "2025002", ...]

// âœ… ä½¿ç”¨ç°æˆçš„resolveIssueRangeInternalå‡½æ•°
const targetIssues = await resolveIssueRangeInternal({
    rangeType: task.period_range.type,
    recentCount: task.period_range.value,
    startIssue: task.period_range.start,
    endIssue: task.period_range.end
});

// Step 2: è½¬æ¢ç»„åˆæ¨¡å¼
// ä»»åŠ¡ç³»ç»Ÿ: task.output_config.combination_mode = "default"
// StreamBatchPredictor: filters.combinationMode = "default"
// â†’ ç›´æ¥ä¼ é€’å³å¯

// Step 3: è½¬æ¢æ’é™¤æ¡ä»¶
// ä»»åŠ¡ç³»ç»Ÿ: task.exclude_conditions
// StreamBatchPredictor: exclude_conditions
// â†’ ç›´æ¥ä¼ é€’å³å¯ï¼Œæ ¼å¼å®Œå…¨ç›¸åŒï¼
```

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### æ”¹é€ executePredictionTaskå‡½æ•°

#### åŸå§‹é€»è¾‘ï¼ˆ14453è¡Œ forå¾ªç¯ï¼‰
```javascript
// âŒ æ—§ä»£ç ï¼šé€æœŸå¤„ç†
for (let i = 0; i < issues.length; i++) {
    const issue = issues[i];
    // ... å•ç‹¬æŸ¥æ•°æ®åº“
    // ... å•ç‹¬åº”ç”¨æ’é™¤æ¡ä»¶
    // ... å•ç‹¬è®¡ç®—ç»“æœ
    // ... ä¿å­˜åˆ°PredictionTaskResult
}
```

#### æ”¹é€ åé€»è¾‘ï¼ˆä½¿ç”¨StreamBatchPredictorï¼‰
```javascript
// âœ… æ–°ä»£ç ï¼šæ‰¹é‡å¤„ç†
// 1. è½¬æ¢å‚æ•°
const targetIssues = issues.map(issue => issue.Issue.toString());
const combinationMode = task.output_config?.combination_mode || 'default';

// 2. åˆ›å»ºStreamBatchPredictorå®ä¾‹
const sessionId = `task_${taskId}`;
const batchPredictor = new StreamBatchPredictor(sessionId);

// 3. é…ç½®å‚æ•°
const config = {
    targetIssues: targetIssues,
    filters: {
        maxRedCombinations: combinationMode === 'default' ? 100 : Number.MAX_SAFE_INTEGER,
        maxBlueCombinations: 66,
        combinationMode: combinationMode
    },
    exclude_conditions: task.exclude_conditions,
    enableValidation: true
};

// 4. æ‰§è¡Œæ‰¹é‡é¢„æµ‹ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–ï¼‰
const batchResults = await batchPredictor.streamPredict(config, (progress) => {
    // 5. æ›´æ–°ä»»åŠ¡è¿›åº¦
    task.progress.current = progress.completed;
    task.progress.percentage = progress.percentage;
    await task.save();
});

// 6. è½¬æ¢ç»“æœæ ¼å¼å¹¶ä¿å­˜
for (const periodResult of batchResults.data) {
    // ä¿å­˜åˆ°PredictionTaskResultï¼ˆä¿æŒåŸæœ‰æ•°æ®ç»“æ„ï¼‰
    const result = new PredictionTaskResult({
        result_id: `${taskId}_${periodResult.target_issue}`,
        task_id: taskId,
        period: periodResult.target_issue,
        red_combinations: periodResult.red_combinations.map(c => c.combination_id),
        blue_combinations: periodResult.blue_combinations.map(c => c.combination_id),
        combination_count: periodResult.combination_count,
        winning_numbers: periodResult.winning_numbers,
        hit_analysis: periodResult.hit_analysis,
        // ... å…¶ä»–å­—æ®µ
    });
    await result.save();
}
```

---

## ğŸ“Š ç»“æœæ ¼å¼æ˜ å°„

### StreamBatchPredictorè¾“å‡ºæ ¼å¼
```javascript
{
    success: true,
    data: [
        {
            target_issue: "2025001",
            red_combinations: [
                { combination_id: 123, red_ball_1: 1, ... },
                ...
            ],
            blue_combinations: [
                { combination_id: 1, blue_ball_1: 1, ... },
                ...
            ],
            combination_count: 6600,
            winning_numbers: { red: [1,2,3,4,5], blue: [1,2] },
            hit_analysis: {
                max_hit_count: 3,
                prize_stats: { ... },
                ...
            },
            processing_time: 150
        },
        // ... æ›´å¤šæœŸæ•°
    ],
    summary: { ... },
    memoryPeak: 200
}
```

### PredictionTaskResultå­˜å‚¨æ ¼å¼ï¼ˆéœ€ä¿æŒï¼‰
```javascript
{
    result_id: "task123_2025001",
    task_id: "task123",
    period: "2025001",
    red_combinations: [123, 456, ...],  // â† æ³¨æ„ï¼šåªå­˜ID
    blue_combinations: [1, 2, ...],
    combination_count: 6600,
    winning_numbers: { red: [...], blue: [...] },
    hit_analysis: { ... },
    conflict_data: { ... },
    cooccurrence_perball_data: { ... },
    cooccurrence_byissues_data: { ... },
    exclusion_chain: [ ... ]
}
```

---

## âš ï¸ å…³é”®è€ƒè™‘ç‚¹

### 1. æ’é™¤æ¡ä»¶è¯¦æƒ…è®°å½•

**é—®é¢˜**: ä»»åŠ¡ç³»ç»Ÿä¼šè®°å½•æ’é™¤è¯¦æƒ…åˆ°`DLTExclusionDetails`è¡¨ï¼ˆ14994-15011è¡Œï¼‰

**è§£å†³æ–¹æ¡ˆ**: StreamBatchPredictorçš„ç»“æœä¸­å·²åŒ…å«æ’é™¤ä¿¡æ¯ï¼Œéœ€è¦é¢å¤–å¤„ç†ï¼š

```javascript
// åœ¨ä¿å­˜ç»“æœåï¼Œè¡¥å……è®°å½•æ’é™¤è¯¦æƒ…
if (EXCLUSION_DETAILS_CONFIG.enabled) {
    // StreamBatchPredictorå·²ç»åº”ç”¨äº†æ’é™¤æ¡ä»¶
    // ä½†æ²¡æœ‰è®°å½•è¯¦ç»†çš„è¢«æ’é™¤ç»„åˆIDåˆ—è¡¨
    // â†’ éœ€è¦ä»ç»“æœä¸­æ¨æ–­æˆ–æ‰©å±•StreamBatchPredictorè¿”å›æ›´å¤šä¿¡æ¯

    // æ–¹æ¡ˆAï¼šä¸è®°å½•è¯¦æƒ…ï¼ˆç®€åŒ–ï¼Œæ€§èƒ½ä¼˜å…ˆï¼‰
    // æ–¹æ¡ˆBï¼šæ‰©å±•StreamBatchPredictorè¿”å›æ’é™¤è¯¦æƒ…
}
```

### 2. è¿›åº¦è·Ÿè¸ª

**å½“å‰**: ä»»åŠ¡ç³»ç»Ÿåœ¨forå¾ªç¯ä¸­æ›´æ–°è¿›åº¦ï¼ˆ15030-15033è¡Œï¼‰

**æ”¹é€ **: ä½¿ç”¨StreamBatchPredictorçš„è¿›åº¦å›è°ƒ

```javascript
await batchPredictor.streamPredict(config, async (progress) => {
    // å®æ—¶æ›´æ–°ä»»åŠ¡è¿›åº¦
    task.progress.current = progress.completed;
    task.progress.percentage = progress.percentage;
    task.updated_at = new Date();
    await task.save();
});
```

### 3. é”™è¯¯å¤„ç†

**å½“å‰**: å•æœŸå¤±è´¥ç»§ç»­å¤„ç†ä¸‹ä¸€æœŸï¼ˆ15035-15038è¡Œï¼‰

**æ”¹é€ **: StreamBatchPredictorå†…éƒ¨å·²å¤„ç†é”™è¯¯ï¼Œæ‰¹é‡é¢„æµ‹å¤±è´¥ä¼šæ•´ä½“å›æ»š

**å½±å“**: æ›´ä¸¥æ ¼çš„é”™è¯¯å¤„ç†ï¼Œä»»ä¸€æœŸå¤±è´¥ä¼šå¯¼è‡´æ•´æ‰¹å¤±è´¥

**è§£å†³**: å¯æ¥å—ï¼Œå› ä¸ºæ‰¹é‡é¢„æµ‹é€šå¸¸è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆé…ç½®é”™è¯¯å¯¼è‡´å…¨å¤±è´¥

### 4. ç»Ÿè®¡ä¿¡æ¯è®¡ç®—

**å½“å‰**: ä»»åŠ¡ç³»ç»Ÿé€æœŸç´¯è®¡ç»Ÿè®¡ï¼ˆ15013-15057è¡Œï¼‰

**æ”¹é€ **: StreamBatchPredictorå¯èƒ½è¿”å›æ±‡æ€»ç»Ÿè®¡ï¼Œéœ€è¦éªŒè¯æ ¼å¼

```javascript
// ä»batchResultsä¸­æå–æ±‡æ€»ç»Ÿè®¡
task.statistics = {
    total_periods: targetIssues.length,
    total_combinations: batchResults.data.reduce((sum, r) => sum + r.combination_count, 0),
    total_hits: batchResults.data.reduce((sum, r) => sum + r.hit_analysis.max_hit_count, 0),
    // ... å…¶ä»–ç»Ÿè®¡
};
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šä»£ç é‡æ„
1. å¤‡ä»½å½“å‰server.jsï¼ˆå·²æœ‰backupæ–‡ä»¶ï¼‰
2. ä¿®æ”¹executePredictionTaskå‡½æ•°ï¼ˆ14401-15080è¡Œï¼‰
3. æ·»åŠ å‚æ•°è½¬æ¢é€»è¾‘
4. é›†æˆStreamBatchPredictorè°ƒç”¨
5. è½¬æ¢ç»“æœæ ¼å¼

### é˜¶æ®µ2ï¼šæµ‹è¯•éªŒè¯
1. å•å…ƒæµ‹è¯•ï¼š5æœŸé¢„æµ‹ï¼ˆé¢„æœŸ<0.5ç§’ï¼‰
2. æ ‡å‡†æµ‹è¯•ï¼š20æœŸé¢„æµ‹ï¼ˆé¢„æœŸ<3ç§’ï¼‰
3. å‹åŠ›æµ‹è¯•ï¼š100æœŸé¢„æµ‹ï¼ˆé¢„æœŸ<15ç§’ï¼‰
4. åŠŸèƒ½éªŒè¯ï¼š
   - ä»»åŠ¡åˆ›å»ºæˆåŠŸ
   - è¿›åº¦è·Ÿè¸ªæ­£ç¡®
   - ç»“æœå­˜å‚¨å®Œæ•´
   - ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®
   - å‰ç«¯æ˜¾ç¤ºæ­£å¸¸

### é˜¶æ®µ3ï¼šä¸Šçº¿éƒ¨ç½²
1. æäº¤Gitï¼š`perf(task): é›†æˆStreamBatchPredictorä¼˜åŒ–ä»»åŠ¡ç³»ç»Ÿæ€§èƒ½`
2. é‡å¯Electronåº”ç”¨
3. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
4. ç”¨æˆ·éªŒæ”¶æµ‹è¯•

---

## âœ… å‘åå…¼å®¹ä¿è¯

### 1. APIæ¥å£ä¸å˜
- `/api/dlt/prediction-tasks/create` æ¥å£å‚æ•°æ ¼å¼ä¿æŒä¸å˜
- ä»»åŠ¡çŠ¶æ€ã€è¿›åº¦ã€ç»“æœæŸ¥è¯¢APIä¿æŒä¸å˜

### 2. æ•°æ®åº“Schemaä¸å˜
- PredictionTaskæ¨¡å‹ç»“æ„ä¿æŒä¸å˜
- PredictionTaskResultæ¨¡å‹ç»“æ„ä¿æŒä¸å˜
- æ‰€æœ‰å­—æ®µæ ¼å¼ä¿æŒä¸€è‡´

### 3. å‰ç«¯ä»£ç ä¸å˜
- å‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹
- è¯·æ±‚æ ¼å¼ä¸å˜
- å“åº”æ ¼å¼ä¸å˜
- UIæ˜¾ç¤ºé€»è¾‘ä¸å˜

### 4. åŠŸèƒ½å®Œæ•´æ€§ä¿æŒ
- ä»»åŠ¡åˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤åŠŸèƒ½ä¸å˜
- è¿›åº¦è·Ÿè¸ªåŠŸèƒ½ä¿æŒ
- ç»“æœå¯¼å‡ºåŠŸèƒ½ä¿æŒ
- ç»Ÿè®¡åˆ†æåŠŸèƒ½ä¿æŒ

---

## ğŸ“ˆ é¢„æœŸä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **5æœŸé¢„æµ‹** | ~5ç§’ | ~0.5ç§’ | **10x** |
| **20æœŸé¢„æµ‹** | ~20ç§’ | ~3ç§’ | **6-7x** |
| **100æœŸé¢„æµ‹** | ~100ç§’ | ~15ç§’ | **6-7x** |
| **å†…å­˜å ç”¨** | ~50MB | ~200MB | +150MBï¼ˆå¯æ¥å—ï¼‰ |
| **æ•°æ®åº“æŸ¥è¯¢** | 80-100æ¬¡ | 4-5æ¬¡ | **å‡å°‘95%** |

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### éœ€è¦ä¿®æ”¹çš„å‡½æ•°
- `executePredictionTask` (server.js:14401-15080)
  - âŒ åˆ é™¤forå¾ªç¯é€æœŸå¤„ç†ï¼ˆ14453-15039è¡Œï¼‰
  - âœ… æ·»åŠ StreamBatchPredictoré›†æˆä»£ç 

### å¤ç”¨çš„ç°æœ‰å‡½æ•°
- `resolveIssueRangeInternal` (server.js:10222) - æœŸå·èŒƒå›´è§£æ
- `StreamBatchPredictor` (server.js:10635) - æ‰¹é‡é¢„æµ‹æ ¸å¿ƒç±»
- `calculateHitAnalysisForPeriod` - å‘½ä¸­åˆ†æï¼ˆå¦‚æœéœ€è¦ï¼‰

### ä¸éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
- ä»»åŠ¡åˆ›å»ºAPI (server.js:12647)
- ä»»åŠ¡æŸ¥è¯¢API
- ä»»åŠ¡åˆ é™¤API
- å‰ç«¯ä»£ç 

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### æ€§èƒ½æŒ‡æ ‡
- âœ… 20æœŸé¢„æµ‹è€—æ—¶ < 3ç§’
- âœ… å†…å­˜å ç”¨ < 500MB
- âœ… æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° < 10æ¬¡

### åŠŸèƒ½æŒ‡æ ‡
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… è¿›åº¦è·Ÿè¸ªå‡†ç¡®
- âœ… ç»“æœæ•°æ®å®Œæ•´
- âœ… ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®

### å…¼å®¹æ€§æŒ‡æ ‡
- âœ… å‰ç«¯æ— éœ€ä¿®æ”¹
- âœ… APIæ ¼å¼ä¸å˜
- âœ… æ•°æ®åº“Schemaä¸å˜
- âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-10-22
**è®¾è®¡äººå‘˜**: Claude Code
**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œå‡†å¤‡å®æ–½
